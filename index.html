<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Незнакомка (Анонимный чат)</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <!-- Для браузеров, не поддерживающих .ico -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --text-primary: #1a1a1a;
            --text-secondary: #65676b;
            --accent: #e91e63;
            --accent-hover: #c2185b;
            --border: #e4e6eb;
            --my-message: #e91e63;
            --other-message: #e4e6eb;
            --my-text: white;
            --other-text: #1a1a1a;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --telegram-color: #0088cc;
            --radius: 20px;
            --radius-sm: 12px;
            --shadow: 0 4px 20px rgba(233, 30, 99, 0.15);
            --container-width: 900px;
        }

        .dark-theme {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2a;
            --bg-tertiary: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent: #ff4081;
            --accent-hover: #ff79b0;
            --border: #3a3a4a;
            --my-message: #ff4081;
            --other-message: #2a2a3a;
            --my-text: white;
            --other-text: #ffffff;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --telegram-color: #00aced;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        body {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.5;
            z-index: 9999;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: var(--container-width);
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-secondary);
            flex-shrink: 0;
            z-index: 100;
        }

        @media (min-width: 768px) {
            header {
                padding: 16px 20px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        @media (min-width: 768px) {
            .logo {
                font-size: 22px;
                gap: 12px;
            }
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 8px;
        }

        @media (min-width: 768px) {
            .logo-icon {
                width: 44px;
                height: 44px;
            }
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .logo-main {
            font-size: 16px;
        }

        @media (min-width: 768px) {
            .logo-main {
                font-size: 18px;
            }
        }

        .logo-sub {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: normal;
        }

        @media (min-width: 768px) {
            .logo-sub {
                font-size: 12px;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        @media (min-width: 768px) {
            .header-actions {
                gap: 12px;
            }
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .header-btn {
                font-size: 20px;
                width: 44px;
                height: 44px;
                padding: 10px;
            }
        }

        .header-btn:hover {
            background-color: var(--accent);
            color: white;
        }

        .notifications-btn {
            position: relative;
        }

        .notifications-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
        }

        .auth-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .auth-screen {
                padding: 20px;
            }
        }

        .auth-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .auth-box {
                padding: 40px 32px;
            }
        }

        .auth-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .auth-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }

        @media (min-width: 768px) {
            .auth-tabs {
                margin-bottom: 30px;
            }
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .auth-tab {
                font-size: 16px;
                padding: 12px;
            }
        }

        .auth-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            margin-bottom: -2px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 20px;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
        }

        @media (min-width: 768px) {
            .form-control {
                padding: 14px 16px;
                font-size: 16px;
            }
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
            width: 100%;
        }

        @media (min-width: 768px) {
            .btn {
                padding: 14px 24px;
                font-size: 16px;
            }
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .terms-container {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .terms-container {
                padding: 20px;
                margin: 20px 0;
                max-height: 400px;
            }
        }

        .terms-container h3 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 16px;
        }

        @media (min-width: 768px) {
            .terms-container h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .terms-container p {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .terms-container p {
                font-size: 14px;
                margin-bottom: 10px;
                line-height: 1.6;
            }
        }

        .terms-container ul, .terms-container ol {
            margin-left: 18px;
            margin-bottom: 12px;
        }

        @media (min-width: 768px) {
            .terms-container ul, .terms-container ol {
                margin-left: 20px;
                margin-bottom: 15px;
            }
        }

        .terms-container li {
            margin-bottom: 6px;
            line-height: 1.4;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .terms-container li {
                font-size: 14px;
                margin-bottom: 8px;
                line-height: 1.5;
            }
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 12px 0;
            text-align: left;
        }

        @media (min-width: 768px) {
            .terms-checkbox {
                margin: 15px 0;
                gap: 10px;
            }
        }

        .terms-checkbox input {
            margin-top: 3px;
        }

        .terms-checkbox label {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        @media (min-width: 768px) {
            .terms-checkbox label {
                font-size: 14px;
            }
        }

        .verify-email-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        @media (min-width: 768px) {
            .verify-email-screen {
                padding: 20px;
            }
        }

        .verify-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .verify-box {
                padding: 40px 32px;
            }
        }

        .verify-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .verify-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .verify-box p {
            margin-bottom: 15px;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .verify-box p {
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 20px;
            }
        }

        .verify-icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .verify-icon {
                font-size: 60px;
                margin-bottom: 20px;
            }
        }

        .application-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        @media (min-width: 768px) {
            .application-screen {
                padding: 20px;
            }
        }

        .application-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .application-box {
                padding: 40px 32px;
            }
        }

        .application-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .application-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .application-box p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .application-box p {
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 30px;
            }
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            margin-bottom: 15px;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .status-indicator {
                font-size: 14px;
                padding: 8px 16px;
                gap: 8px;
                margin-bottom: 20px;
            }
        }

        .status-indicator.verified {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--bg-primary);
            width: 100%;
        }

        .chat-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .chat-header {
                padding: 16px 20px;
            }
        }

        .chat-info h2 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        @media (min-width: 768px) {
            .chat-info h2 {
                font-size: 18px;
                margin-bottom: 4px;
            }
        }

        .chat-info p {
            color: var(--text-secondary);
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .chat-info p {
                font-size: 13px;
                gap: 8px;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (min-width: 768px) {
            .user-info {
                gap: 12px;
            }
        }

        .user-avatar {
            background: white !important;
            border: 2px solid var(--border);
            color: black !important;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .user-avatar {
            background: white !important;
            border: 2px solid var(--border);
            color: black !important;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }

        .user-details {
            display: flex;
            flex-direction: column;
            max-width: 150px;
        }

        @media (min-width: 768px) {
            .user-details {
                max-width: 200px;
            }
        }

        .username {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .username {
                font-size: 15px;
            }
        }

        .status {
            font-size: 10px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .status {
                font-size: 12px;
                gap: 4px;
            }
        }

        .messages-container-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding-bottom: 90px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .messages-container-wrapper {
                padding-bottom: 100px;
            }
        }

        .messages-container {
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        @media (min-width: 768px) {
            .messages-container {
                padding: 20px;
                gap: 16px;
            }
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: messageAppear 0.3s ease-out;
        }

        @media (min-width: 768px) {
            .message {
                max-width: 75%;
            }
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.my-message {
            align-self: flex-end;
            align-items: flex-end;
            margin-right: 5px;
        }

        @media (min-width: 768px) {
            .message.my-message {
                margin-right: 10px;
            }
        }

        .message.other-message {
            align-self: flex-start;
            align-items: flex-start;
            margin-left: 5px;
        }

        @media (min-width: 768px) {
            .message.other-message {
                margin-left: 10px;
            }
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: var(--radius);
            position: relative;
            word-wrap: break-word;
            min-width: 50px;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .message-bubble {
                padding: 14px 18px;
                min-width: 60px;
            }
        }

        .my-message .message-bubble {
            background-color: var(--my-message);
            color: var(--my-text);
            border-bottom-right-radius: 8px;
        }

        .other-message .message-bubble {
            background-color: var(--other-message);
            color: var(--other-text);
            border-bottom-left-radius: 8px;
        }

        .message-sender {
            font-size: 11px;
            margin-bottom: 4px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (min-width: 768px) {
            .message-sender {
                font-size: 12px;
                margin-bottom: 6px;
                gap: 6px;
            }
        }

        .message-time {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
            display: block;
        }

        @media (min-width: 768px) {
            .message-time {
                font-size: 11px;
                margin-top: 6px;
            }
        }

        .other-message .message-time {
            text-align: left;
        }

        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .message-text {
                font-size: 15px;
            }
        }

        .message-context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 180px;
            display: none;
        }

        .message-context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: var(--bg-tertiary);
        }

        .context-menu-item.delete {
            color: var(--danger);
        }

        .context-menu-item.report {
            color: var(--warning);
        }

        .context-menu-item.ban {
            color: var(--danger);
        }

        .handshake-btn {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.2s;
            font-weight: 500;
            margin-top: 8px;
        }

        @media (min-width: 768px) {
            .handshake-btn {
                padding: 8px 16px;
                font-size: 14px;
                margin-top: 10px;
            }
        }

        .handshake-btn:hover {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .message-input-container {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 12px 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            max-width: var(--container-width);
            width: 100%;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            .message-input-container {
                bottom: 30px;
                padding: 16px 20px;
                gap: 12px;
            }
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border);
            border-radius: 24px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            min-height: 48px;
            line-height: 1.4;
            white-space: pre-wrap;
            -webkit-appearance: none;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            .message-input {
                padding: 14px 50px 14px 18px;
                font-size: 16px;
                max-height: 120px;
                min-height: 52px;
            }
        }

        .send-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .send-btn {
                width: 52px;
                height: 52px;
                font-size: 20px;
            }
        }

        .send-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            .modal-overlay {
                padding: 20px;
            }
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            .modal {
                padding: 28px;
                max-height: 80vh;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        @media (min-width: 768px) {
            .modal-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
        }

        .modal-header h2 {
            margin: 0;
            color: var(--accent);
            font-size: 20px;
        }

        @media (min-width: 768px) {
            .modal-header h2 {
                font-size: 24px;
            }
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .modal-close {
                font-size: 28px;
                width: 40px;
                height: 40px;
            }
        }

        .modal-close:hover {
            background-color: var(--bg-tertiary);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .admin-table {
                margin: 20px 0;
                font-size: 14px;
            }
        }

        .admin-table th {
            background-color: var(--bg-tertiary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .admin-table th {
                padding: 12px;
            }
        }

        .admin-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            word-break: break-word;
        }

        @media (min-width: 768px) {
            .admin-table td {
                padding: 12px;
            }
        }

        .admin-table tr:hover {
            background-color: var(--bg-tertiary);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .action-buttons {
                gap: 8px;
            }
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .action-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .btn-sm {
                padding: 8px 16px;
                font-size: 14px;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin: 20px 0;
            }
        }

        .stat-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 20px;
            }
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            margin: 8px 0;
        }

        @media (min-width: 768px) {
            .stat-value {
                font-size: 36px;
                margin: 10px 0;
            }
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 14px;
            }
        }

        .handshake-notification {
            background-color: var(--bg-tertiary);
            border-left: 4px solid var(--accent);
            padding: 12px;
            margin: 8px 0;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .handshake-notification {
                padding: 15px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .handshake-item {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .handshake-item {
                padding: 15px;
                margin: 10px 0;
            }
        }

        .handshake-info {
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .handshake-info {
                margin-bottom: 10px;
            }
        }

        .contacts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        @media (min-width: 480px) {
            .contacts-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .contacts-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }
        }

        .contact-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 12px;
            border: 1px solid var(--border);
            position: relative;
        }

        @media (min-width: 768px) {
            .contact-card {
                padding: 15px;
            }
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .contact-header {
                gap: 10px;
                margin-bottom: 10px;
            }
        }

        .contact-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--telegram-color), #00aced);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .contact-avatar {
                width: 40px;
                height: 40px;
            }
        }

        .contact-details h4 {
            margin: 0 0 3px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .contact-details h4 {
                font-size: 14px;
                margin-bottom: 5px;
            }
        }

        .contact-telegram {
            color: var(--telegram-color);
            font-size: 11px;
        }

        @media (min-width: 768px) {
            .contact-telegram {
                font-size: 12px;
            }
        }

        .contact-time {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        @media (min-width: 768px) {
            .contact-time {
                font-size: 11px;
            }
        }

        .contact-expires {
            font-size: 11px;
            color: var(--warning);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .contact-expires {
                font-size: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
        }

        .report-reason {
            font-size: 11px;
            color: var(--danger);
            background-color: rgba(255, 59, 48, 0.1);
            padding: 3px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        @media (min-width: 768px) {
            .report-reason {
                font-size: 12px;
                padding: 4px 8px;
                margin-left: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: var(--danger);
            background-color: rgba(255, 59, 48, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .error {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .success {
            color: var(--success);
            background-color: rgba(52, 199, 89, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .success {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .info {
            color: var(--warning);
            background-color: rgba(255, 149, 0, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .info {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            min-width: 300px;
            max-width: 90%;
            display: none;
            border: 1px solid var(--border);
        }

        .custom-alert.active {
            display: block;
        }

        .custom-alert h3 {
            margin-top: 0;
            color: var(--accent);
            font-size: 18px;
            margin-bottom: 15px;
        }

        .custom-alert-content {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
        }

        .custom-alert-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
        }

        .custom-alert-overlay.active {
            display: block;
        }

        @media (hover: none) and (pointer: coarse) {
            .header-btn:active {
                background-color: var(--accent);
                color: white;
            }
            
            .handshake-btn:active {
                background-color: var(--accent);
                color: white;
                border-color: var(--accent);
                transform: scale(0.98);
            }
            
            .send-btn:active {
                background-color: var(--accent-hover);
                transform: scale(0.98);
            }
            
            .action-btn:active {
                opacity: 0.8;
            }
            
            /* Анимация для двойного нажатия */
            .message-bubble.tap-feedback {
                animation: tapFeedback 0.3s ease;
            }
            
            @keyframes tapFeedback {
                0% { transform: scale(1); }
                50% { transform: scale(0.95); }
                100% { transform: scale(1); }
            }
        }

        .messages-container::-webkit-scrollbar {
            width: 5px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        @media (max-width: 480px) {
            .modal {
                padding: 15px;
                max-height: 90vh;
            }
            
            .modal-header h2 {
                font-size: 18px;
            }
            
            .modal-close {
                width: 32px;
                height: 32px;
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-table {
                font-size: 12px;
            }
            
            .admin-table th, .admin-table td {
                padding: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .custom-alert {
                min-width: 280px;
                padding: 20px;
            }
        }

        @media (max-width: 360px) {
            .header {
                padding: 10px;
            }
            
            .logo-main {
                font-size: 14px;
            }
            
            .logo-sub {
                font-size: 9px;
            }
            
            .header-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .message-bubble {
                padding: 10px 12px;
            }
            
            .message-text {
                font-size: 13px;
            }
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                max-width: 100%;
            }
            
            .message-input-container {
                left: 0;
                right: 0;
                transform: none;
                padding: 10px;
            }
            
            .messages-container-wrapper {
                padding-bottom: 80px;
            }
        }
        
        /* Мобильное контекстное меню */
        .mobile-context-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .mobile-context-menu.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .mobile-context-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .mobile-context-header h3 {
            font-size: 16px;
            color: var(--accent);
            margin: 0;
        }
        
        .mobile-context-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-context-btn {
            padding: 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
            text-align: center;
            width: 100%;
        }
        
        .mobile-context-btn.delete {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        
        .mobile-context-btn.report {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }
        
        .mobile-context-btn.ban {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        
        .mobile-context-btn.handshake {
            background-color: rgba(233, 30, 99, 0.1);
            color: var(--accent);
            border: 1px solid rgba(233, 30, 99, 0.3);
        }
        
        .mobile-context-btn.cancel {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            margin-top: 10px;
        }
        
        .mobile-context-btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .mobile-context-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .mobile-context-overlay.active {
            display: block;
        }
    
.message-row {
    display: flex;
    align-items: flex-end;
    gap: 8px;
}
.message-row.my {
    justify-content: flex-end;
}
.message-avatar {
    width: 32px;
    height: 32px;
    background: white;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

</style>
</head>
<body class="light-theme">
    <div class="version-badge">v.0.8</div>
    
    <div class="custom-alert-overlay" id="customAlertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <h3 id="customAlertTitle">Уведомление</h3>
        <div class="custom-alert-content" id="customAlertContent"></div>
        <div class="custom-alert-buttons">
            <button class="btn btn-primary" id="customAlertConfirm">OK</button>
        </div>
    </div>
    
    <!-- Мобильное контекстное меню -->
    <div class="mobile-context-overlay" id="mobileContextOverlay"></div>
    <div class="mobile-context-menu" id="mobileContextMenu">
        <div class="mobile-context-header">
            <h3 id="mobileContextTitle">Действия с сообщением</h3>
        </div>
        <div class="mobile-context-buttons" id="mobileContextButtons">
            <!-- Кнопки добавляются динамически -->
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="logo">
                <img src="logo.png" alt="Незнакомка" class="logo-icon">
                <div class="logo-text">
                    <div class="logo-main">Незнакомка</div>
                    <div class="logo-sub">AnonChat</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn hidden" id="contactsBtn" title="Контакты">
                    <i class="fas fa-address-book"></i>
                </button>
                <button class="header-btn hidden notifications-btn" id="notificationsBtn" title="Уведомления">
                    <i class="fas fa-bell"></i>
                    <span class="notifications-badge hidden" id="notificationsBadge">0</span>
                </button>
                <button class="header-btn hidden" id="profileBtn" title="Профиль">
                    <i class="fas fa-user"></i>
                </button>
                <button class="header-btn hidden" id="adminBtn" title="Админ панель">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn theme-toggle" id="themeToggle" title="Переключить тему">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="auth-screen" id="authScreen">
                <div class="auth-box">
                    <h2>Незнакомка</h2>
                    <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 14px;">
                        Анонимный чат с возможностью знакомства
                    </p>
                    
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="loginTab">Вход</button>
                        <button class="auth-tab" id="registerTab">Регистрация</button>
                    </div>
                    
                    <div id="loginForm">
                        <div class="form-group">
                            <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="loginEmail" class="form-control" 
                                   placeholder="ваш@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword"><i class="fas fa-lock"></i> Пароль</label>
                            <input type="password" id="loginPassword" class="form-control" 
                                   placeholder="Пароль" required>
                        </div>
                        
                        <button class="btn btn-primary" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i> Войти
                        </button>
                        
                        <div id="authStatus"></div>
                    </div>
                    
                    <div id="registerForm" class="hidden">
                        <div class="form-group">
                            <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="registerEmail" class="form-control" 
                                   placeholder="ваш@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerPassword"><i class="fas fa-lock"></i> Пароль</label>
                            <input type="password" id="registerPassword" class="form-control" 
                                   placeholder="Минимум 6 символов" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword"><i class="fas fa-lock"></i> Подтвердите пароль</label>
                            <input type="password" id="confirmPassword" class="form-control" 
                                   placeholder="Повторите пароль" required>
                        </div>
                        
                        <div class="terms-container">
                            <h3>Пользовательское соглашение</h3>
                            <p><strong>Незнакомка (Анонимный чат)</strong> — платформа для анонимного общения.</p>
                            <p><strong>1. Основные положения:</strong></p>
                            <ul>
                                <li>В чате все пользователи отображаются как "Аноним #XXX"</li>
                                <li>Для использования чата требуется подтверждение через заявку</li>
                                <li>Все сообщения автоматически удаляются через 24 часа</li>
                                <li>Требуется минимальный возраст 18 лет</li>
                            </ul>
                            <p><strong>2. Запрещено:</strong></p>
                            <ul>
                                <li>Спам, флуд, реклама, рассылка ссылок</li>
                                <li>Оскорбления, угрозы, травля, буллинг</li>
                                <li>Разжигание ненависти, дискриминация по любым признакам</li>
                                <li>Незаконный контент, экстремизм, пропаганда</li>
                                <li>Мошенничество, фишинг, обман</li>
                                <li>Распространение личных данных без согласия</li>
                            </ul>
                            <p><strong>3. Система рукопожатий:</strong></p>
                            <ul>
                                <li>Вы можете предложить обменяться контактами через кнопку 🤝</li>
                                <li>Обмен контактами (рукопожатие) действует только при взаимном согласии</li>
                                <li>Контакты хранятся 24 часа, затем автоматически удаляются</li>
                                <li>Администрация не проверяет достоверность контактов</li>
                                <li>Администрация не несет ответственность за последствия обмена</li>
                            </ul>
                            <p><strong>4. Ответственность:</strong></p>
                            <ul>
                                <li>Пользователь несет полную ответственность за свои действия</li>
                                <li>Администрация вправе блокировать нарушителей без предупреждения</li>
                                <li>Все спорные ситуации решаются в пользу администрации</li>
                                <li>Администрация не хранит логи сообщений дольше 24 часов</li>
                            </ul>
                            <p><strong>5. Конфиденциальность:</strong></p>
                            <ul>
                                <li>Сообщения шифруются и временно хранятся на серверах</li>
                                <li>Telegram username используется исключительно для рукопожатий</li>
                                <li>Email используется только для входа и восстановления</li>
                                <li>IP-адреса не сохраняются и не обрабатываются</li>
                            </ul>
                        </div>
                        
                        <div class="terms-checkbox">
                            <input type="checkbox" id="agreeTerms" required>
                            <label for="agreeTerms">Я подтверждаю, что мне исполнилось 18 лет, прочитал(а) и согласен(на) с пользовательским соглашением</label>
                        </div>
                        
                        <button class="btn btn-primary" id="registerBtn">
                            <i class="fas fa-user-plus"></i> Зарегистрироваться
                        </button>
                        
                        <div id="registerStatus"></div>
                    </div>
                </div>
            </div>

            <div class="verify-email-screen hidden" id="verifyEmailScreen">
                <div class="verify-box">
                    <div class="verify-icon">
                        <i class="fas fa-envelope-circle-check"></i>
                    </div>
                    <h2>Подтвердите ваш Email</h2>
                    <p>
                        Мы отправили письмо с подтверждением на адрес<br>
                        <strong id="verifyEmailAddress">email@example.com</strong>
                    </p>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 25px;">
                        Пожалуйста, проверьте вашу почту и перейдите по ссылке в письме для подтверждения.
                    </p>
                    
                    <button class="btn btn-primary" id="resendVerifyBtn" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Отправить письмо повторно
                    </button>
                    
                    <button class="btn" id="checkVerifyBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-check-circle"></i> Я подтвердил email
                    </button>
                    
                    <button class="btn" id="logoutFromVerifyBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                    
                    <div id="verifyStatus"></div>
                </div>
            </div>

            <div class="application-screen hidden" id="applicationScreen">
                <div class="application-box">
                    <h2>Заявка на доступ к чату</h2>
                    <p>
                        Для доступа к анонимному чату необходимо заполнить заявку.<br>
                        Администратор проверит её в ручном режиме.
                    </p>
                    
                    <div id="applicationStatus" class="hidden">
                        <!-- Статус будет показан только после отправки заявки -->
                    </div>
                    
                    <div class="form-group">
                        <label for="telegramUsername">
                            <i class="fab fa-telegram" style="color: var(--telegram-color);"></i> 
                            Ваш Telegram username
                        </label>
                        <input type="text" id="telegramUsername" class="form-control" 
                               placeholder="@username (обязательно с @)" required>
                        <small style="color: var(--text-secondary); display: block; margin-top: 6px; font-size: 12px;">
                            Этот username будет использоваться для связи при обмене контактами (рукопожатие).
                        </small>
                    </div>
                    
                    <div class="handshake-notification">
                        <i class="fas fa-handshake" style="color: var(--accent); margin-right: 6px;"></i>
                        После одобрения заявки вы сможете общаться в чате. Станьте одним из первых пользователей! (Обычно заявка рассматривается от 3 минут до 12 часов).
                    </div>
                    
                    <button class="btn btn-primary" id="submitApplicationBtn">
                        <i class="fas fa-paper-plane"></i> Отправить заявку
                    </button>
                    
                    <button class="btn" id="logoutFromAppBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                    
                    <div id="applicationStatusMessage"></div>
                </div>
            </div>

            <div class="chat-screen hidden" id="chatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h2>Анонимный чат "Незнакомка"</h2>
                            <p>
                                <i class="fas fa-users"></i>
                                Сообщения удаляются через 24 часа • Макс. 100 сообщений
                            </p>
                        </div>
                        <div class="user-info">
                            <div class="user-avatar" id="userAvatar">А</div>
                            <div class="user-details">
                                <div class="username" id="displayUsername">Загрузка...</div>
                                <div class="status">
                                    <i class="fas fa-circle"></i> <span id="userStatus">Онлайн</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="messages-container-wrapper">
                        <div class="messages-container" id="messagesContainer">
                            <!-- Сообщения загружаются здесь -->
                        </div>
                    </div>

                    <div class="message-input-container">
                        <div class="message-input-wrapper">
                            <textarea class="message-input" id="messageInput" 
                                      placeholder="Напишите сообщение... (Enter для отправки, Shift+Enter для новой строки)"
                                      rows="1"></textarea>
                        </div>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Контекстное меню сообщений для десктопа -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item delete" id="contextDelete">
            <i class="fas fa-trash"></i> Удалить
        </div>
        <div class="context-menu-item report" id="contextReport">
            <i class="fas fa-flag"></i> Пожаловаться
        </div>
        <div class="context-menu-item ban" id="contextBan">
            <i class="fas fa-ban"></i> Заблокировать
        </div>
        <div class="context-menu-item" id="contextClose">
            <i class="fas fa-times"></i> Закрыть
        </div>
    </div>

    <!-- Модальное окно профиля -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Профиль</h2>
                <button class="modal-close" id="closeProfileBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" style="width: 70px; height: 70px; margin: 0 auto 12px; font-size: 28px;" id="profileAvatar">
                        А
                    </div>
                    <h3 id="profileName" style="font-size: 18px;">Пользователь</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;" id="profileEmail">
                        email@example.com
                    </p>
                    <div id="profileStatus" class="status-indicator" style="margin-top: 10px;">
                        <i class="fas fa-clock"></i> На рассмотрении
                    </div>
                    <p style="color: var(--text-secondary); font-size: 11px; margin-top: 5px;">
                        ID: <span id="profileUserId">000</span>
                    </p>
                    <p style="color: var(--telegram-color); font-size: 13px; margin-top: 8px;">
                        <i class="fab fa-telegram"></i> 
                        <span id="profileTelegram">Не указан</span>
                    </p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    
<button class="btn btn-primary" id="changeAvatarBtn" style="margin-top:10px;">
<i class="fas fa-smile"></i> Изменить аватар
</button>

<button class="btn" id="logoutBtn" style="background: var(--danger); color: white; padding: 10px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно контактов -->
    <div class="modal-overlay" id="contactsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Контакты (24 часа)</h2>
                <button class="modal-close" id="closeContactsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="contactsContainer">
                    <!-- Контакты загружаются динамически -->
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 15px;">
                    Контакты хранятся 24 часа с момента рукопожатия, после чего автоматически удаляются.
                </p>
            </div>
        </div>
    </div>

    <!-- Модальное окно уведомлений -->
    <div class="modal-overlay" id="notificationsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Уведомления</h2>
                <button class="modal-close" id="closeNotificationsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notificationsContainer">
                    <!-- Уведомления загружаются динамически -->
                </div>
            </div>
        </div>
    </div>

    <!-- Админ панель -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Админ панель</h2>
                <button class="modal-close" id="closeAdminBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="adminStats">
                    <div class="stat-card">
                        <div class="stat-label">Всего пользователей</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Онлайн сейчас</div>
                        <div class="stat-value" id="onlineUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Заявок на рассмотрении</div>
                        <div class="stat-value" id="pendingApplications">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Жалоб на рассмотрении</div>
                        <div class="stat-value" id="pendingReports">0</div>
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="btn btn-sm" id="adminTabApplications" style="background-color: var(--accent); color: white;">Заявки</button>
                    <button class="btn btn-sm" id="adminTabApproved" style="background: var(--bg-tertiary);">Одобренные</button>
                    <button class="btn btn-sm" id="adminTabBanned" style="background: var(--bg-tertiary);">Заблокированные</button>
                    <button class="btn btn-sm" id="adminTabReports" style="background: var(--bg-tertiary);">Жалобы</button>
                    <button class="btn btn-sm" id="adminTabAdmins" style="background: var(--bg-tertiary);">Администраторы</button>
                </div>

                <div id="adminApplicationsTab">
                    <h3 style="font-size: 18px;">Заявки на доступ</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTable">
                                <!-- Заявки загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="adminApprovedTab" class="hidden">
                    <h3 style="font-size: 18px;">Одобренные пользователи</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>Дата одобрения</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTable">
                                <!-- Одобренные загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="adminBannedTab" class="hidden">
                    <h3 style="font-size: 18px;">Заблокированные пользователи</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>Причина</th>
                                    <th>Дата блокировки</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="bannedTable">
                                <!-- Заблокированные загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="adminReportsTab" class="hidden">
                    <h3 style="font-size: 18px;">Жалобы на сообщения</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Жалоба от</th>
                                    <th>Сообщение</th>
                                    <th>Причина</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <!-- Жалобы загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="adminAdminsTab" class="hidden">
                    <h3 style="font-size: 18px;">Администраторы</h3>
                    <div class="form-group" style="margin-top: 12px;">
                        <label for="addAdminEmail" style="font-size: 13px;">Добавить администратора</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="email" id="addAdminEmail" class="form-control" 
                                   placeholder="email@example.com" style="flex: 1;">
                            <button class="btn btn-success btn-sm" id="addAdminBtn">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top: 12px;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Дата добавления</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTable">
                                <!-- Админы загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения рукопожатия -->
    <div class="modal-overlay" id="confirmHandshakeModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Подтверждение рукопожатия</h2>
                <button class="modal-close" id="closeConfirmHandshakeBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="handshakeConfirmInfo">
                    <!-- Информация загружается динамически -->
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" id="confirmHandshakeBtn">
                        <i class="fas fa-handshake"></i> Подтвердить рукопожатие
                    </button>
                    <button class="btn" id="cancelHandshakeBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-times"></i> Отменить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно жалобы -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Пожаловаться на сообщение</h2>
                <button class="modal-close" id="closeReportBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-size: 14px;">Выберите причину:</label>
                    <select id="reportReason" class="form-control">
                        <option value="spam">Спам или реклама</option>
                        <option value="insult">Оскорбления или угрозы</option>
                        <option value="hate">Разжигание ненависти</option>
                        <option value="illegal">Незаконный контент</option>
                        <option value="fraud">Мошенничество</option>
                        <option value="other">Другое</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDetails" style="font-size: 14px;">Дополнительная информация (необязательно):</label>
                    <textarea id="reportDetails" class="form-control" rows="3" placeholder="Опишите подробнее..."></textarea>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-danger" id="submitReportBtn">
                        <i class="fas fa-flag"></i> Отправить жалобу
                    </button>
                    <button class="btn" id="cancelReportBtn" style="background: var(--bg-tertiary);">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно блокировки -->
    <div class="modal-overlay" id="banModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Блокировка пользователя</h2>
                <button class="modal-close" id="closeBanBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="banUserInfo">
                    <!-- Информация загружается динамически -->
                </div>
                <div class="form-group">
                    <label for="banReason">Причина блокировки:</label>
                    <input type="text" id="banReason" class="form-control" 
                           placeholder="Нарушение правил..." required>
                </div>
                <div class="form-group">
                    <label for="banHours">Время блокировки (часов):</label>
                    <select id="banHours" class="form-control">
                        <option value="1">1 час</option>
                        <option value="3">3 часа</option>
                        <option value="6">6 часа</option>
                        <option value="12">12 часов</option>
                        <option value="24">24 часа</option>
                        <option value="72">3 дня</option>
                        <option value="168">7 дней</option>
                        <option value="720">30 дней</option>
                        <option value="0">Навсегда</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-danger" id="submitBanBtn">
                        <i class="fas fa-ban"></i> Заблокировать
                    </button>
                    <button class="btn" id="cancelBanBtn" style="background: var(--bg-tertiary);">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === КОНФИГУРАЦИЯ FIREBASE ===
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA-dQ8-cqE7y9VfNA3fPLF6hDO-s1OfQ4Q",
            authDomain: "neznakomka.firebaseapp.com",
            projectId: "neznakomka",
            storageBucket: "neznakomka.firebasestorage.app",
            messagingSenderId: "245961594712",
            appId: "1:245961594712:web:e1c8ba71af1289b1bc372d",
            measurementId: "G-QJ2Q13VB4T"
        };

        // === СОСТОЯНИЕ ===
        const state = {
            user: null,
            userData: null,
            isAdmin: false,
            isVerified: false,
            emailVerified: false,
            messages: [],
            theme: 'light',
            pendingHandshakeTarget: null,
            reportTargetMessage: null,
            banTargetUser: null,
            contextMenu: {
                active: false,
                messageId: null,
                messageElement: null,
                isMyMessage: false,
                x: 0,
                y: 0
            },
            touchTimer: null,
            isTouchDevice: false,
            currentAdminTab: 'applications',
            hasAcceptedTerms: false,
            messageListenerUnsubscribe: null,
            messagesLoaded: false,
            notificationListenerUnsubscribe: null,
            // Для двойного нажатия
            lastTapTime: 0,
            lastTapMessageId: null,
            mobileContextMenu: {
                active: false,
                messageId: null,
                messageElement: null,
                isMyMessage: false
            },
            // Исправление дублирования сообщений
            processedMessages: new Set(),
            isSendingMessage: false,
            MAX_MESSAGES: 100 // Максимальное количество сообщений
        };

        // === УТИЛИТЫ ===
        function showAlert(title, message, callback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertContent').textContent = message;
            document.getElementById('customAlertOverlay').classList.add('active');
            document.getElementById('customAlert').classList.add('active');
            
            const confirmBtn = document.getElementById('customAlertConfirm');
            const oldClick = confirmBtn.onclick;
            confirmBtn.onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (callback) callback();
                confirmBtn.onclick = oldClick;
            };
        }

        function showConfirm(title, message, confirmCallback, cancelCallback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertContent').textContent = message;
            document.getElementById('customAlertOverlay').classList.add('active');
            document.getElementById('customAlert').classList.add('active');
            
            const buttonsDiv = document.getElementById('customAlert').querySelector('.custom-alert-buttons');
            buttonsDiv.innerHTML = `
                <button class="btn btn-primary" id="customAlertConfirm">Да</button>
                <button class="btn" id="customAlertCancel" style="background: var(--bg-tertiary);">Нет</button>
            `;
            
            document.getElementById('customAlertConfirm').onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (confirmCallback) confirmCallback();
                buttonsDiv.innerHTML = '<button class="btn btn-primary" id="customAlertConfirm">OK</button>';
            };
            
            document.getElementById('customAlertCancel').onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (cancelCallback) cancelCallback();
                buttonsDiv.innerHTML = '<button class="btn btn-primary" id="customAlertConfirm">OK</button>';
            };
        }

        // === ИНИЦИАЛИЗАЦИЯ FIREBASE ===
        let auth, db;

        function initFirebase() {
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("✅ Firebase инициализирован");
                
                state.isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        state.user = user;
                        state.emailVerified = user.emailVerified;
                        
                        if (!user.emailVerified) {
                            showVerifyEmailScreen();
                        } else {
                            await loadUserData();
                            
                            if (state.userData) {
                                if (!state.hasAcceptedTerms) {
                                    showTermsAgreement();
                                } else {
                                    continueAfterTerms();
                                }
                            }
                        }
                    } else {
                        resetState();
                        showAuthScreen();
                    }
                });
                
            } catch (error) {
                console.error("❌ Ошибка Firebase:", error);
                showAlert('Ошибка', 'Не удалось подключиться к серверу. Проверьте интернет-соединение.');
            }
        }

        function resetState() {
            if (state.messageListenerUnsubscribe) {
                state.messageListenerUnsubscribe();
                state.messageListenerUnsubscribe = null;
            }
            
            if (state.notificationListenerUnsubscribe) {
                state.notificationListenerUnsubscribe();
                state.notificationListenerUnsubscribe = null;
            }
            
            state.user = null;
            state.userData = null;
            state.isAdmin = false;
            state.isVerified = false;
            state.emailVerified = false;
            state.messages = [];
            state.pendingHandshakeTarget = null;
            state.reportTargetMessage = null;
            state.banTargetUser = null;
            state.hasAcceptedTerms = false;
            state.messagesLoaded = false;
            state.lastTapTime = 0;
            state.lastTapMessageId = null;
            state.processedMessages.clear();
            state.isSendingMessage = false;
        }

        async function continueAfterTerms() {
            if (!state.userData) return;
            
            await checkAndUnbanIfExpired();
            
            if (state.userData.isBanned && state.userData.banExpiresAt && new Date(state.userData.banExpiresAt) > new Date()) {
                const expiresAt = new Date(state.userData.banExpiresAt);
                const now = new Date();
                const hoursLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60));
                
                showAlert('Аккаунт заблокирован', `Ваш аккаунт заблокирован до ${expiresAt.toLocaleString()}. Причина: ${state.userData.banReason || 'Нарушение правил'}. Осталось: ${hoursLeft} часов.`);
                await handleLogout();
                return;
            } else if (state.userData.isBanned && !state.userData.banExpiresAt) {
                showAlert('Аккаунт заблокирован', `Ваш аккаунт заблокирован навсегда. Причина: ${state.userData.banReason || 'Нарушение правил'}.`);
                await handleLogout();
                return;
            }
            
            if (state.userData.isVerified) {
                state.isVerified = true;
                showChatScreen();
                loadMessages();
                loadNotifications();
                loadContacts();
            } else {
                showApplicationScreen();
                checkApplicationStatus();
            }
        }

        async function checkAndUnbanIfExpired() {
            if (!state.userData || !state.userData.isBanned) return;
            
            const now = new Date();
            const expiresAt = state.userData.banExpiresAt ? new Date(state.userData.banExpiresAt) : null;
            
            if (expiresAt && expiresAt <= now) {
                try {
                    await db.collection('users').doc(state.user.uid).update({
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        banExpiresAt: null
                    });
                    
                    state.userData.isBanned = false;
                    state.userData.banReason = null;
                    state.userData.bannedAt = null;
                    state.userData.bannedBy = null;
                    state.userData.banExpiresAt = null;
                    
                    console.log("✅ Пользователь автоматически разблокирован");
                } catch (error) {
                    console.error("❌ Ошибка автоматической разблокировки:", error);
                }
            }
        }

        async function loadUserData() {
            if (!state.user || !db) return;
            
            try {
                const userRef = db.collection('users').doc(state.user.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    state.userData = doc.data();
                    
                    state.hasAcceptedTerms = state.userData.hasAcceptedTerms || false;
                    
                    if (state.userData.isAdmin) {
                        state.isAdmin = true;
                        if (document.getElementById('adminBtn')) {
                            document.getElementById('adminBtn').classList.remove('hidden');
                        }
                    }
                    
                    updateProfileUI();
                    
                } else {
                    state.userData = {
                        email: state.user.email,
                        isAdmin: state.user.email === 'sad.spotty@gmail.com',
                        isVerified: false,
                        emailVerified: true,
                        telegramUsername: null,
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        online: true,
                        anonymousId: generateAnonymousId(),
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        hasAcceptedTerms: false
                    };
                    
                    await userRef.set(state.userData);
                }
                
                // Обновляем только lastSeen, online только для админов
                await userRef.update({
                    lastSeen: new Date().toISOString()
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки данных:", error);
                showAlert('Ошибка', 'Не удалось загрузить данные пользователя');
            }
        }

        function showTermsAgreement() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
            
            const html = `
                <div class="auth-screen">
                    <div class="auth-box">
                        <div class="verify-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h2>Пользовательское соглашение</h2>
                        
                        <div class="terms-container" style="max-height: 50vh;">
                            <h3>Незнакомка (AnonChat) — Правила использования</h3>
                            <p><strong>1. Основные положения:</strong></p>
                            <ul>
                                <li>В чате все пользователи отображаются как "Аноним #XXX"</li>
                                <li>Для использования чата требуется подтверждение через заявку</li>
                                <li>Все сообщения автоматически удаляются через 24 часа</li>
                                <li>Требуется минимальный возраст 18 лет</li>
                            </ul>
                            <p><strong>2. Запрещено:</strong></p>
                            <ul>
                                <li>Спам, флуд, реклама, рассылка ссылок</li>
                                <li>Оскорбления, угрозы, травля, буллинг</li>
                                <li>Разжигание ненависти, дискриминация по любым признакам</li>
                                <li>Незаконный контент, экстремизм, пропаганда</li>
                                <li>Мошенничество, фишинг, обман</li>
                                <li>Распространение личных данных без согласия</li>
                            </ul>
                            <p><strong>3. Система рукопожатий:</strong></p>
                            <ul>
                                <li>Вы можете предложить обменяться контактами через кнопку 🤝</li>
                                <li> Обмен контактами (Рукопожатие) действует только при взаимном согласии</li>
                                <li>Контакты хранятся 24 часа, затем автоматически удаляются</li>
                                <li>Администрация не проверяет достоверность контактов</li>
                                <li>Администрация не несет ответственности за последствия обмена</li>
                            </ul>
                            <p><strong>4. Ответственность:</strong></p>
                            <ul>
                                <li>Пользователь несет полную ответственность за свои действия</li>
                                <li>Администрация вправе блокировать нарушителей без предупреждения</li>
                                <li>Все спорные ситуации решаются в пользу администрации</li>
                                <li>Администрация не хранит логи сообщений дольше 24 часов</li>
                            </ul>
                            <p><strong>5. Конфиденциальность:</strong></p>
                            <ul>
                                <li>Сообщения шифруются и временно хранятся на серверах</li>
                                <li>Telegram username используется исключительно для рукопожатий</li>
                                <li>Email используется только для входа и восстановления</li>
                                <li>IP-адреса не сохраняются и не обрабатываются</li>
                            </ul>
                        </div>
                        
                        <div class="terms-checkbox">
                            <input type="checkbox" id="agreeTermsModal" required>
                            <label for="agreeTermsModal">Мне исполнилось 18 лет, я прочитал(а) и полностью согласен(на) с пользовательским соглашением</label>
                        </div>
                        
                        <button class="btn btn-primary" id="acceptTermsBtn">
                            <i class="fas fa-check-circle"></i> Принять соглашение и продолжить
                        </button>
                        
                        <button class="btn" id="rejectTermsBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                            <i class="fas fa-times"></i> Отказаться и выйти
                        </button>
                    </div>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.innerHTML = html;
                
                document.getElementById('acceptTermsBtn').addEventListener('click', acceptTerms);
                document.getElementById('rejectTermsBtn').addEventListener('click', rejectTerms);
            }
        }

        async function acceptTerms() {
            const checkbox = document.getElementById('agreeTermsModal');
            if (!checkbox.checked) {
                showAlert('Внимание', 'Для продолжения необходимо подтвердить согласие с правилами');
                return;
            }
            
            const acceptBtn = document.getElementById('acceptTermsBtn');
            acceptBtn.disabled = true;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Продолжение...';
            
            try {
                if (state.user && state.user.uid && db) {
                    await db.collection('users').doc(state.user.uid).update({
                        hasAcceptedTerms: true,
                        termsAcceptedAt: new Date().toISOString()
                    });
                    
                    state.hasAcceptedTerms = true;
                    state.userData.hasAcceptedTerms = true;
                }
                
                await continueAfterTerms();
                
            } catch (error) {
                console.error("❌ Ошибка сохранения согласия:", error);
                showAlert('Ошибка', 'Ошибка сохранения. Попробуйте еще раз.');
            } finally {
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = '<i class="fas fa-check-circle"></i> Принять соглашение и продолжить';
            }
        }

        async function rejectTerms() {
            showConfirm('Подтверждение', 'Вы уверены, что хотите отказаться от пользовательского соглашения? Это приведет к выходу из аккаунта.',
                async () => {
                    await handleLogout();
                }
            );
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const agreeTerms = document.getElementById('agreeTerms');
            
            if (!email || !password || !confirmPassword) {
                showRegisterError('Заполните все поля');
                return;
            }
            
            if (password !== confirmPassword) {
                showRegisterError('Пароли не совпадают');
                return;
            }
            
            if (password.length < 6) {
                showRegisterError('Пароль должен быть минимум 6 символов');
                return;
            }
            
            if (!agreeTerms || !agreeTerms.checked) {
                showRegisterError('Необходимо принять пользовательское соглашение');
                return;
            }
            
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.sendEmailVerification();
                
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    isAdmin: user.email === 'sad.spotty@gmail.com',
                    isVerified: false,
                    emailVerified: false,
                    telegramUsername: null,
                    createdAt: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    online: true,
                    anonymousId: generateAnonymousId(),
                    isBanned: false,
                    hasAcceptedTerms: true,
                    termsAcceptedAt: new Date().toISOString()
                });
                
                showRegisterSuccess('Регистрация успешна! Проверьте email для подтверждения.');
                
                document.getElementById('verifyEmailAddress').textContent = email;
                
            } catch (error) {
                console.error("❌ Ошибка регистрации:", error);
                
                let errorMessage = 'Ошибка регистрации. ';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email уже используется';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Неверный формат email';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Пароль слишком слабый';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showRegisterError(errorMessage);
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Зарегистрироваться';
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showAuthError('Заполните все поля');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log("✅ Успешный вход:", email);
                
            } catch (error) {
                console.error("❌ Ошибка входа:", error);
                
                let errorMessage = 'Ошибка входа. ';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Пользователь не найден';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Неверный пароль';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Неверный формат email';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Аккаунт заблокирован';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAuthError(errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Войти';
            }
        }

        function showAuthScreen() {
            const screens = ['authScreen', 'verifyEmailScreen', 'applicationScreen', 'chatScreen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) element.classList.add('hidden');
            });
            
            document.getElementById('authScreen').classList.remove('hidden');
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
        }

        function showChatScreen() {
            const screens = ['authScreen', 'verifyEmailScreen', 'applicationScreen', 'chatScreen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) element.classList.add('hidden');
            });
            
            document.getElementById('chatScreen').classList.remove('hidden');
            
            updateProfileUI();
            loadMessages();
            initChatEventListeners();
            
            if (document.getElementById('contactsBtn')) {
                document.getElementById('contactsBtn').classList.remove('hidden');
            }
            if (document.getElementById('notificationsBtn')) {
                document.getElementById('notificationsBtn').classList.remove('hidden');
            }
            if (document.getElementById('profileBtn')) {
                document.getElementById('profileBtn').classList.remove('hidden');
            }
            
            if (state.isAdmin && document.getElementById('adminBtn')) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
        }

        function updateProfileUI() {
            if (!state.userData) return;
            
            const profileName = document.getElementById('profileName');
            if (profileName) {
                profileName.textContent = state.userData.email.split('@')[0];
            }
            
            const profileEmail = document.getElementById('profileEmail');
            if (profileEmail) {
                profileEmail.textContent = state.userData.email;
            }
            
            const profileUserId = document.getElementById('profileUserId');
            if (profileUserId) {
                profileUserId.textContent = state.user.uid.substring(0, 8);
            }
            
            const profileTelegram = document.getElementById('profileTelegram');
            if (profileTelegram) {
                profileTelegram.textContent = state.userData.telegramUsername || 'Не указан';
            }
            
            const statusIndicator = document.getElementById('profileStatus');
            if (statusIndicator) {
                if (state.userData.isVerified) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Подтвержден';
                    statusIndicator.classList.add('verified');
                } else if (state.userData.application) {
                    statusIndicator.innerHTML = '<i class="fas fa-clock"></i> На рассмотрении';
                    statusIndicator.classList.remove('verified');
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-clock"></i> Не подтвержден';
                    statusIndicator.classList.remove('verified');
                }
            }
            
            const avatar = document.getElementById('profileAvatar');
            if (avatar) {
                const initial = state.userData.email[0].toUpperCase();
                avatar.textContent = initial;
            }
            
            const displayUsername = document.getElementById('displayUsername');
            if (displayUsername) {
                displayUsername.textContent = state.userData.email.split('@')[0];
            }
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                const initial = state.userData.email[0].toUpperCase();
                userAvatar.textContent = initial;
            }
        }

        function initChatEventListeners() {
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, state.isTouchDevice ? 100 : 120) + 'px';
                    this.style.overflowY = this.scrollHeight > (state.isTouchDevice ? 100 : 120) ? 'auto' : 'hidden';
                });
            }
        }

        async function resendVerificationEmail() {
            if (!state.user) return;
            
            const resendBtn = document.getElementById('resendVerifyBtn');
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
            
            try {
                await state.user.sendEmailVerification();
                showVerifySuccess('Письмо с подтверждением отправлено! Проверьте вашу почту.');
            } catch (error) {
                console.error("❌ Ошибка отправки подтверждения:", error);
                showVerifyError('Ошибка отправки письма. Попробуйте позже.');
            } finally {
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo"></i> Отправить письмо повторно';
            }
        }

        async function checkEmailVerification() {
            if (!state.user) return;
            
            const checkBtn = document.getElementById('checkVerifyBtn');
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Проверка...';
            
            try {
                await state.user.reload();
                
                if (state.user.emailVerified) {
                    state.emailVerified = true;
                    showVerifySuccess('Email подтвержден! Загрузка профиля...');
                    
                    setTimeout(async () => {
                        await loadUserData();
                    }, 1500);
                } else {
                    showVerifyError('Email еще не подтвержден. Проверьте вашу почту.');
                }
            } catch (error) {
                console.error("❌ Ошибка проверки email:", error);
                showVerifyError('Ошибка проверки. Попробуйте позже.');
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerHTML = '<i class="fas fa-check-circle"></i> Я подтвердил email';
            }
        }

        // Убрали проверку уникальности Telegram username
        
        async function submitApplication() {
            const telegramUsername = document.getElementById('telegramUsername').value.trim();
            
            if (!telegramUsername || !telegramUsername.startsWith('@')) {
                showApplicationError('Введите Telegram username в формате @username');
                return;
            }
            
            const submitBtn = document.getElementById('submitApplicationBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
            
            try {
                // Сохраняем заявку в коллекции applications
                const applicationData = {
                    telegramUsername: telegramUsername,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                    userId: state.user.uid,
                    userEmail: state.user.email
                };
                
                await db.collection('applications').add(applicationData);
                
                // Обновляем данные пользователя
                await db.collection('users').doc(state.user.uid).update({
                    application: applicationData,
                    telegramUsername: telegramUsername,
                    isVerified: false
                });
                
                // Обновляем state
                state.userData.application = applicationData;
                state.userData.telegramUsername = telegramUsername;
                
                // Показываем статус заявки
                const statusElement = document.getElementById('applicationStatus');
                statusElement.innerHTML = `<div class="status-indicator"><i class="fas fa-clock"></i> Заявка отправлена на рассмотрение</div>`;
                statusElement.classList.remove('hidden');
                
                showApplicationSuccess('Заявка отправлена на рассмотрение! Администратор проверит её в ближайшее время.');
                updateApplicationStatusUI();
                updateProfileUI();
                
            } catch (error) {
                console.error("❌ Ошибка отправки заявки:", error);
                showApplicationError('Ошибка отправки заявки: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить заявку';
            }
        }

        function updateApplicationStatusUI() {
            if (!state.userData || !state.userData.application) return;
            
            const statusElement = document.getElementById('applicationStatus');
            if (statusElement) {
                if (state.userData.isVerified) {
                    statusElement.innerHTML = '<div class="status-indicator verified"><i class="fas fa-check-circle"></i> Заявка одобрена</div>';
                    statusElement.classList.remove('hidden');
                } else if (state.userData.application) {
                    statusElement.innerHTML = '<div class="status-indicator"><i class="fas fa-clock"></i> Заявка на рассмотрении</div>';
                    statusElement.classList.remove('hidden');
                } else {
                    statusElement.innerHTML = '';
                    statusElement.classList.add('hidden');
                }
            }
        }

        async function checkApplicationStatus() {
            if (!state.user || !db || !state.userData) return;
            
            try {
                const userRef = db.collection('users').doc(state.user.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    const userData = doc.data();
                    state.userData = userData;
                    
                    if (userData.isVerified) {
                        state.isVerified = true;
                        showChatScreen();
                        loadMessages();
                        loadNotifications();
                        loadContacts();
                        updateApplicationStatusUI();
                    } else if (userData.application) {
                        showApplicationScreen();
                        updateApplicationStatusUI();
                    } else {
                        showApplicationScreen();
                        const statusElement = document.getElementById('applicationStatus');
                        if (statusElement) {
                            statusElement.innerHTML = '';
                            statusElement.classList.add('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error("❌ Ошибка проверки статуса:", error);
            }
        }

        function showVerifyEmailScreen() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.getElementById('verifyEmailScreen').classList.remove('hidden');
            
            if (state.user) {
                document.getElementById('verifyEmailAddress').textContent = state.user.email;
            }
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
        }

        function showApplicationScreen() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.getElementById('applicationScreen').classList.remove('hidden');
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
            
            const statusElement = document.getElementById('applicationStatus');
            if (statusElement) {
                statusElement.innerHTML = '';
                statusElement.classList.add('hidden');
            }
            
            if (state.userData && state.userData.telegramUsername) {
                document.getElementById('telegramUsername').value = state.userData.telegramUsername;
            }
            
            if (state.userData && state.userData.application) {
                updateApplicationStatusUI();
            }
        }

        async function handleLogout() {
            try {
                if (state.user && db) {
                    const userRef = db.collection('users').doc(state.user.uid);
                    await userRef.update({
                        lastSeen: new Date().toISOString()
                    });
                }
                
                if (state.messageListenerUnsubscribe) {
                    state.messageListenerUnsubscribe();
                    state.messageListenerUnsubscribe = null;
                }
                
                if (state.notificationListenerUnsubscribe) {
                    state.notificationListenerUnsubscribe();
                    state.notificationListenerUnsubscribe = null;
                }
                
                await auth.signOut();
                
                resetState();
                showAuthScreen();
                
                const modals = document.querySelectorAll('.modal-overlay.active');
                modals.forEach(modal => modal.classList.remove('active'));
                
                hideMobileContextMenu();
                
            } catch (error) {
                console.error("❌ Ошибка выхода:", error);
                showAlert('Ошибка', 'Ошибка при выходе. Попробуйте снова.');
            }
        }

        function loadMessages() {
            if (!db || !state.isVerified) return;
            
            document.getElementById('messagesContainer').innerHTML = '';
            state.processedMessages.clear();
            
            if (state.messageListenerUnsubscribe) {
                state.messageListenerUnsubscribe();
            }
            
            const messagesRef = db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(state.MAX_MESSAGES);
            
            const unsubscribe = messagesRef.onSnapshot((snapshot) => {
                const container = document.getElementById('messagesContainer');
                const wasAtBottom = isAtBottom();
                
                snapshot.docChanges().forEach((change) => {
                    const message = change.doc.data();
                    message.id = change.doc.id;
                    
                    if (state.processedMessages.has(message.id)) {
                        return;
                    }
                    
                    if (change.type === 'added') {
                        if (!message.deleted) {
                            state.processedMessages.add(message.id);
                            addMessageToUI(message);
                        }
                    } else if (change.type === 'modified') {
                        if (message.deleted) {
                            const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                            if (messageElement) {
                                messageElement.remove();
                            }
                        } else {
                            const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                            if (messageElement) {
                                messageElement.remove();
                            }
                            addMessageToUI(message);
                        }
                    } else if (change.type === 'removed') {
                        const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                        if (messageElement) {
                            messageElement.remove();
                        }
                        state.processedMessages.delete(message.id);
                    }
                });
                
                if (wasAtBottom) {
                    scrollToBottom();
                }
                
                checkAndDeleteOldMessages();
                
            }, (error) => {
                console.error("❌ Ошибка подписки на сообщения:", error);
                showAlert('Ошибка', 'Ошибка загрузки сообщений. Пожалуйста, обновите страницу.');
            });
            
            state.messageListenerUnsubscribe = unsubscribe;
        }

        function isAtBottom() {
            const container = document.getElementById('messagesContainer');
            if (!container) return true;
            return container.scrollHeight - container.scrollTop - container.clientHeight < 100;
        }

        async function checkAndDeleteOldMessages() {
            try {
                const snapshot = await db.collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                if (snapshot.size > state.MAX_MESSAGES) {
                    const messagesToDelete = [];
                    snapshot.forEach((doc, index) => {
                        if (index < snapshot.size - state.MAX_MESSAGES) {
                            messagesToDelete.push(doc.ref.delete());
                        }
                    });
                    
                    await Promise.all(messagesToDelete);
                    console.log(`🗑️ Удалено ${messagesToDelete.length} старых сообщений`);
                }
            } catch (error) {
                console.error("❌ Ошибка проверки сообщений:", error);
            }
        }

        function addMessageToUI(message) {
            if (message.deleted) return;
            
            const messageElement = document.createElement('div');
            const isMyMessage = message.userId === state.user.uid;
            
            messageElement.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            messageElement.setAttribute('data-message-id', message.id);
            
            const timestamp = message.timestamp?.toDate 
                ? message.timestamp.toDate() 
                : new Date();
            
            const now = new Date();
            const messageDate = new Date(timestamp);
            const isToday = messageDate.toDateString() === now.toDateString();
            const isYesterday = new Date(now.getTime() - 86400000).toDateString() === messageDate.toDateString();
            
            let dateText = '';
            if (isToday) {
                dateText = 'Сегодня';
            } else if (isYesterday) {
                dateText = 'Вчера';
            } else {
                dateText = messageDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            
            const timeText = messageDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const fullTimeText = `${dateText} в ${timeText}`;
            
            const displayName = isMyMessage ? 'Вы' : `Аноним #${message.anonymousId || '000'}`;
            
            const showHandshakeButton = !isMyMessage && 
                state.userData && 
                state.userData.telegramUsername && 
                state.userData.isVerified &&
                state.userData.telegramUsername !== '' &&
                state.userData.telegramUsername !== null;
            
            const handshakeButton = showHandshakeButton ? `
                <button class="handshake-btn" onclick="offerHandshakeConfirm('${message.anonymousId || '000'}', '${message.userId}', '${message.userEmail}')">
                    <i class="fas fa-handshake"></i> Предложить рукопожатие
                </button>
            ` : '';
            
            messageElement.innerHTML = `
                <div class="message-sender">
                    <i class="fas ${isMyMessage ? 'fa-user' : 'fa-user-secret'}"></i> 
                    ${displayName}
                    <span style="font-size: 9px; color: var(--text-secondary); margin-left: 5px;" title="${fullTimeText}">
                        ${timeText}
                    </span>
                </div>
                <div class="message-bubble">
                    <div class="message-text">${formatMessageText(message.text)}</div>
                    <div class="message-time">${fullTimeText}</div>
                </div>
                ${handshakeButton}
            `;
            
            setupMessageContextMenu(messageElement, message, isMyMessage);
            
            const container = document.getElementById('messagesContainer');
            container.appendChild(messageElement);
        }

        function setupMessageContextMenu(messageElement, message, isMyMessage) {
            const messageBubble = messageElement.querySelector('.message-bubble');
            
            messageBubble.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, message, isMyMessage, messageElement);
            });
            
            if (state.isTouchDevice) {
                let lastTap = 0;
                let tapCount = 0;
                let tapTimeout;
                
                messageBubble.addEventListener('touchstart', (e) => {
                    if (state.touchTimer) {
                        clearTimeout(state.touchTimer);
                        state.touchTimer = null;
                    }
                    
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    
                    if (tapCount > 0 && tapLength < 300 && tapLength > 0) {
                        e.preventDefault();
                        tapCount++;
                        
                        messageBubble.classList.add('tap-feedback');
                        setTimeout(() => {
                            messageBubble.classList.remove('tap-feedback');
                        }, 300);
                        
                        showMobileContextMenu(message, isMyMessage, messageElement);
                        
                        tapCount = 0;
                        if (tapTimeout) clearTimeout(tapTimeout);
                    } else {
                        tapCount = 1;
                        if (tapTimeout) clearTimeout(tapTimeout);
                        tapTimeout = setTimeout(() => {
                            tapCount = 0;
                        }, 300);
                    }
                    
                    lastTap = currentTime;
                }, { passive: true });
                
                messageBubble.addEventListener('touchstart', (e) => {
                    if (state.touchTimer) clearTimeout(state.touchTimer);
                    
                    state.touchTimer = setTimeout(() => {
                        e.preventDefault();
                        const touch = e.touches[0] || e.changedTouches[0];
                        showMessageContextMenu(touch, message, isMyMessage, messageElement);
                    }, 1000);
                }, { passive: true });
                
                messageBubble.addEventListener('touchend', () => {
                    if (state.touchTimer) {
                        clearTimeout(state.touchTimer);
                        state.touchTimer = null;
                    }
                });
                
                messageBubble.addEventListener('touchmove', () => {
                    if (state.touchTimer) {
                        clearTimeout(state.touchTimer);
                        state.touchTimer = null;
                    }
                });
            }
        }

        function showMobileContextMenu(message, isMyMessage, messageElement) {
            if (state.mobileContextMenu.active) {
                hideMobileContextMenu();
                return;
            }
            
            state.mobileContextMenu = {
                active: true,
                messageId: message.id,
                messageElement: messageElement,
                isMyMessage: isMyMessage
            };
            
            const buttonsContainer = document.getElementById('mobileContextButtons');
            buttonsContainer.innerHTML = '';
            
            if (isMyMessage) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'mobile-context-btn delete';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Удалить сообщение';
                deleteBtn.onclick = () => {
                    hideMobileContextMenu();
                    deleteMessageConfirm(message.id);
                };
                buttonsContainer.appendChild(deleteBtn);
                
            } else {
                if (state.isAdmin) {
                    const banBtn = document.createElement('button');
                    banBtn.className = 'mobile-context-btn ban';
                    banBtn.innerHTML = '<i class="fas fa-ban"></i> Заблокировать пользователя';
                    banBtn.onclick = () => {
                        hideMobileContextMenu();
                        banUserFromMessage(message);
                    };
                    buttonsContainer.appendChild(banBtn);
                }
                
                const reportBtn = document.createElement('button');
                reportBtn.className = 'mobile-context-btn report';
                reportBtn.innerHTML = '<i class="fas fa-flag"></i> Пожаловаться на сообщение';
                reportBtn.onclick = () => {
                    hideMobileContextMenu();
                    state.reportTargetMessage = message.id;
                    document.getElementById('reportModal').classList.add('active');
                };
                buttonsContainer.appendChild(reportBtn);
                
                if (state.userData && state.userData.telegramUsername && state.userData.isVerified) {
                    const handshakeBtn = document.createElement('button');
                    handshakeBtn.className = 'mobile-context-btn handshake';
                    handshakeBtn.innerHTML = '<i class="fas fa-handshake"></i> Предложить рукопожатие';
                    handshakeBtn.onclick = () => {
                        hideMobileContextMenu();
                        offerHandshakeConfirm(message.anonymousId || '000', message.userId, message.userEmail);
                    };
                    buttonsContainer.appendChild(handshakeBtn);
                }
            }
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'mobile-context-btn cancel';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Отмена';
            cancelBtn.onclick = hideMobileContextMenu;
            buttonsContainer.appendChild(cancelBtn);
            
            document.getElementById('mobileContextOverlay').classList.add('active');
            document.getElementById('mobileContextMenu').classList.add('active');
            
            const title = document.getElementById('mobileContextTitle');
            if (isMyMessage) {
                title.textContent = 'Ваше сообщение';
            } else {
                title.textContent = `Сообщение от Аноним #${message.anonymousId || '000'}`;
            }
        }

        function hideMobileContextMenu() {
            state.mobileContextMenu.active = false;
            document.getElementById('mobileContextOverlay').classList.remove('active');
            document.getElementById('mobileContextMenu').classList.remove('active');
        }

        function deleteMessageConfirm(messageId) {
            showConfirm('Подтверждение', 'Удалить это сообщение?', async () => {
                try {
                    await db.collection('messages').doc(messageId).update({
                        deleted: true,
                        deletedAt: new Date().toISOString(),
                        deletedBy: state.user.email
                    });
                    
                    showAlert('Успех', 'Сообщение удалено');
                } catch (error) {
                    console.error("❌ Ошибка удаления сообщения:", error);
                    showAlert('Ошибка', 'Ошибка удаления сообщения');
                }
            });
        }

        function showMessageContextMenu(e, message, isMyMessage, messageElement) {
            if (state.contextMenu.active) {
                hideMessageContextMenu();
                return;
            }
            
            if (state.isTouchDevice) {
                showMobileContextMenu(message, isMyMessage, messageElement);
                return;
            }
            
            state.contextMenu = {
                active: true,
                messageId: message.id,
                messageElement: messageElement,
                isMyMessage: isMyMessage,
                x: e.clientX || e.pageX,
                y: e.clientY || e.pageY
            };
            
            const contextMenu = document.getElementById('messageContextMenu');
            contextMenu.classList.add('active');
            
            const menuWidth = 180;
            const menuHeight = 150;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let x = state.contextMenu.x;
            let y = state.contextMenu.y;
            
            if (x + menuWidth > windowWidth) {
                x = windowWidth - menuWidth - 10;
            }
            
            if (y + menuHeight > windowHeight) {
                y = windowHeight - menuHeight - 10;
            }
            
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            
            const deleteItem = document.getElementById('contextDelete');
            const reportItem = document.getElementById('contextReport');
            const banItem = document.getElementById('contextBan');
            
            if (isMyMessage) {
                deleteItem.style.display = 'flex';
                reportItem.style.display = 'none';
                banItem.style.display = state.isAdmin ? 'flex' : 'none';
            } else {
                deleteItem.style.display = state.isAdmin ? 'flex' : 'none';
                reportItem.style.display = 'flex';
                banItem.style.display = state.isAdmin ? 'flex' : 'none';
            }
        }

        function hideMessageContextMenu() {
            state.contextMenu.active = false;
            document.getElementById('messageContextMenu').classList.remove('active');
        }

        async function deleteMessage() {
            if (!state.contextMenu.messageId) {
                hideMessageContextMenu();
                return;
            }
            
            showConfirm('Подтверждение', 'Удалить это сообщение?', async () => {
                try {
                    await db.collection('messages').doc(state.contextMenu.messageId).update({
                        deleted: true,
                        deletedAt: new Date().toISOString(),
                        deletedBy: state.user.email
                    });
                    
                    hideMessageContextMenu();
                    showAlert('Успех', 'Сообщение удалено');
                } catch (error) {
                    console.error("❌ Ошибка удаления сообщения:", error);
                    hideMessageContextMenu();
                    showAlert('Ошибка', 'Ошибка удаления сообщения');
                }
            }, hideMessageContextMenu);
        }

        async function adminDeleteMessage() {
            if (!state.contextMenu.messageId) {
                hideMessageContextMenu();
                return;
            }
            
            showConfirm('Подтверждение', 'Удалить это сообщение как администратор?', async () => {
                try {
                    await db.collection('messages').doc(state.contextMenu.messageId).delete();
                    hideMessageContextMenu();
                    showAlert('Успех', 'Сообщение удалено');
                } catch (error) {
                    console.error("❌ Ошибка удаления сообщения:", error);
                    hideMessageContextMenu();
                    showAlert('Ошибка', 'Ошибка удаления сообщения');
                }
            }, hideMessageContextMenu);
        }

        function reportMessage() {
            if (!state.contextMenu.messageId) {
                hideMessageContextMenu();
                return;
            }
            
            state.reportTargetMessage = state.contextMenu.messageId;
            hideMessageContextMenu();
            document.getElementById('reportModal').classList.add('active');
        }

        function banUserFromMessage(message) {
            db.collection('users').doc(message.userId).get().then(userDoc => {
                if (userDoc.exists) {
                    const user = userDoc.data();
                    state.banTargetUser = {
                        userId: message.userId,
                        email: message.userEmail,
                        anonymousId: message.anonymousId || '000',
                        telegramUsername: user.telegramUsername
                    };
                    
                    showBanModal();
                }
            }).catch(error => {
                console.error("❌ Ошибка получения данных пользователя:", error);
                showAlert('Ошибка', 'Не удалось получить данные пользователя');
            });
        }

        function banUserFromContext() {
            if (!state.contextMenu.messageId) {
                hideMessageContextMenu();
                return;
            }
            
            db.collection('messages').doc(state.contextMenu.messageId).get().then(doc => {
                if (doc.exists) {
                    const message = doc.data();
                    banUserFromMessage(message);
                }
            }).catch(error => {
                console.error("❌ Ошибка получения данных сообщения:", error);
                showAlert('Ошибка', 'Не удалось получить данные сообщения');
            });
            
            hideMessageContextMenu();
        }

        function showBanModal() {
            if (!state.banTargetUser) return;
            
            document.getElementById('banUserInfo').innerHTML = `
                <div class="handshake-notification">
                    <h4>Блокировка пользователя</h4>
                    <p>Вы собираетесь заблокировать <strong>Аноним #${state.banTargetUser.anonymousId}</strong></p>
                    <p>Email: <strong>${state.banTargetUser.email}</strong></p>
                    <p>Telegram: <strong>${state.banTargetUser.telegramUsername || 'Не указан'}</strong></p>
                    <p>После блокировки пользователь не сможет писать в чат.</p>
                </div>
            `;
            
            document.getElementById('banModal').classList.add('active');
            document.getElementById('banReason').value = '';
            document.getElementById('banHours').value = '24';
        }

        async function submitBan() {
            if (!state.banTargetUser) return;
            
            const reason = document.getElementById('banReason').value.trim();
            const hours = parseInt(document.getElementById('banHours').value);
            
            if (!reason) {
                showAlert('Внимание', 'Укажите причину блокировки');
                return;
            }
            
            try {
                const banData = {
                    isBanned: true,
                    banReason: reason,
                    bannedAt: new Date().toISOString(),
                    bannedBy: state.user.email,
                    isVerified: false
                };
                
                if (hours > 0) {
                    const expiresAt = new Date();
                    expiresAt.setHours(expiresAt.getHours() + hours);
                    banData.banExpiresAt = expiresAt.toISOString();
                }
                
                await db.collection('users').doc(state.banTargetUser.userId).update(banData);
                
                document.getElementById('banModal').classList.remove('active');
                state.banTargetUser = null;
                
                showAlert('Успех', 'Пользователь заблокирован');
                
                if (state.currentAdminTab === 'banned') {
                    await loadBannedUsers();
                }
                await loadAdminStats();
                
            } catch (error) {
                console.error("❌ Ошибка блокировки пользователя:", error);
                showAlert('Ошибка', 'Ошибка блокировки пользователя');
            }
        }

        async function submitReport() {
            if (!state.reportTargetMessage) return;
            
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value.trim();
            
            try {
                const reportData = {
                    messageId: state.reportTargetMessage,
                    reason: reason,
                    details: details,
                    reporterId: state.user.uid,
                    reporterEmail: state.user.email,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('reports').add(reportData);
                
                document.getElementById('reportModal').classList.remove('active');
                state.reportTargetMessage = null;
                document.getElementById('reportReason').value = 'spam';
                document.getElementById('reportDetails').value = '';
                
                showAlert('Успех', 'Жалоба отправлена. Администратор рассмотрит её в ближайшее время.');
                
            } catch (error) {
                console.error("❌ Ошибка отправки жалобы:", error);
                showAlert('Ошибка', 'Ошибка отправки жалобы');
            }
        }

        function loadNotifications() {
            if (!state.user || !db) return;
            
            if (state.notificationListenerUnsubscribe) {
                state.notificationListenerUnsubscribe();
            }
            
            const notificationsRef = db.collection('notifications')
                .where('userId', '==', state.user.uid)
                .limit(20);
            
            const unsubscribe = notificationsRef.onSnapshot((snapshot) => {
                const notificationsContainer = document.getElementById('notificationsContainer');
                const badge = document.getElementById('notificationsBadge');
                
                if (!notificationsContainer) return;
                
                notificationsContainer.innerHTML = '';
                let unreadCount = 0;
                
                if (snapshot.empty) {
                    notificationsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-bell-slash" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>У вас пока нет уведомлений</p>
                        </div>
                    `;
                } else {
                    const notifications = [];
                    snapshot.forEach(doc => {
                        const notification = doc.data();
                        notification.id = doc.id;
                        notifications.push(notification);
                    });
                    
                    notifications.sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    notifications.forEach(notification => {
                        const notificationElement = document.createElement('div');
                        notificationElement.className = 'handshake-item';
                        notificationElement.style.opacity = notification.read ? '0.7' : '1';
                        
                        let actionButtons = '';
                        if (notification.type === 'handshake' && !notification.read && notification.handshakeId) {
                            actionButtons = `
                                <div style="display: flex; gap: 8px; margin-top: 10px;">
                                    <button class="btn btn-success btn-sm" onclick="acceptHandshake('${notification.id}', '${notification.handshakeId}')">
                                        <i class="fas fa-check"></i> Принять
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectHandshake('${notification.id}')">
                                        <i class="fas fa-times"></i> Отклонить
                                    </button>
                                </div>
                            `;
                        }
                        
                        const notificationDate = notification.createdAt ? 
                            new Date(notification.createdAt).toLocaleString() : 
                            'Только что';
                            
                        const title = notification.title || 'Уведомление';
                        const message = notification.message || '';
                        
                        notificationElement.innerHTML = `
                            <div class="handshake-info">
                                <strong>${title}</strong>
                                <p>${message}</p>
                                <small style="color: var(--text-secondary);">
                                    ${notificationDate}
                                </small>
                            </div>
                            ${actionButtons}
                        `;
                        
                        notificationsContainer.appendChild(notificationElement);
                        
                        if (!notification.read) unreadCount++;
                    });
                }
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }, (error) => {
                console.error("❌ Ошибка загрузки уведомлений:", error);
            });
            
            state.notificationListenerUnsubscribe = unsubscribe;
        }

        async function loadContacts() {
            if (!state.user || !db) return;
            
            try {
                const snapshot = await db.collection('handshakes')
                    .where('status', '==', 'accepted')
                    .get();
                
                const contactsContainer = document.getElementById('contactsContainer');
                
                if (!contactsContainer) return;
                
                contactsContainer.innerHTML = '';
                const now = new Date();
                let hasContacts = false;
                
                snapshot.forEach(doc => {
                    const handshake = doc.data();
                    
                    const isFromMe = handshake.fromUserId === state.user.uid;
                    const isToMe = handshake.toUserId === state.user.uid;
                    
                    if (!isFromMe && !isToMe) return;
                    
                    const contactTelegram = isFromMe ? handshake.toTelegram : handshake.fromTelegram;
                    const contactAnonymousId = isFromMe ? handshake.toAnonymousId : handshake.fromAnonymousId;
                    const expiresAt = new Date(handshake.expiresAt);
                    const timeLeft = expiresAt - now;
                    
                    if (timeLeft <= 0) return;
                    
                    hasContacts = true;
                    const hoursLeft = Math.max(Math.floor(timeLeft / (1000 * 60 * 60)), 0);
                    
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-card';
                    
                    const timeText = hoursLeft < 1 ? 'Меньше часа' : `${hoursLeft} ч`;
                    
                    contactElement.innerHTML = `
                        <div class="contact-header">
                            <div class="contact-avatar">${contactAnonymousId}</div>
                            <div class="contact-details">
                                <h4>Аноним #${contactAnonymousId}</h4>
                                <div class="contact-telegram">
                                    <i class="fab fa-telegram"></i> ${contactTelegram}
                                </div>
                            </div>
                            <div class="contact-time">
                                <i class="fas fa-clock"></i> ${timeText}
                            </div>
                        </div>
                        <div class="contact-expires">
                            <i class="fas fa-hourglass-end"></i> Истекает через ${timeText}
                        </div>
                    `;
                    
                    contactsContainer.appendChild(contactElement);
                });
                
                if (!hasContacts) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-handshake" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>У вас пока нет контактов через рукопожатия</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("❌ Ошибка загрузки контактов:", error);
            }
        }

        function generateAnonymousId() {
            return Math.floor(100 + Math.random() * 900);
        }

        function formatMessageText(text) {
            if (!text) return '';
            
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        function showAuthError(message) {
            const statusElement = document.getElementById('authStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showRegisterError(message) {
            const statusElement = document.getElementById('registerStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showRegisterSuccess(message) {
            const statusElement = document.getElementById('registerStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        function showVerifyError(message) {
            const statusElement = document.getElementById('verifyStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showVerifySuccess(message) {
            const statusElement = document.getElementById('verifyStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        function showApplicationError(message) {
            const statusElement = document.getElementById('applicationStatusMessage');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showApplicationSuccess(message) {
            const statusElement = document.getElementById('applicationStatusMessage');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        async function loadAdminPanel() {
            if (!state.isAdmin || !db) return;
            
            await loadAdminStats();
            
            switch(state.currentAdminTab) {
                case 'applications':
                    await loadApplications();
                    break;
                case 'approved':
                    await loadApprovedUsers();
                    break;
                case 'banned':
                    await loadBannedUsers();
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'admins':
                    await loadAdmins();
                    break;
            }
        }

        async function loadAdminStats() {
            try {
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                
                const onlineSnapshot = await db.collection('users')
                    .where('online', '==', true)
                    .get();
                document.getElementById('onlineUsers').textContent = onlineSnapshot.size;
                
                const pendingAppsSnapshot = await db.collection('applications')
                    .where('status', '==', 'pending')
                    .get();
                document.getElementById('pendingApplications').textContent = pendingAppsSnapshot.size;
                
                const pendingReportsSnapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .get();
                document.getElementById('pendingReports').textContent = pendingReportsSnapshot.size;
                
            } catch (error) {
                console.error("❌ Ошибка загрузки статистики:", error);
            }
        }

        async function loadApplications() {
            try {
                const snapshot = await db.collection('applications')
                    .where('status', '==', 'pending')
                    .get();
                
                const table = document.getElementById('applicationsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Нет заявок на рассмотрении
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const app = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${app.userEmail}</td>
                        <td>${app.telegramUsername || 'Не указан'}</td>
                        <td>${new Date(app.submittedAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="approveApplication('${doc.id}', '${app.userId}')">
                                    Одобрить
                                </button>
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="rejectApplication('${doc.id}', '${app.userId}')">
                                    Отклонить
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки заявок:", error);
            }
        }

        async function loadApprovedUsers() {
            try {
                const snapshot = await db.collection('users')
                    .where('isVerified', '==', true)
                    .where('isBanned', '==', false)
                    .get();
                
                const table = document.getElementById('approvedTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Нет одобренных пользователей
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.telegramUsername || 'Не указан'}</td>
                        <td>${user.verifiedAt ? new Date(user.verifiedAt).toLocaleString() : 'Не подтвержден'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="showBanUserModal('${doc.id}', '${user.email}')">
                                    Заблокировать
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки одобренных:", error);
            }
        }

        async function loadBannedUsers() {
            try {
                const snapshot = await db.collection('users')
                    .where('isBanned', '==', true)
                    .get();
                
                const table = document.getElementById('bannedTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Нет заблокированных пользователей
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(async doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    const expiresAt = user.banExpiresAt 
                        ? new Date(user.banExpiresAt).toLocaleString()
                        : 'Навсегда';
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.telegramUsername || 'Не указан'}</td>
                        <td>${user.banReason || 'Нарушение правил'}</td>
                        <td>${user.bannedAt ? new Date(user.bannedAt).toLocaleString() : '—'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="unbanUser('${doc.id}')">
                                    Разблокировать
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки заблокированных:", error);
            }
        }

        async function loadReports() {
            try {
                const snapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .get();
                
                const table = document.getElementById('reportsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Нет жалоб на рассмотрении
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(async doc => {
                    const report = doc.data();
                    const row = document.createElement('tr');
                    
                    let messageText = 'Сообщение удалено';
                    try {
                        const messageDoc = await db.collection('messages').doc(report.messageId).get();
                        if (messageDoc.exists) {
                            const message = messageDoc.data();
                            messageText = message.text.substring(0, 50) + (message.text.length > 50 ? '...' : '');
                        }
                    } catch (error) {
                        console.error("Ошибка загрузки сообщения:", error);
                    }
                    
                    row.innerHTML = `
                        <td>${report.reporterEmail}</td>
                        <td>${messageText}</td>
                        <td>${getReasonText(report.reason)}</td>
                        <td>${new Date(report.createdAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="resolveReport('${doc.id}')">
                                    Рассмотрено
                                </button>
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="deleteMessageFromReport('${doc.id}', '${report.messageId}')">
                                    Удалить сообщение
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки жалоб:", error);
            }
        }

        function getReasonText(reason) {
            const reasons = {
                'spam': 'Спам или реклама',
                'insult': 'Оскорбления или угрозы',
                'hate': 'Разжигание ненависти',
                'illegal': 'Незаконный контент',
                'fraud': 'Мошенничество',
                'other': 'Другое'
            };
            return reasons[reason] || reason;
        }

        async function loadAdmins() {
            try {
                const snapshot = await db.collection('users')
                    .where('isAdmin', '==', true)
                    .get();
                
                const table = document.getElementById('adminsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Нет администраторов
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${new Date(user.createdAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="removeAdmin('${doc.id}')" ${state.user.uid === doc.id ? 'disabled' : ''}>
                                    Удалить
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("❌ Ошибка загрузки администраторов:", error);
            }
        }

        async function approveApplication(applicationId, userId) {
            showConfirm('Подтверждение', 'Одобрить эту заявку?', async () => {
                try {
                    await db.collection('applications').doc(applicationId).update({
                        status: 'approved',
                        reviewedBy: state.user.email,
                        reviewedAt: new Date().toISOString()
                    });
                    
                    await db.collection('users').doc(userId).update({
                        isVerified: true,
                        verifiedAt: new Date().toISOString()
                    });
                    
                    showAlert('Успех', 'Заявка одобрена!');
                    await loadApplications();
                    await loadApprovedUsers();
                    await loadAdminStats();
                    
                } catch (error) {
                    console.error("❌ Ошибка одобрения заявки:", error);
                    showAlert('Ошибка', 'Ошибка одобрения заявки');
                }
            });
        }

        async function rejectApplication(applicationId, userId) {
            showConfirm('Подтверждение', 'Отклонить эту заявку?', async () => {
                try {
                    await db.collection('applications').doc(applicationId).update({
                        status: 'rejected',
                        reviewedBy: state.user.email,
                        reviewedAt: new Date().toISOString()
                    });
                    
                    showAlert('Успех', 'Заявка отклонена!');
                    await loadApplications();
                    await loadAdminStats();
                    
                } catch (error) {
                    console.error("❌ Ошибка отклонения заявки:", error);
                    showAlert('Ошибка', 'Ошибка отклонения заявки');
                }
            });
        }

        window.showBanUserModal = function(userId, userEmail) {
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    state.banTargetUser = {
                        userId: userId,
                        email: userEmail,
                        anonymousId: user.anonymousId || '???',
                        telegramUsername: user.telegramUsername
                    };
                    
                    showBanModal();
                }
            }).catch(error => {
                console.error("❌ Ошибка получения данных пользователя:", error);
                showAlert('Ошибка', 'Не удалось получить данные пользователя');
            });
        };

        async function banUser(userId, userEmail) {
            state.banTargetUser = {
                userId: userId,
                email: userEmail,
                anonymousId: '???'
            };
            
            showBanModal();
        }

        async function unbanUser(userId) {
            showConfirm('Подтверждение', 'Разблокировать этого пользователя?', async () => {
                try {
                    await db.collection('users').doc(userId).update({
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        banExpiresAt: null,
                        isVerified: true
                    });
                    
                    showAlert('Успех', 'Пользователь разблокирован!');
                    await loadApprovedUsers();
                    await loadBannedUsers();
                    await loadAdminStats();
                    
                } catch (error) {
                    console.error("❌ Ошибка разблокировки пользователя:", error);
                    showAlert('Ошибка', 'Ошибка разблокировки пользователя');
                }
            });
        }

        async function resolveReport(reportId) {
            showConfirm('Подтверждение', 'Пометить жалобу как рассмотренную?', async () => {
                try {
                    await db.collection('reports').doc(reportId).update({
                        status: 'resolved',
                        resolvedBy: state.user.email,
                        resolvedAt: new Date().toISOString()
                    });
                    
                    showAlert('Успех', 'Жалоба помечена как рассмотренная!');
                    await loadReports();
                    await loadAdminStats();
                    
                } catch (error) {
                    console.error("❌ Ошибка обработки жалобы:", error);
                    showAlert('Ошибка', 'Ошибка обработки жалобы');
                }
            });
        }

        async function deleteMessageFromReport(reportId, messageId) {
            showConfirm('Подтверждение', 'Удалить это сообщение?', async () => {
                try {
                    await db.collection('messages').doc(messageId).delete();
                    
                    await db.collection('reports').doc(reportId).update({
                        status: 'resolved',
                        resolvedBy: state.user.email,
                        resolvedAt: new Date().toISOString()
                    });
                    
                    showAlert('Успех', 'Сообщение удалено и жалоба обработана!');
                    await loadReports();
                    await loadAdminStats();
                    
                } catch (error) {
                    console.error("❌ Ошибка удаления сообщения:", error);
                    showAlert('Ошибка', 'Ошибка удаления сообщения');
                }
            });
        }

        async function addAdmin() {
            const email = document.getElementById('addAdminEmail').value.trim();
            if (!email) {
                showAlert('Внимание', 'Введите email');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                if (usersSnapshot.empty) {
                    showAlert('Ошибка', 'Пользователь с таким email не найден');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                
                await userDoc.ref.update({
                    isAdmin: true
                });
                
                document.getElementById('addAdminEmail').value = '';
                showAlert('Успех', 'Администратор добавлен!');
                await loadAdmins();
                
            } catch (error) {
                console.error("❌ Ошибка добавления администратора:", error);
                showAlert('Ошибка', 'Ошибка добавления администратора');
            }
        }

        async function removeAdmin(userId) {
            showConfirm('Подтверждение', 'Удалить этого администратора?', async () => {
                try {
                    await db.collection('users').doc(userId).update({
                        isAdmin: false
                    });
                    
                    showAlert('Успех', 'Администратор удален!');
                    await loadAdmins();
                    
                } catch (error) {
                    console.error("❌ Ошибка удаления администратора:", error);
                    showAlert('Ошибка', 'Ошибка удаления администратора');
                }
            });
        }

        function updateAdminTabs() {
            const tabs = ['applications', 'approved', 'banned', 'reports', 'admins'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                const content = document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
                
                if (tab === state.currentAdminTab) {
                    btn.style.backgroundColor = 'var(--accent)';
                    btn.style.color = 'white';
                    content.classList.remove('hidden');
                } else {
                    btn.style.backgroundColor = 'var(--bg-tertiary)';
                    btn.style.color = 'var(--text-primary)';
                    content.classList.add('hidden');
                }
            });
        }

        async function sendMessage() {
            if (state.isSendingMessage) {
                console.log("⚠️ Сообщение уже отправляется, пропускаем");
                return;
            }
            
            const text = document.getElementById('messageInput').value.trim();
            if (!text || !state.user || !state.isVerified) return;
            
            if (state.userData.isBanned) {
                if (state.userData.banExpiresAt) {
                    const expiresAt = new Date(state.userData.banExpiresAt);
                    const now = new Date();
                    if (expiresAt > now) {
                        const hoursLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60));
                        showAlert('Ошибка', `Вы заблокированы до ${expiresAt.toLocaleString()}. Причина: ${state.userData.banReason || 'Нарушение правил'}. Осталось: ${hoursLeft} часов.`);
                        return;
                    } else {
                        await checkAndUnbanIfExpired();
                    }
                } else {
                    showAlert('Ошибка', `Вы заблокированы навсегда. Причина: ${state.userData.banReason || 'Нарушение правил'}.`);
                    return;
                }
            }
            
            state.isSendingMessage = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const message = {
                    text: text,
                    userId: state.user.uid,
                    userEmail: state.user.email,
                    anonymousId: state.userData.anonymousId || generateAnonymousId(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    deleted: false
                };
                
                await db.collection('messages').add(message);
                
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').style.height = 'auto';
                
                console.log("✅ Сообщение отправлено:", text);
                
            } catch (error) {
                console.error("❌ Ошибка отправки:", error);
                showAlert('Ошибка', 'Ошибка отправки сообщения: ' + error.message);
            } finally {
                setTimeout(() => {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    state.isSendingMessage = false;
                }, 500);
            }
        }

        window.offerHandshakeConfirm = function(anonymousId, targetUserId, targetUserEmail) {
            state.pendingHandshakeTarget = { anonymousId, targetUserId, targetUserEmail };
            
            document.getElementById('handshakeConfirmInfo').innerHTML = `
                <div class="handshake-notification">
                    <h4>Подтверждение рукопожатия</h4>
                    <p>Вы собираетесь предложить рукопожатие <strong>Анониму #${anonymousId}</strong></p>
                    <p>После подтверждения:</p>
                    <ul>
                        <li>Ваш Telegram (<strong>${state.userData.telegramUsername}</strong>) будет отправлен пользователю</li>
                        <li>Вы получите Telegram пользователя в ответ</li>
                        <li>Контакты будут доступны 24 часа</li>
                        <li>Обмен контактами (Рукопожатие) действует только при взаимном согласии</li>
                    </ul>
                    <p><strong>Администрация не несет ответственности за последствия обмена контактами.</strong></p>
                </div>
            `;
            
            document.getElementById('confirmHandshakeModal').classList.add('active');
        };

        async function confirmHandshake() {
            if (!state.pendingHandshakeTarget) return;
            
            const { anonymousId, targetUserId, targetUserEmail } = state.pendingHandshakeTarget;
            
            try {
                const targetUserDoc = await db.collection('users').doc(targetUserId).get();
                if (!targetUserDoc.exists) {
                    showAlert('Ошибка', 'Пользователь не найден');
                    return;
                }
                
                const targetUser = targetUserDoc.data();
                
                if (!targetUser.telegramUsername) {
                    showAlert('Ошибка', 'У этого пользователя не указан Telegram');
                    return;
                }
                
                if (targetUser.isBanned) {
                    showAlert('Ошибка', 'Этот пользователь заблокирован');
                    return;
                }
                
                if (!targetUser.isVerified) {
                    showAlert('Ошибка', 'Этот пользователь не подтвержден');
                    return;
                }
                
                const existingHandshake = await db.collection('handshakes')
                    .where('fromUserId', '==', state.user.uid)
                    .where('toUserId', '==', targetUserId)
                    .where('status', 'in', ['pending', 'accepted'])
                    .limit(1)
                    .get();
                
                if (!existingHandshake.empty) {
                    showAlert('Внимание', 'Вы уже отправили предложение рукопожатия этому пользователю');
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                    return;
                }
                
                const handshakeData = {
                    fromUserId: state.user.uid,
                    fromEmail: state.user.email,
                    fromTelegram: state.userData.telegramUsername,
                    fromAnonymousId: state.userData.anonymousId,
                    toUserId: targetUserId,
                    toEmail: targetUserEmail,
                    toTelegram: targetUser.telegramUsername,
                    toAnonymousId: targetUser.anonymousId || anonymousId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };
                
                const handshakeRef = await db.collection('handshakes').add(handshakeData);
                
                const notificationData = {
                    userId: targetUserId,
                    type: 'handshake',
                    title: 'Предложение рукопожатия',
                    message: `Аноним #${state.userData.anonymousId} предлагает обменяться контактами.`,
                    handshakeData: handshakeData,
                    handshakeId: handshakeRef.id,
                    read: false,
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('notifications').add(notificationData);
                
                document.getElementById('confirmHandshakeModal').classList.remove('active');
                state.pendingHandshakeTarget = null;
                
                showAlert('Успех', '🤝 Предложение рукопожатия отправлено! Пользователь получит уведомление.');
                
            } catch (error) {
                console.error('❌ Ошибка рукопожатия:', error);
                showAlert('Ошибка', 'Ошибка отправки предложения рукопожатия');
            }
        }

        window.acceptHandshake = async function(notificationId, handshakeId) {
            showConfirm('Подтверждение', 'Вы уверены, что хотите принять рукопожатие и обменяться контактами?', async () => {
                try {
                    const notificationRef = db.collection('notifications').doc(notificationId);
                    const notificationDoc = await notificationRef.get();
                    
                    if (!notificationDoc.exists) {
                        showAlert('Ошибка', 'Уведомление не найдено');
                        return;
                    }
                    
                    const notification = notificationDoc.data();
                    
                    const handshakeRef = db.collection('handshakes').doc(handshakeId);
                    const handshakeDoc = await handshakeRef.get();
                    
                    if (!handshakeDoc.exists) {
                        showAlert('Ошибка', 'Рукопожатие не найдено');
                        return;
                    }
                    
                    const handshake = handshakeDoc.data();
                    
                    await handshakeRef.update({
                        status: 'accepted',
                        acceptedAt: new Date().toISOString()
                    });
                    
                    await notificationRef.update({ 
                        read: true,
                        updatedAt: new Date().toISOString()
                    });
                    
                    const fromUserId = handshake.fromUserId;
                    if (fromUserId) {
                        await db.collection('notifications').add({
                            userId: fromUserId,
                            type: 'handshake_accepted',
                            title: 'Рукопожатие принято',
                            message: `Аноним #${state.userData.anonymousId} принял ваше предложение рукопожатия.`,
                            read: false,
                            createdAt: new Date().toISOString(),
                            handshakeId: handshakeId
                        });
                    }
                    
                    await loadContacts();
                    
                    showAlert('Успех', '🤝 Рукопожатие принято! Контакты обновлены.');
                    
                } catch (error) {
                    console.error('❌ Ошибка принятия рукопожатия:', error);
                    showAlert('Ошибка', 'Ошибка принятия рукопожатия');
                }
            });
        };

        window.rejectHandshake = async function(notificationId) {
            showConfirm('Подтверждение', 'Отклонить предложение рукопожатия?', async () => {
                try {
                    await db.collection('notifications').doc(notificationId).update({ 
                        read: true,
                        updatedAt: new Date().toISOString()
                    });
                    showAlert('Успех', 'Предложение рукопожатия отклонено');
                } catch (error) {
                    console.error('❌ Ошибка отклонения:', error);
                    showAlert('Ошибка', 'Ошибка отклонения рукопожатия');
                }
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            const contextBan = document.getElementById('contextBan');
            if (contextBan) {
                contextBan.addEventListener('click', banUserFromContext);
            }
            
            document.getElementById('contextDelete').addEventListener('click', async () => {
                if (state.contextMenu.isMyMessage) {
                    await deleteMessage();
                } else if (state.isAdmin) {
                    await adminDeleteMessage();
                }
            });
            
            document.getElementById('contextReport').addEventListener('click', reportMessage);
            document.getElementById('contextClose').addEventListener('click', hideMessageContextMenu);
            
            document.addEventListener('click', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            document.getElementById('mobileContextOverlay').addEventListener('click', hideMobileContextMenu);
            
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginTab && registerTab && loginForm && registerForm) {
                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });
                
                registerTab.addEventListener('click', () => {
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }
            
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail) {
                loginEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            const resendVerifyBtn = document.getElementById('resendVerifyBtn');
            const checkVerifyBtn = document.getElementById('checkVerifyBtn');
            const logoutFromVerifyBtn = document.getElementById('logoutFromVerifyBtn');
            
            if (resendVerifyBtn) {
                resendVerifyBtn.addEventListener('click', resendVerificationEmail);
            }
            
            if (checkVerifyBtn) {
                checkVerifyBtn.addEventListener('click', checkEmailVerification);
            }
            
            if (logoutFromVerifyBtn) {
                logoutFromVerifyBtn.addEventListener('click', handleLogout);
            }
            
            const submitApplicationBtn = document.getElementById('submitApplicationBtn');
            const logoutFromAppBtn = document.getElementById('logoutFromAppBtn');
            
            if (submitApplicationBtn) {
                submitApplicationBtn.addEventListener('click', submitApplication);
            }
            
            if (logoutFromAppBtn) {
                logoutFromAppBtn.addEventListener('click', handleLogout);
            }
            
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, state.isTouchDevice ? 100 : 120) + 'px';
                    this.style.overflowY = this.scrollHeight > (state.isTouchDevice ? 100 : 120) ? 'auto' : 'hidden';
                });
            }
            
            const profileBtn = document.getElementById('profileBtn');
            const contactsBtn = document.getElementById('contactsBtn');
            const notificationsBtn = document.getElementById('notificationsBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.add('active');
                });
            }
            
            if (contactsBtn) {
                contactsBtn.addEventListener('click', () => {
                    loadContacts();
                    document.getElementById('contactsModal').classList.add('active');
                });
            }
            
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    document.getElementById('notificationsModal').classList.add('active');
                });
            }
            
            if (adminBtn) {
                adminBtn.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    document.getElementById('adminModal').classList.add('active');
                    loadAdminPanel();
                });
            }
            
            const closeProfileBtn = document.getElementById('closeProfileBtn');
            const closeContactsBtn = document.getElementById('closeContactsBtn');
            const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
            const closeAdminBtn = document.getElementById('closeAdminBtn');
            const closeConfirmHandshakeBtn = document.getElementById('closeConfirmHandshakeBtn');
            const closeReportBtn = document.getElementById('closeReportBtn');
            const closeBanBtn = document.getElementById('closeBanBtn');
            
            if (closeProfileBtn) {
                closeProfileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.remove('active');
                });
            }
            
            if (closeContactsBtn) {
                closeContactsBtn.addEventListener('click', () => {
                    document.getElementById('contactsModal').classList.remove('active');
                });
            }
            
            if (closeNotificationsBtn) {
                closeNotificationsBtn.addEventListener('click', () => {
                    document.getElementById('notificationsModal').classList.remove('active');
                });
            }
            
            if (closeAdminBtn) {
                closeAdminBtn.addEventListener('click', () => {
                    document.getElementById('adminModal').classList.remove('active');
                });
            }
            
            if (closeConfirmHandshakeBtn) {
                closeConfirmHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
            
            if (closeReportBtn) {
                closeReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            if (closeBanBtn) {
                closeBanBtn.addEventListener('click', () => {
                    document.getElementById('banModal').classList.remove('active');
                    state.banTargetUser = null;
                });
            }
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            const submitReportBtn = document.getElementById('submitReportBtn');
            const cancelReportBtn = document.getElementById('cancelReportBtn');
            
            if (submitReportBtn) {
                submitReportBtn.addEventListener('click', submitReport);
            }
            
            if (cancelReportBtn) {
                cancelReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            const submitBanBtn = document.getElementById('submitBanBtn');
            const cancelBanBtn = document.getElementById('cancelBanBtn');
            
            if (submitBanBtn) {
                submitBanBtn.addEventListener('click', submitBan);
            }
            
            if (cancelBanBtn) {
                cancelBanBtn.addEventListener('click', () => {
                    document.getElementById('banModal').classList.remove('active');
                    state.banTargetUser = null;
                });
            }
            
            const adminTabApplications = document.getElementById('adminTabApplications');
            const adminTabApproved = document.getElementById('adminTabApproved');
            const adminTabBanned = document.getElementById('adminTabBanned');
            const adminTabReports = document.getElementById('adminTabReports');
            const adminTabAdmins = document.getElementById('adminTabAdmins');
            
            if (adminTabApplications) {
                adminTabApplications.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    loadApplications();
                });
            }
            
            if (adminTabApproved) {
                adminTabApproved.addEventListener('click', () => {
                    state.currentAdminTab = 'approved';
                    updateAdminTabs();
                    loadApprovedUsers();
                });
            }
            
            if (adminTabBanned) {
                adminTabBanned.addEventListener('click', () => {
                    state.currentAdminTab = 'banned';
                    updateAdminTabs();
                    loadBannedUsers();
                });
            }
            
            if (adminTabReports) {
                adminTabReports.addEventListener('click', () => {
                    state.currentAdminTab = 'reports';
                    updateAdminTabs();
                    loadReports();
                });
            }
            
            if (adminTabAdmins) {
                adminTabAdmins.addEventListener('click', () => {
                    state.currentAdminTab = 'admins';
                    updateAdminTabs();
                    loadAdmins();
                });
            }
            
            const addAdminBtn = document.getElementById('addAdminBtn');
            const addAdminEmail = document.getElementById('addAdminEmail');
            
            if (addAdminBtn) {
                addAdminBtn.addEventListener('click', addAdmin);
            }
            
            if (addAdminEmail) {
                addAdminEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') addAdmin();
                });
            }
            
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    state.theme = newTheme;
                    document.body.classList.toggle('dark-theme');
                    document.body.classList.toggle('light-theme');
                    localStorage.setItem('neznakomka-theme', newTheme);
                    
                    const icon = themeToggle.querySelector('i');
                    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                });
            }
            
            const savedTheme = localStorage.getItem('neznakomka-theme') || 'light';
            state.theme = savedTheme;
            document.body.classList.add(savedTheme + '-theme');
            const icon = document.getElementById('themeToggle')?.querySelector('i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            if (state.isTouchDevice) {
                document.body.classList.add('touch-device');
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            const confirmHandshakeBtn = document.getElementById('confirmHandshakeBtn');
            const cancelHandshakeBtn = document.getElementById('cancelHandshakeBtn');
            
            if (confirmHandshakeBtn) {
                confirmHandshakeBtn.addEventListener('click', confirmHandshake);
            }
            
            if (cancelHandshakeBtn) {
                cancelHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
            
            const customAlertConfirm = document.getElementById('customAlertConfirm');
            if (customAlertConfirm) {
                customAlertConfirm.addEventListener('click', () => {
                    document.getElementById('customAlertOverlay').classList.remove('active');
                    document.getElementById('customAlert').classList.remove('active');
                });
            }
        });

        window.approveApplication = approveApplication;
        window.rejectApplication = rejectApplication;
        window.banUser = banUser;
        window.unbanUser = unbanUser;
        window.resolveReport = resolveReport;
        window.deleteMessageFromReport = deleteMessageFromReport;
        window.removeAdmin = removeAdmin;

    </script>

<div class="modal-overlay" id="avatarModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Выберите аватар</h2>
      <button class="modal-close" id="closeAvatarModal">&times;</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:10px;font-size:28px;text-align:center;">
      <span class="avatar-option">🙂</span>
      <span class="avatar-option">😎</span>
      <span class="avatar-option">🥷</span>
      <span class="avatar-option">👩</span>
      <span class="avatar-option">👨</span>
      <span class="avatar-option">🐶</span>
      <span class="avatar-option">🐱</span>
      <span class="avatar-option">🦊</span>
      <span class="avatar-option">🐼</span>
      <span class="avatar-option">🐵</span>
      <span class="avatar-option">🦎</span>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const avatarModal = document.getElementById("avatarModal");
const changeAvatarBtn = document.getElementById("changeAvatarBtn");
const closeAvatarModal = document.getElementById("closeAvatarModal");
const profileAvatar = document.getElementById("profileAvatar");
const userAvatar = document.getElementById("userAvatar");

if(changeAvatarBtn){
changeAvatarBtn.onclick = () => avatarModal.classList.add("active");
}

if(closeAvatarModal){
closeAvatarModal.onclick = () => avatarModal.classList.remove("active");
}

document.querySelectorAll(".avatar-option").forEach(el=>{
el.style.cursor="pointer";
el.onclick = async function(){
const selected = this.textContent;
profileAvatar.textContent = selected;
userAvatar.textContent = selected;
avatarModal.classList.remove("active");

if(firebase.auth().currentUser){
await firebase.firestore().collection("users")
.doc(firebase.auth().currentUser.uid)
.set({avatar:selected},{merge:true});
}
}
});

// Load avatar on start
firebase.auth().onAuthStateChanged(async user=>{
if(user){
const doc = await firebase.firestore().collection("users").doc(user.uid).get();
if(doc.exists && doc.data().avatar){
profileAvatar.textContent = doc.data().avatar;
userAvatar.textContent = doc.data().avatar;
}
}
});

});
</script>


<!-- ===== AVATAR SYSTEM ADDON (NON-DESTRUCTIVE) ===== -->
<style>
.message-with-avatar{display:flex;align-items:flex-end;gap:6px}
.message-with-avatar.my{flex-direction:row-reverse}
.message-avatar{font-size:22px;line-height:1}
.avatar-picker-grid{display:grid;grid-template-columns:repeat(auto-fill,40px);gap:10px;font-size:24px}
.avatar-picker-grid span{cursor:pointer;border-radius:10px;padding:4px;text-align:center}
.avatar-picker-grid span:hover{background:rgba(255,255,255,0.1)}
</style>

<div class="modal-overlay" id="avatarPickerModal">
 <div class="modal">
  <div class="modal-header">
   <h2>Аватар</h2>
   <button class="modal-close" onclick="closeAvatarPicker()">&times;</button>
  </div>
  <div class="avatar-picker-grid" id="avatarGrid"></div>
 </div>
</div>

<script>
const AVATAR_SET=['😀','😎','🥰','😈','👻','🤡','🐱','🐶','🦊','🐼','🐸','🐵','🔥','💀','💜'];
const usersRef=firebase.firestore().collection("users");

function randAvatar(){return AVATAR_SET[Math.floor(Math.random()*AVATAR_SET.length)]}

async function ensureAvatar(uid){
 const ref=usersRef.doc(uid);
 const snap=await ref.get();
 if(snap.exists && snap.data().avatar) return snap.data().avatar;
 const a=randAvatar();
 await ref.set({avatar:a},{merge:true});
 return a;
}

function openAvatarPicker(){document.getElementById('avatarPickerModal').classList.add('active')}
function closeAvatarPicker(){document.getElementById('avatarPickerModal').classList.remove('active')}

const grid=document.getElementById('avatarGrid');
AVATAR_SET.forEach(e=>{
 const s=document.createElement('span');
 s.textContent=e;
 s.onclick=async()=>{
  const u=firebase.auth().currentUser;
  if(!u) return;
  await usersRef.doc(u.uid).set({avatar:e},{merge:true});
  closeAvatarPicker();
 };
 grid.appendChild(s);
});

document.getElementById('changeAvatarBtn')?.addEventListener('click',openAvatarPicker);

// wrap existing message render
if(window.addMessageToChat){
 const orig=window.addMessageToChat;
 window.addMessageToChat=async function(m,isMine){
  const wrap=document.createElement('div');
  wrap.className='message-with-avatar'+(isMine?' my':'');
  const av=document.createElement('div');
  av.className='message-avatar';
  av.textContent=m.avatar||'🙂';
  const msg=await orig(m,isMine);
  wrap.append(av,msg);
  return wrap;
 }
}

// attach avatar on send
if(window.sendMessage){
 const origSend=window.sendMessage;
 window.sendMessage=async function(){
  const u=firebase.auth().currentUser;
  if(u){window.currentUserAvatar=await ensureAvatar(u.uid);}
  return origSend();
 }
}

firebase.auth().onAuthStateChanged(async u=>{
 if(!u) return;
 await ensureAvatar(u.uid);
});
</script>
<!-- ===== END AVATAR SYSTEM ADDON ===== -->


<!-- ===== PRO MESSENGER AVATAR SYSTEM ===== -->
<script>
const DEFAULT_AVATAR = "🙂";

// Ensure avatar exists in Firestore + state
async function ensureAvatarSynced(){
    if(!state.user) return;
    const ref = db.collection("users").doc(state.user.uid);
    const snap = await ref.get();

    if(!snap.exists){
        await ref.set({ avatar: DEFAULT_AVATAR }, { merge:true });
        state.userData.avatar = DEFAULT_AVATAR;
        return;
    }

    const data = snap.data();
    if(!data.avatar){
        await ref.set({ avatar: DEFAULT_AVATAR }, { merge:true });
        state.userData.avatar = DEFAULT_AVATAR;
    }else{
        state.userData.avatar = data.avatar;
    }
}

// Sync on login
firebase.auth().onAuthStateChanged(async user=>{
    if(user){
        await ensureAvatarSynced();
        updateProfileAvatarUI();
    }
});

// Update profile + header avatar
function updateProfileAvatarUI(){
    if(!state.userData) return;
    const avatar = state.userData.avatar || DEFAULT_AVATAR;

    const profileAvatar = document.getElementById("profileAvatar");
    const userAvatar = document.getElementById("userAvatar");

    if(profileAvatar) profileAvatar.textContent = avatar;
    if(userAvatar) userAvatar.textContent = avatar;
}

// Hook avatar picker buttons
document.addEventListener("click", async function(e){
    if(e.target.classList.contains("avatar-option")){
        const selected = e.target.textContent;
        if(!state.user) return;

        await db.collection("users").doc(state.user.uid)
            .set({ avatar:selected }, { merge:true });

        state.userData.avatar = selected;
        updateProfileAvatarUI();
    }
});

// ---- SAFE MESSAGE RENDER EXTENSION ----
// We DO NOT replace original renderer.
// We decorate message after it is added.

const originalAddMessageToUI = addMessageToUI;

addMessageToUI = function(message){

    originalAddMessageToUI(message);

    if(message.deleted) return;

    const messageElement = document.querySelector('[data-message-id="'+message.id+'"]');
    if(!messageElement) return;

    // Avoid double wrapping
    if(messageElement.parentElement.classList.contains("message-with-avatar")) return;

    const isMine = message.userId === state.user.uid;

    const wrapper = document.createElement("div");
    wrapper.className = "message-with-avatar" + (isMine ? " my" : "");

    const avatarEl = document.createElement("div");
    avatarEl.className = "message-avatar";
    avatarEl.textContent = message.avatar || DEFAULT_AVATAR;

    // Insert wrapper in place
    messageElement.parentNode.insertBefore(wrapper, messageElement);
    wrapper.appendChild(avatarEl);
    wrapper.appendChild(messageElement);
};

// ---- ENSURE avatar stored in NEW messages ----
// Patch Firestore add via sendMessage wrapping minimally

const originalSendMessage = sendMessage;

sendMessage = async function(){

    await ensureAvatarSynced();

    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text) return;

    const messageData = {
        text: text,
        userId: state.user.uid,
        avatar: state.userData.avatar || DEFAULT_AVATAR,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        deleted: false
    };

    await db.collection("messages").add(messageData);

    input.value = "";
    input.style.height = "auto";
};

</script>

<style>
.message-with-avatar{
    display:flex;
    align-items:flex-end;
    gap:6px;
}

.message-with-avatar.my{
    flex-direction:row-reverse;
}

.message-avatar{
    font-size:22px;
    line-height:1;
}
</style>
<!-- ===== END PRO MESSENGER AVATAR SYSTEM ===== -->

</body>
</html>