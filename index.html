<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç —Å Telegram</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #0f0f23; color: #fff; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #00aaff; }
        input, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; font-size: 16px; }
        input, textarea { background: #1a1a2e; color: #fff; }
        button { background: #0088cc; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #00aaff; }
        .hidden { display: none; }
        #messages { height: 300px; overflow-y: auto; background: #1a1a2e; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.1); }
        .message { background: #16213e; padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 3px solid #00aaff; }
        .message .author { color: #00aaff; font-weight: bold; }
        .error { color: #ff6b6b; background: rgba(255,107,107,0.1); padding: 10px; border-radius: 8px; }
        .success { color: #4ecdc4; background: rgba(78,205,196,0.1); padding: 10px; border-radius: 8px; }
        #userInfo { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,170,255,0.1); border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</h1>
        <p style="text-align: center; color: #aaa; margin-bottom: 30px;">–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Telegram</p>
        
        <!-- 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
        <div id="authSection" class="section">
            <h2>üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="email" placeholder="–í–∞—à email">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleAuth()" id="authButton">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <div id="authError" class="error hidden"></div>
        </div>

        <!-- 2. Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
        <div id="telegramSection" class="section hidden">
            <h2>ü§ñ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username (–±–µ–∑ @):</p>
            <input type="text" id="telegramUsername" placeholder="username">
            <button onclick="sendTelegramCode()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
            <div id="telegramStatus" class="hidden"></div>
            <input type="text" id="telegramCode" placeholder="–ö–æ–¥ –∏–∑ Telegram" class="hidden">
            <button onclick="verifyTelegramCode()" class="hidden">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>

        <!-- 3. –ß–∞—Ç -->
        <div id="chatSection" class="section hidden">
            <div id="userInfo">
                <div>
                    <strong>üë§ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</strong> <span id="userEmail"></span><br>
                    <small>üÜî ID: <span id="userId"></span></small>
                </div>
                <button onclick="logout()" style="width: auto; padding: 8px 15px;">üö™ –í—ã–π—Ç–∏</button>
            </div>
            <h2>üí¨ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</h2>
            <div id="messages"></div>
            <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3"></textarea>
            <button onclick="sendMessage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <script>
        // üî• –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyA-dQ8-cqE7y9VfNA3fPLF6hDO-s1OfQ4Q",
            authDomain: "neznakomka.firebaseapp.com",
            projectId: "neznakomka",
            storageBucket: "neznakomka.firebasestorage.app",
            messagingSenderId: "245961594712",
            appId: "1:245961594712:web:e1c8ba71af1289b1bc372d",
            measurementId: "G-QJ2Q13VB4T"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ü§ñ –¢–û–ö–ï–ù –¢–í–û–ï–ì–û –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π!)
        const TELEGRAM_BOT_TOKEN = '–¢–í–û–ô_–¢–û–ö–ï–ù_–ë–û–¢–ê';
        let telegramUsername = '';
        let verificationCode = '';

        // üì± –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ö–æ–¥–∞
        auth.onAuthStateChanged(user => {
            if (user) {
                showSection('telegramSection');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userId').textContent = user.uid.substring(0, 8) + '...';
                checkTelegramVerification(user.uid);
            } else {
                showSection('authSection');
            }
        });

        // üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –≤—Ö–æ–¥
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const button = document.getElementById('authButton');
            const errorDiv = document.getElementById('authError');

            button.disabled = true;
            button.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showError('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showError('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
                    } catch (signupError) {
                        showError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + signupError.message);
                    }
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }

            button.disabled = false;
            button.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        }

        // üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –≤ Telegram —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ API
        async function sendTelegramCode() {
            telegramUsername = document.getElementById('telegramUsername').value.trim();
            if (!telegramUsername) {
                showTelegramStatus('–í–≤–µ–¥–∏—Ç–µ Telegram username', 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) return;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
            verificationCode = Math.floor(100000 + Math.random() * 900000).toString();

            showTelegramStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...', 'info');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram API
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: `@${telegramUsername}`,
                        text: `üîê –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${verificationCode}\n\n–í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∞ —Å–∞–π—Ç–µ.`
                    })
                });

                const result = await response.json();
                if (result.ok) {
                    showTelegramStatus(`‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω @${telegramUsername}`, 'success');
                    document.getElementById('telegramCode').classList.remove('hidden');
                    document.querySelector('#telegramSection button:nth-of-type(2)').classList.remove('hidden');
                } else {
                    showTelegramStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + result.description, 'error');
                }
            } catch (error) {
                showTelegramStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        // ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞
        async function verifyTelegramCode() {
            const enteredCode = document.getElementById('telegramCode').value.trim();
            const user = auth.currentUser;

            if (!user) return;

            if (enteredCode === verificationCode) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Firestore
                await db.collection('verifiedUsers').doc(user.uid).set({
                    telegramUsername: telegramUsername,
                    verifiedAt: new Date().toISOString(),
                    email: user.email
                });

                showTelegramStatus('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –î–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É –æ—Ç–∫—Ä—ã—Ç.', 'success');
                setTimeout(() => {
                    showSection('chatSection');
                    loadMessages();
                }, 1000);
            } else {
                showTelegramStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 'error');
            }
        }

        // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        async function checkTelegramVerification(uid) {
            const doc = await db.collection('verifiedUsers').doc(uid).get();
            if (doc.exists) {
                telegramUsername = doc.data().telegramUsername;
                showSection('chatSection');
                loadMessages();
            }
        }

        // üí¨ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages() {
            db.collection('chatMessages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `
                            <span class="author">${msg.author}:</span> ${msg.text}
                            <span style="float: right; color: #aaa; font-size: 12px;">
                                ${new Date(msg.timestamp?.toDate()).toLocaleTimeString()}
                            </span>
                        `;
                        messagesDiv.appendChild(div);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
        }

        // üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const user = auth.currentUser;
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!user || !text) return;

            const verificationDoc = await db.collection('verifiedUsers').doc(user.uid).get();
            if (!verificationDoc.exists) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ Telegram!');
                return;
            }

            await db.collection('chatMessages').add({
                text: text,
                author: verificationDoc.data().telegramUsername,
                userId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = '';
        }

        // üö™ –í—ã—Ö–æ–¥
        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                auth.signOut();
                document.getElementById('messages').innerHTML = '';
            }
        }

        // üìå –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showError(text, type = 'error') {
            const div = document.getElementById('authError');
            div.textContent = text;
            div.className = type;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 5000);
        }

        function showTelegramStatus(text, type) {
            const div = document.getElementById('telegramStatus');
            div.textContent = text;
            div.className = type;
            div.classList.remove('hidden');
        }
    </script>

    <!-- ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –¢–û–ö–ï–ù –ë–û–¢–ê! -->
    <script>
        console.log('‚ö†Ô∏è –ó–∞–º–µ–Ω–∏ TELEGRAM_BOT_TOKEN –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –æ—Ç @BotFather!');
    </script>
</body>
</html>