<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --text-primary: #1a1a1a;
            --text-secondary: #65676b;
            --accent: #e91e63;
            --accent-hover: #c2185b;
            --border: #e4e6eb;
            --my-message: #e91e63;
            --other-message: #e4e6eb;
            --my-text: white;
            --other-text: #1a1a1a;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --telegram-color: #0088cc;
            --radius: 20px;
            --radius-sm: 12px;
            --shadow: 0 4px 20px rgba(233, 30, 99, 0.15);
            --container-width: 900px;
        }

        .dark-theme {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2a;
            --bg-tertiary: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent: #ff4081;
            --accent-hover: #ff79b0;
            --border: #3a3a4a;
            --my-message: #ff4081;
            --other-message: #2a2a3a;
            --my-text: white;
            --other-text: #ffffff;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --telegram-color: #00aced;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        body {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* –í–µ—Ä—Å–∏—è –≤ —É–≥–ª—É */
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.5;
            z-index: 9999;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: var(--container-width);
            width: 100%;
            margin: 0 auto;
        }

        /* –®–∞–ø–∫–∞ */
        header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-secondary);
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            header {
                padding: 16px 20px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        @media (min-width: 768px) {
            .logo {
                font-size: 22px;
                gap: 12px;
            }
        }

        .logo-icon {
            color: var(--accent);
            font-size: 20px;
        }

        @media (min-width: 768px) {
            .logo-icon {
                font-size: 24px;
            }
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .logo-main {
            font-size: 16px;
        }

        @media (min-width: 768px) {
            .logo-main {
                font-size: 18px;
            }
        }

        .logo-sub {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: normal;
        }

        @media (min-width: 768px) {
            .logo-sub {
                font-size: 12px;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        @media (min-width: 768px) {
            .header-actions {
                gap: 12px;
            }
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .header-btn {
                font-size: 20px;
                width: 44px;
                height: 44px;
                padding: 10px;
            }
        }

        .header-btn:hover {
            background-color: var(--accent);
            color: white;
        }

        .notifications-btn {
            position: relative;
        }

        .notifications-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .auth-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .auth-screen {
                padding: 20px;
            }
        }

        .auth-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .auth-box {
                padding: 40px 32px;
            }
        }

        .auth-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .auth-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }

        @media (min-width: 768px) {
            .auth-tabs {
                margin-bottom: 30px;
            }
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .auth-tab {
                font-size: 16px;
                padding: 12px;
            }
        }

        .auth-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            margin-bottom: -2px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 20px;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
        }

        @media (min-width: 768px) {
            .form-control {
                padding: 14px 16px;
                font-size: 16px;
            }
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
            width: 100%;
        }

        @media (min-width: 768px) {
            .btn {
                padding: 14px 24px;
                font-size: 16px;
            }
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        /* –°–æ–≥–ª–∞—à–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ */
        .terms-container {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .terms-container {
                padding: 20px;
                margin: 20px 0;
                max-height: 400px;
            }
        }

        .terms-container h3 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 16px;
        }

        @media (min-width: 768px) {
            .terms-container h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .terms-container p {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .terms-container p {
                font-size: 14px;
                margin-bottom: 10px;
                line-height: 1.6;
            }
        }

        .terms-container ul, .terms-container ol {
            margin-left: 18px;
            margin-bottom: 12px;
        }

        @media (min-width: 768px) {
            .terms-container ul, .terms-container ol {
                margin-left: 20px;
                margin-bottom: 15px;
            }
        }

        .terms-container li {
            margin-bottom: 6px;
            line-height: 1.4;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .terms-container li {
                font-size: 14px;
                margin-bottom: 8px;
                line-height: 1.5;
            }
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 12px 0;
            text-align: left;
        }

        @media (min-width: 768px) {
            .terms-checkbox {
                margin: 15px 0;
                gap: 10px;
            }
        }

        .terms-checkbox input {
            margin-top: 3px;
        }

        .terms-checkbox label {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        @media (min-width: 768px) {
            .terms-checkbox label {
                font-size: 14px;
            }
        }

        /* –≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email */
        .verify-email-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        @media (min-width: 768px) {
            .verify-email-screen {
                padding: 20px;
            }
        }

        .verify-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .verify-box {
                padding: 40px 32px;
            }
        }

        .verify-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .verify-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .verify-box p {
            margin-bottom: 15px;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .verify-box p {
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 20px;
            }
        }

        .verify-icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .verify-icon {
                font-size: 60px;
                margin-bottom: 20px;
            }
        }

        /* –≠–∫—Ä–∞–Ω –∑–∞—è–≤–∫–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø */
        .application-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        @media (min-width: 768px) {
            .application-screen {
                padding: 20px;
            }
        }

        .application-box {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .application-box {
                padding: 40px 32px;
            }
        }

        .application-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .application-box h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }
        }

        .application-box p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .application-box p {
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 30px;
            }
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            margin-bottom: 15px;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .status-indicator {
                font-size: 14px;
                padding: 8px 16px;
                gap: 8px;
                margin-bottom: 20px;
            }
        }

        .status-indicator.verified {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        /* –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ */
        .chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--bg-primary);
        }

        .chat-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .chat-header {
                padding: 16px 20px;
            }
        }

        .chat-info h2 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        @media (min-width: 768px) {
            .chat-info h2 {
                font-size: 18px;
                margin-bottom: 4px;
            }
        }

        .chat-info p {
            color: var(--text-secondary);
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .chat-info p {
                font-size: 13px;
                gap: 8px;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (min-width: 768px) {
            .user-info {
                gap: 12px;
            }
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }

        .user-details {
            display: flex;
            flex-direction: column;
            max-width: 150px;
        }

        @media (min-width: 768px) {
            .user-details {
                max-width: 200px;
            }
        }

        .username {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .username {
                font-size: 15px;
            }
        }

        .status {
            font-size: 10px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .status {
                font-size: 12px;
                gap: 4px;
            }
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding-bottom: 90px;
        }

        @media (min-width: 768px) {
            .messages-container-wrapper {
                padding-bottom: 100px;
            }
        }

        .messages-container {
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 768px) {
            .messages-container {
                padding: 20px;
                gap: 16px;
            }
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: messageAppear 0.3s ease-out;
        }

        @media (min-width: 768px) {
            .message {
                max-width: 75%;
            }
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.my-message {
            align-self: flex-end;
            align-items: flex-end;
            margin-right: 5px;
        }

        @media (min-width: 768px) {
            .message.my-message {
                margin-right: 10px;
            }
        }

        .message.other-message {
            align-self: flex-start;
            align-items: flex-start;
            margin-left: 5px;
        }

        @media (min-width: 768px) {
            .message.other-message {
                margin-left: 10px;
            }
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: var(--radius);
            position: relative;
            word-wrap: break-word;
            min-width: 50px;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .message-bubble {
                padding: 14px 18px;
                min-width: 60px;
            }
        }

        .my-message .message-bubble {
            background-color: var(--my-message);
            color: var(--my-text);
            border-bottom-right-radius: 8px;
        }

        .other-message .message-bubble {
            background-color: var(--other-message);
            color: var(--other-text);
            border-bottom-left-radius: 8px;
        }

        .message-sender {
            font-size: 11px;
            margin-bottom: 4px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (min-width: 768px) {
            .message-sender {
                font-size: 12px;
                margin-bottom: 6px;
                gap: 6px;
            }
        }

        .message-time {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }

        @media (min-width: 768px) {
            .message-time {
                font-size: 11px;
                margin-top: 6px;
            }
        }

        .other-message .message-time {
            text-align: left;
        }

        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .message-text {
                font-size: 15px;
            }
        }

        /* –î–µ–π—Å—Ç–≤–∏—è —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ */
        .message-context-menu {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .message-context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: var(--bg-tertiary);
        }

        .context-menu-item.delete {
            color: var(--danger);
        }

        .context-menu-item.report {
            color: var(--warning);
        }

        /* –ö–Ω–æ–ø–∫–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è */
        .handshake-btn {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.2s;
            font-weight: 500;
            margin-top: 8px;
        }

        @media (min-width: 768px) {
            .handshake-btn {
                padding: 8px 16px;
                font-size: 14px;
                margin-top: 10px;
            }
        }

        .handshake-btn:hover {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.05);
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .message-input-container {
            position: fixed;
            bottom: 15px;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 12px 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            max-width: var(--container-width);
            margin: 0 auto;
            width: 100%;
        }

        @media (min-width: 768px) {
            .message-input-container {
                bottom: 30px;
                padding: 16px 20px;
                gap: 12px;
            }
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border);
            border-radius: 24px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            min-height: 48px;
            line-height: 1.4;
            white-space: pre-wrap;
            -webkit-appearance: none;
        }

        @media (min-width: 768px) {
            .message-input {
                padding: 14px 50px 14px 18px;
                font-size: 16px;
                max-height: 120px;
                min-height: 52px;
            }
        }

        .send-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .send-btn {
                width: 52px;
                height: 52px;
                font-size: 20px;
            }
        }

        .send-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        @media (min-width: 768px) {
            .modal {
                padding: 20px;
            }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            .modal-content {
                padding: 28px;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        @media (min-width: 768px) {
            .modal-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
        }

        .modal-header h2 {
            margin: 0;
            color: var(--accent);
            font-size: 20px;
        }

        @media (min-width: 768px) {
            .modal-header h2 {
                font-size: 24px;
            }
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .modal-close {
                font-size: 28px;
                width: 40px;
                height: 40px;
            }
        }

        .modal-close:hover {
            background-color: var(--bg-tertiary);
        }

        /* –¢–∞–±–ª–∏—Ü—ã */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .admin-table {
                margin: 20px 0;
                font-size: 14px;
            }
        }

        .admin-table th {
            background-color: var(--bg-tertiary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .admin-table th {
                padding: 12px;
            }
        }

        .admin-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            word-break: break-word;
        }

        @media (min-width: 768px) {
            .admin-table td {
                padding: 12px;
            }
        }

        .admin-table tr:hover {
            background-color: var(--bg-tertiary);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .action-buttons {
                gap: 8px;
            }
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .action-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .btn-sm {
                padding: 8px 16px;
                font-size: 14px;
            }
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin: 20px 0;
            }
        }

        .stat-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 20px;
            }
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            margin: 8px 0;
        }

        @media (min-width: 768px) {
            .stat-value {
                font-size: 36px;
                margin: 10px 0;
            }
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 14px;
            }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–∏ */
        .handshake-notification {
            background-color: var(--bg-tertiary);
            border-left: 4px solid var(--accent);
            padding: 12px;
            margin: 8px 0;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .handshake-notification {
                padding: 15px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .handshake-item {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .handshake-item {
                padding: 15px;
                margin: 10px 0;
            }
        }

        .handshake-info {
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .handshake-info {
                margin-bottom: 10px;
            }
        }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .contacts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        @media (min-width: 480px) {
            .contacts-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .contacts-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }
        }

        .contact-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 12px;
            border: 1px solid var(--border);
            position: relative;
        }

        @media (min-width: 768px) {
            .contact-card {
                padding: 15px;
            }
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .contact-header {
                gap: 10px;
                margin-bottom: 10px;
            }
        }

        .contact-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--telegram-color), #00aced);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .contact-avatar {
                width: 40px;
                height: 40px;
            }
        }

        .contact-details h4 {
            margin: 0 0 3px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .contact-details h4 {
                font-size: 14px;
                margin-bottom: 5px;
            }
        }

        .contact-telegram {
            color: var(--telegram-color);
            font-size: 11px;
        }

        @media (min-width: 768px) {
            .contact-telegram {
                font-size: 12px;
            }
        }

        .contact-time {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        @media (min-width: 768px) {
            .contact-time {
                font-size: 11px;
            }
        }

        .contact-expires {
            font-size: 11px;
            color: var(--warning);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .contact-expires {
                font-size: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
        }

        /* –ñ–∞–ª–æ–±—ã */
        .report-reason {
            font-size: 11px;
            color: var(--danger);
            background-color: rgba(255, 59, 48, 0.1);
            padding: 3px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        @media (min-width: 768px) {
            .report-reason {
                font-size: 12px;
                padding: 4px 8px;
                margin-left: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: var(--danger);
            background-color: rgba(255, 59, 48, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .error {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .success {
            color: var(--success);
            background-color: rgba(52, 199, 89, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .success {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        .info {
            color: var(--warning);
            background-color: rgba(255, 149, 0, 0.1);
            padding: 8px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 13px;
        }

        @media (min-width: 768px) {
            .info {
                padding: 10px;
                margin: 10px 0;
                font-size: 14px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (hover: none) and (pointer: coarse) {
            .header-btn:active {
                background-color: var(--accent);
                color: white;
            }
            
            .handshake-btn:active {
                background-color: var(--accent);
                color: white;
                border-color: var(--accent);
                transform: scale(0.98);
            }
            
            .send-btn:active {
                background-color: var(--accent-hover);
                transform: scale(0.98);
            }
            
            .action-btn:active {
                opacity: 0.8;
            }
        }

        /* –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .messages-container::-webkit-scrollbar {
            width: 5px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        @media (max-width: 480px) {
            .modal-content {
                padding: 15px;
                max-height: 85vh;
            }
            
            .modal-header h2 {
                font-size: 18px;
            }
            
            .modal-close {
                width: 32px;
                height: 32px;
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="light-theme">
    <!-- –ë–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏ -->
    <div class="version-badge">v.3.1</div>
    
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-user-secret logo-icon"></i>
                <div class="logo-text">
                    <div class="logo-main">–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞</div>
                    <div class="logo-sub">AnonChat</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn hidden" id="contactsBtn" title="–ö–æ–Ω—Ç–∞–∫—Ç—ã">
                    <i class="fas fa-address-book"></i>
                </button>
                <button class="header-btn hidden notifications-btn" id="notificationsBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    <i class="fas fa-bell"></i>
                    <span class="notifications-badge hidden" id="notificationsBadge">0</span>
                </button>
                <button class="header-btn hidden" id="profileBtn" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <i class="fas fa-user"></i>
                </button>
                <button class="header-btn hidden" id="adminBtn" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="auth-screen" id="authScreen">
                <div class="auth-box">
                    <h2>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</h2>
                    <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 14px;">
                        –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç —Å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è–º–∏
                    </p>
                    
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="loginTab">–í—Ö–æ–¥</button>
                        <button class="auth-tab" id="registerTab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                    <div id="loginForm">
                        <div class="form-group">
                            <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="loginEmail" class="form-control" 
                                   placeholder="–≤–∞—à@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="loginPassword" class="form-control" 
                                   placeholder="–ü–∞—Ä–æ–ª—å" required>
                        </div>
                        
                        <button class="btn btn-primary" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                        </button>
                        
                        <div id="authStatus"></div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                    <div id="registerForm" class="hidden">
                        <div class="form-group">
                            <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="registerEmail" class="form-control" 
                                   placeholder="–≤–∞—à@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="registerPassword" class="form-control" 
                                   placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword"><i class="fas fa-lock"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" id="confirmPassword" class="form-control" 
                                   placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                        </div>
                        
                        <div class="terms-container">
                            <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</h3>
                            <p><strong>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</strong> ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.</p>
                            <p><strong>1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:</strong></p>
                            <ul>
                                <li>–í —á–∞—Ç–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ "–ê–Ω–æ–Ω–∏–º #XXX"</li>
                                <li>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞—è–≤–∫—É</li>
                                <li>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞</li>
                                <li>–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç 18 –ª–µ—Ç</li>
                            </ul>
                            <p><strong>2. –ó–∞–ø—Ä–µ—â–µ–Ω–æ:</strong></p>
                            <ul>
                                <li>–°–ø–∞–º, —Ñ–ª—É–¥, —Ä–µ–∫–ª–∞–º–∞, —Ä–∞—Å—Å—ã–ª–∫–∞ —Å—Å—ã–ª–æ–∫</li>
                                <li>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑—ã, —Ç—Ä–∞–≤–ª—è, –±—É–ª–ª–∏–Ω–≥</li>
                                <li>–†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏, –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è –ø–æ –ª—é–±—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º</li>
                                <li>–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∞</li>
                                <li>–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, —Ñ–∏—à–∏–Ω–≥, –æ–±–º–∞–Ω</li>
                                <li>–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è</li>
                            </ul>
                            <p><strong>3. –°–∏—Å—Ç–µ–º–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π:</strong></p>
                            <ul>
                                <li>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ü§ù</li>
                                <li>–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏</li>
                                <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–±–º–µ–Ω–∞</li>
                            </ul>
                            <p><strong>4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:</strong></p>
                            <ul>
                                <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ø—Ä–∞–≤–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
                                <li>–í—Å–µ —Å–ø–æ—Ä–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ä–µ—à–∞—é—Ç—Å—è –≤ –ø–æ–ª—å–∑—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤</li>
                            </ul>
                            <p><strong>5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong></p>
                            <ul>
                                <li>–°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö</li>
                                <li>Telegram username –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π</li>
                                <li>Email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</li>
                                <li>IP-–∞–¥—Ä–µ—Å–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è</li>
                            </ul>
                        </div>
                        
                        <div class="terms-checkbox">
                            <input type="checkbox" id="agreeTerms" required>
                            <label for="agreeTerms">–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ –º–Ω–µ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç, –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º</label>
                        </div>
                        
                        <button class="btn btn-primary" id="registerBtn">
                            <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                        
                        <div id="registerStatus"></div>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email -->
            <div class="verify-email-screen hidden" id="verifyEmailScreen">
                <div class="verify-box">
                    <div class="verify-icon">
                        <i class="fas fa-envelope-circle-check"></i>
                    </div>
                    <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à Email</h2>
                    <p>
                        –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –Ω–∞ –∞–¥—Ä–µ—Å<br>
                        <strong id="verifyEmailAddress">email@example.com</strong>
                    </p>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 25px;">
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ –ø–∏—Å—å–º–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                    </p>
                    
                    <button class="btn btn-primary" id="resendVerifyBtn" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    </button>
                    
                    <button class="btn" id="checkVerifyBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-check-circle"></i> –Ø –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª email
                    </button>
                    
                    <button class="btn" id="logoutFromVerifyBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </button>
                    
                    <div id="verifyStatus"></div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –∑–∞—è–≤–∫–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø -->
            <div class="application-screen hidden" id="applicationScreen">
                <div class="application-box">
                    <h2>–ó–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É</h2>
                    <p>
                        –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–Ω–æ–Ω–∏–º–Ω–æ–º—É —á–∞—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞—è–≤–∫—É.<br>
                        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –µ—ë –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
                    </p>
                    
                    <div class="status-indicator" id="applicationStatus">
                        <i class="fas fa-clock"></i> –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                    </div>
                    
                    <div class="form-group">
                        <label for="telegramUsername">
                            <i class="fab fa-telegram" style="color: var(--telegram-color);"></i> 
                            –í–∞—à Telegram username
                        </label>
                        <input type="text" id="telegramUsername" class="form-control" 
                               placeholder="@username (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å @)" required>
                        <small style="color: var(--text-secondary); display: block; margin-top: 6px; font-size: 12px;">
                            –≠—Ç–æ—Ç username –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å–≤—è–∑–∏ –ø—Ä–∏ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–∏. –ö–∞–∂–¥—ã–π Telegram –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–µ.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="applicationNote">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="applicationNote" class="form-control" 
                                  placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ..." 
                                  rows="3"></textarea>
                    </div>
                    
                    <div class="handshake-notification">
                        <i class="fas fa-handshake" style="color: var(--accent); margin-right: 6px;"></i>
                        –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è –≤ —á–∞—Ç–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º. –†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏.
                    </div>
                    
                    <button class="btn btn-primary" id="submitApplicationBtn">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                    
                    <button class="btn" id="logoutFromAppBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </button>
                    
                    <div id="applicationStatusMessage"></div>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
            <div class="chat-screen hidden" id="chatScreen">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h2>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç "–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞"</h2>
                            <p>
                                <i class="fas fa-users"></i>
                                <span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω ‚Ä¢ 
                                <i class="fas fa-clock"></i>
                                –°–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
                            </p>
                        </div>
                        <div class="user-info">
                            <div class="user-avatar" id="userAvatar">–ê</div>
                            <div class="user-details">
                                <div class="username" id="displayUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                <div class="status">
                                    <i class="fas fa-circle"></i> <span id="userStatus">–û–Ω–ª–∞–π–Ω</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="messages-container-wrapper">
                        <div class="messages-container" id="messagesContainer">
                            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                        </div>
                    </div>

                    <div class="message-input-container">
                        <div class="message-input-wrapper">
                            <textarea class="message-input" id="messageInput" 
                                      placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"
                                      rows="1"></textarea>
                        </div>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item delete" id="contextDelete">
            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </div>
        <div class="context-menu-item report" id="contextReport">
            <i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
        </div>
        <div class="context-menu-item" id="contextClose">
            <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <button class="modal-close" id="closeProfileBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" style="width: 70px; height: 70px; margin: 0 auto 12px; font-size: 28px;" id="profileAvatar">
                        –ê
                    </div>
                    <h3 id="profileName" style="font-size: 18px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;" id="profileEmail">
                        email@example.com
                    </p>
                    <div id="profileStatus" class="status-indicator" style="margin-top: 10px;">
                        <i class="fas fa-clock"></i> –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                    </div>
                    <p style="color: var(--text-secondary); font-size: 11px; margin-top: 5px;">
                        ID: <span id="profileUserId">000</span>
                    </p>
                    <p style="color: var(--telegram-color); font-size: 13px; margin-top: 8px;">
                        <i class="fab fa-telegram"></i> 
                        <span id="profileTelegram">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                    </p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn" id="logoutBtn" style="background: var(--danger); color: white; padding: 10px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div class="modal" id="contactsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã (24 —á–∞—Å–∞)</h2>
                <button class="modal-close" id="closeContactsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="contactsContainer">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 15px;">
                    –ö–æ–Ω—Ç–∞–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞ —Å –º–æ–º–µ–Ω—Ç–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è, –ø–æ—Å–ª–µ —á–µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è.
                </p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="modal" id="notificationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <button class="modal-close" id="closeNotificationsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notificationsContainer">
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
                <button class="modal-close" id="closeAdminBtn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="stats-grid" id="adminStats">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
                        <div class="stat-value" id="onlineUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ó–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
                        <div class="stat-value" id="pendingApplications">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ñ–∞–ª–æ–± –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
                        <div class="stat-value" id="pendingReports">0</div>
                    </div>
                </div>

                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ -->
                <div style="display: flex; gap: 8px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="btn btn-sm" id="adminTabApplications" style="background-color: var(--accent); color: white;">–ó–∞—è–≤–∫–∏</button>
                    <button class="btn btn-sm" id="adminTabApproved" style="background: var(--bg-tertiary);">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</button>
                    <button class="btn btn-sm" id="adminTabBanned" style="background: var(--bg-tertiary);">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</button>
                    <button class="btn btn-sm" id="adminTabReports" style="background: var(--bg-tertiary);">–ñ–∞–ª–æ–±—ã</button>
                    <button class="btn btn-sm" id="adminTabAdmins" style="background: var(--bg-tertiary);">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</button>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞—è–≤–æ–∫ -->
                <div id="adminApplicationsTab">
                    <h3 style="font-size: 18px;">–ó–∞—è–≤–∫–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø</h3>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>–ó–∞–º–µ—Ç–∫–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTable">
                                <!-- –ó–∞—è–≤–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö -->
                <div id="adminApprovedTab" class="hidden">
                    <h3 style="font-size: 18px;">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>–î–∞—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTable">
                                <!-- –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö -->
                <div id="adminBannedTab" class="hidden">
                    <h3 style="font-size: 18px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Telegram</th>
                                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                                    <th>–î–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="bannedTable">
                                <!-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –∂–∞–ª–æ–± -->
                <div id="adminReportsTab" class="hidden">
                    <h3 style="font-size: 18px;">–ñ–∞–ª–æ–±—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>–ñ–∞–ª–æ–±–∞ –æ—Ç</th>
                                    <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <!-- –ñ–∞–ª–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ -->
                <div id="adminAdminsTab" class="hidden">
                    <h3 style="font-size: 18px;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</h3>
                    <div class="form-group" style="margin-top: 12px;">
                        <label for="addAdminEmail" style="font-size: 13px;">–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="email" id="addAdminEmail" class="form-control" 
                                   placeholder="email@example.com" style="flex: 1;">
                            <button class="btn btn-success btn-sm" id="addAdminBtn">
                                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <div style="overflow-x: auto; margin-top: 12px;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTable">
                                <!-- –ê–¥–º–∏–Ω—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è -->
    <div class="modal" id="confirmHandshakeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è</h2>
                <button class="modal-close" id="closeConfirmHandshakeBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="handshakeConfirmInfo">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" id="confirmHandshakeBtn">
                        <i class="fas fa-handshake"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ
                    </button>
                    <button class="btn" id="cancelHandshakeBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∂–∞–ª–æ–±—ã -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                <button class="modal-close" id="closeReportBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-size: 14px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É:</label>
                    <select id="reportReason" class="form-control">
                        <option value="spam">–°–ø–∞–º –∏–ª–∏ —Ä–µ–∫–ª–∞–º–∞</option>
                        <option value="insult">–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏–ª–∏ —É–≥—Ä–æ–∑—ã</option>
                        <option value="hate">–†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏</option>
                        <option value="illegal">–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
                        <option value="fraud">–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDetails" style="font-size: 14px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea id="reportDetails" class="form-control" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ..."></textarea>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-danger" id="submitReportBtn">
                        <i class="fas fa-flag"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É
                    </button>
                    <button class="btn" id="cancelReportBtn" style="background: var(--bg-tertiary);">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA-dQ8-cqE7y9VfNA3fPLF6hDO-s1OfQ4Q",
            authDomain: "neznakomka.firebaseapp.com",
            projectId: "neznakomka",
            storageBucket: "neznakomka.firebasestorage.app",
            messagingSenderId: "245961594712",
            appId: "1:245961594712:web:e1c8ba71af1289b1bc372d",
            measurementId: "G-QJ2Q13VB4T"
        };

        // === –°–û–°–¢–û–Ø–ù–ò–ï ===
        const state = {
            user: null,
            userData: null,
            isAdmin: false,
            isVerified: false,
            emailVerified: false,
            messages: [],
            onlineUsers: [],
            theme: 'light',
            pendingHandshakeTarget: null,
            reportTargetMessage: null,
            contextMenu: {
                active: false,
                messageId: null,
                messageElement: null,
                isMyMessage: false,
                x: 0,
                y: 0
            },
            touchTimer: null,
            isTouchDevice: false,
            currentAdminTab: 'applications',
            hasAcceptedTerms: false
        };

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ===
        let auth, db;

        function initFirebase() {
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                
                state.isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        state.user = user;
                        state.emailVerified = user.emailVerified;
                        
                        if (!user.emailVerified) {
                            showVerifyEmailScreen();
                        } else {
                            await loadUserData();
                            
                            if (state.userData) {
                                if (!state.hasAcceptedTerms) {
                                    showTermsAgreement();
                                } else {
                                    continueAfterTerms();
                                }
                            }
                        }
                    } else {
                        resetState();
                        showAuthScreen();
                    }
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ Firebase:", error);
            }
        }

        function resetState() {
            state.user = null;
            state.userData = null;
            state.isAdmin = false;
            state.isVerified = false;
            state.emailVerified = false;
            state.messages = [];
            state.onlineUsers = [];
            state.pendingHandshakeTarget = null;
            state.reportTargetMessage = null;
            state.hasAcceptedTerms = false;
        }

        async function continueAfterTerms() {
            if (!state.userData) return;
            
            if (state.userData.isBanned) {
                alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                await handleLogout();
                return;
            }
            
            if (state.userData.isVerified) {
                state.isVerified = true;
                showChatScreen();
                loadMessages();
                loadNotifications();
                loadContacts();
            } else {
                showApplicationScreen();
                checkApplicationStatus();
            }
        }

        async function loadUserData() {
            if (!state.user || !db) return;
            
            try {
                const userRef = db.collection('users').doc(state.user.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    state.userData = doc.data();
                    
                    state.hasAcceptedTerms = state.userData.hasAcceptedTerms || false;
                    
                    if (state.userData.isAdmin) {
                        state.isAdmin = true;
                        if (document.getElementById('adminBtn')) {
                            document.getElementById('adminBtn').classList.remove('hidden');
                        }
                    }
                    
                    updateProfileUI();
                    
                } else {
                    state.userData = {
                        email: state.user.email,
                        isAdmin: state.user.email === 'sad.spotty@gmail.com',
                        isVerified: false,
                        emailVerified: true,
                        telegramUsername: null,
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        online: true,
                        anonymousId: generateAnonymousId(),
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        hasAcceptedTerms: false
                    };
                    
                    await userRef.set(state.userData);
                }
                
                await userRef.update({
                    lastSeen: new Date().toISOString(),
                    online: true
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
            }
        }

        function showTermsAgreement() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
            
            const html = `
                <div class="auth-screen">
                    <div class="auth-box">
                        <div class="verify-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</h2>
                        
                        <div class="terms-container" style="max-height: 50vh;">
                            <h3>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat) ‚Äî –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
                            <p><strong>1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:</strong></p>
                            <ul>
                                <li>–í —á–∞—Ç–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ "–ê–Ω–æ–Ω–∏–º #XXX"</li>
                                <li>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞—è–≤–∫—É</li>
                                <li>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞</li>
                                <li>–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç 18 –ª–µ—Ç</li>
                            </ul>
                            <p><strong>2. –ó–∞–ø—Ä–µ—â–µ–Ω–æ:</strong></p>
                            <ul>
                                <li>–°–ø–∞–º, —Ñ–ª—É–¥, —Ä–µ–∫–ª–∞–º–∞, —Ä–∞—Å—Å—ã–ª–∫–∞ —Å—Å—ã–ª–æ–∫</li>
                                <li>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑—ã, —Ç—Ä–∞–≤–ª—è, –±—É–ª–ª–∏–Ω–≥</li>
                                <li>–†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏, –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è –ø–æ –ª—é–±—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º</li>
                                <li>–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∞</li>
                                <li>–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, —Ñ–∏—à–∏–Ω–≥, –æ–±–º–∞–Ω</li>
                                <li>–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è</li>
                            </ul>
                            <p><strong>3. –°–∏—Å—Ç–µ–º–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π:</strong></p>
                            <ul>
                                <li>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ü§ù</li>
                                <li>–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏</li>
                                <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–±–º–µ–Ω–∞</li>
                            </ul>
                            <p><strong>4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:</strong></p>
                            <ul>
                                <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ø—Ä–∞–≤–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
                                <li>–í—Å–µ —Å–ø–æ—Ä–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ä–µ—à–∞—é—Ç—Å—è –≤ –ø–æ–ª—å–∑—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</li>
                                <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤</li>
                            </ul>
                            <p><strong>5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong></p>
                            <ul>
                                <li>–°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö</li>
                                <li>Telegram username –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π</li>
                                <li>Email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</li>
                                <li>IP-–∞–¥—Ä–µ—Å–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è</li>
                            </ul>
                        </div>
                        
                        <div class="terms-checkbox">
                            <input type="checkbox" id="agreeTermsModal" required>
                            <label for="agreeTermsModal">–ú–Ω–µ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç, —è –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º</label>
                        </div>
                        
                        <button class="btn btn-primary" id="acceptTermsBtn">
                            <i class="fas fa-check-circle"></i> –ü—Ä–∏–Ω—è—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                        
                        <button class="btn" id="rejectTermsBtn" style="margin-top: 10px; background: var(--bg-tertiary);">
                            <i class="fas fa-times"></i> –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –∏ –≤—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.innerHTML = html;
                
                document.getElementById('acceptTermsBtn').addEventListener('click', acceptTerms);
                document.getElementById('rejectTermsBtn').addEventListener('click', rejectTerms);
            }
        }

        async function acceptTerms() {
            const checkbox = document.getElementById('agreeTermsModal');
            if (!checkbox.checked) {
                alert('–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏');
                return;
            }
            
            const acceptBtn = document.getElementById('acceptTermsBtn');
            acceptBtn.disabled = true;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ...';
            
            try {
                if (state.user && state.user.uid && db) {
                    await db.collection('users').doc(state.user.uid).update({
                        hasAcceptedTerms: true,
                        termsAcceptedAt: new Date().toISOString()
                    });
                    
                    state.hasAcceptedTerms = true;
                    state.userData.hasAcceptedTerms = true;
                }
                
                await continueAfterTerms();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è:", error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } finally {
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ü—Ä–∏–Ω—è—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            }
        }

        async function rejectTerms() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è? –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –≤—ã—Ö–æ–¥—É –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.')) {
                await handleLogout();
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const agreeTerms = document.getElementById('agreeTerms');
            
            if (!email || !password || !confirmPassword) {
                showRegisterError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (password !== confirmPassword) {
                showRegisterError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            if (password.length < 6) {
                showRegisterError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (!agreeTerms || !agreeTerms.checked) {
                showRegisterError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ');
                return;
            }
            
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.sendEmailVerification();
                
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    isAdmin: user.email === 'sad.spotty@gmail.com',
                    isVerified: false,
                    emailVerified: false,
                    telegramUsername: null,
                    createdAt: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    online: true,
                    anonymousId: generateAnonymousId(),
                    isBanned: false,
                    hasAcceptedTerms: true,
                    termsAcceptedAt: new Date().toISOString()
                });
                
                showRegisterSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
                
                document.getElementById('verifyEmailAddress').textContent = email;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                
                let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. ';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
                        break;
                    case 'auth/weak-password':
                        errorMessage = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showRegisterError(errorMessage);
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –í—Ö–æ–¥...';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:", email);
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
                
                let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. ';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAuthError(errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏';
            }
        }

        function showAuthScreen() {
            const screens = ['authScreen', 'verifyEmailScreen', 'applicationScreen', 'chatScreen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) element.classList.add('hidden');
            });
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="auth-screen" id="authScreen">
                        <div class="auth-box">
                            <h2>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</h2>
                            <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 14px;">
                                –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç —Å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è–º–∏
                            </p>
                            
                            <div class="auth-tabs">
                                <button class="auth-tab active" id="loginTab">–í—Ö–æ–¥</button>
                                <button class="auth-tab" id="registerTab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                            </div>
                            
                            <div id="loginForm">
                                <div class="form-group">
                                    <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                                    <input type="email" id="loginEmail" class="form-control" 
                                           placeholder="–≤–∞—à@email.com" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="loginPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="loginPassword" class="form-control" 
                                           placeholder="–ü–∞—Ä–æ–ª—å" required>
                                </div>
                                
                                <button class="btn btn-primary" id="loginBtn">
                                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                                </button>
                                
                                <div id="authStatus"></div>
                            </div>
                            
                            <div id="registerForm" class="hidden">
                                <div class="form-group">
                                    <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                                    <input type="email" id="registerEmail" class="form-control" 
                                           placeholder="–≤–∞—à@email.com" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="registerPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="registerPassword" class="form-control" 
                                           placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword"><i class="fas fa-lock"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="confirmPassword" class="form-control" 
                                           placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                                </div>
                                
                                <div class="terms-container">
                                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</h3>
                                    <p><strong>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</strong> ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.</p>
                                    <p><strong>1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:</strong></p>
                                    <ul>
                                        <li>–í —á–∞—Ç–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ "–ê–Ω–æ–Ω–∏–º #XXX"</li>
                                        <li>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞—è–≤–∫—É</li>
                                        <li>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞</li>
                                        <li>–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç 18 –ª–µ—Ç</li>
                                    </ul>
                                    <p><strong>2. –ó–∞–ø—Ä–µ—â–µ–Ω–æ:</strong></p>
                                    <ul>
                                        <li>–°–ø–∞–º, —Ñ–ª—É–¥, —Ä–µ–∫–ª–∞–º–∞, —Ä–∞—Å—Å—ã–ª–∫–∞ —Å—Å—ã–ª–æ–∫</li>
                                        <li>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑—ã, —Ç—Ä–∞–≤–ª—è, –±—É–ª–ª–∏–Ω–≥</li>
                                        <li>–†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏, –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è –ø–æ –ª—é–±—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º</li>
                                        <li>–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∞</li>
                                        <li>–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, —Ñ–∏—à–∏–Ω–≥, –æ–±–º–∞–Ω</li>
                                        <li>–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è</li>
                                    </ul>
                                    <p><strong>3. –°–∏—Å—Ç–µ–º–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π:</strong></p>
                                    <ul>
                                        <li>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ü§ù</li>
                                        <li>–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏</li>
                                        <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è</li>
                                        <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</li>
                                        <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–±–º–µ–Ω–∞</li>
                                    </ul>
                                    <p><strong>4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:</strong></p>
                                    <ul>
                                        <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</li>
                                        <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ø—Ä–∞–≤–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
                                        <li>–í—Å–µ —Å–ø–æ—Ä–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ä–µ—à–∞—é—Ç—Å—è –≤ –ø–æ–ª—å–∑—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</li>
                                        <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤</li>
                                    </ul>
                                    <p><strong>5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong></p>
                                    <ul>
                                        <li>–°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö</li>
                                        <li>Telegram username –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π</li>
                                        <li>Email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</li>
                                        <li>IP-–∞–¥—Ä–µ—Å–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è</li>
                                    </ul>
                                </div>
                                
                                <div class="terms-checkbox">
                                    <input type="checkbox" id="agreeTerms" required>
                                    <label for="agreeTerms">–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ –º–Ω–µ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç, –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º</label>
                                </div>
                                
                                <button class="btn btn-primary" id="registerBtn">
                                    <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                                </button>
                                
                                <div id="registerStatus"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                initAuthEventListeners();
            }
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
        }

        function showChatScreen() {
            const screens = ['authScreen', 'verifyEmailScreen', 'applicationScreen', 'chatScreen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) element.classList.add('hidden');
            });
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="chat-screen" id="chatScreen">
                        <div class="chat-container">
                            <div class="chat-header">
                                <div class="chat-info">
                                    <h2>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç "–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞"</h2>
                                    <p>
                                        <i class="fas fa-users"></i>
                                        <span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω ‚Ä¢ 
                                        <i class="fas fa-clock"></i>
                                        –°–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
                                    </p>
                                </div>
                                <div class="user-info">
                                    <div class="user-avatar" id="userAvatar">–ê</div>
                                    <div class="user-details">
                                        <div class="username" id="displayUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                        <div class="status">
                                            <i class="fas fa-circle"></i> <span id="userStatus">–û–Ω–ª–∞–π–Ω</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="messages-container-wrapper">
                                <div class="messages-container" id="messagesContainer">
                                </div>
                            </div>

                            <div class="message-input-container">
                                <div class="message-input-wrapper">
                                    <textarea class="message-input" id="messageInput" 
                                              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"
                                              rows="1"></textarea>
                                </div>
                                <button class="send-btn" id="sendBtn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                updateProfileUI();
                loadMessages();
                initChatEventListeners();
            }
            
            if (document.getElementById('contactsBtn')) {
                document.getElementById('contactsBtn').classList.remove('hidden');
            }
            if (document.getElementById('notificationsBtn')) {
                document.getElementById('notificationsBtn').classList.remove('hidden');
            }
            if (document.getElementById('profileBtn')) {
                document.getElementById('profileBtn').classList.remove('hidden');
            }
            
            if (state.isAdmin && document.getElementById('adminBtn')) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
        }

        function updateProfileUI() {
            if (!state.userData) return;
            
            const profileName = document.getElementById('profileName');
            if (profileName) {
                profileName.textContent = state.userData.email.split('@')[0];
            }
            
            const profileEmail = document.getElementById('profileEmail');
            if (profileEmail) {
                profileEmail.textContent = state.userData.email;
            }
            
            const profileUserId = document.getElementById('profileUserId');
            if (profileUserId) {
                profileUserId.textContent = state.user.uid.substring(0, 8);
            }
            
            const profileTelegram = document.getElementById('profileTelegram');
            if (profileTelegram) {
                profileTelegram.textContent = state.userData.telegramUsername || '–ù–µ —É–∫–∞–∑–∞–Ω';
            }
            
            const statusIndicator = document.getElementById('profileStatus');
            if (statusIndicator) {
                if (state.userData.isVerified) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    statusIndicator.classList.add('verified');
                } else if (state.userData.application) {
                    statusIndicator.innerHTML = '<i class="fas fa-clock"></i> –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏';
                    statusIndicator.classList.remove('verified');
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-clock"></i> –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    statusIndicator.classList.remove('verified');
                }
            }
            
            const avatar = document.getElementById('profileAvatar');
            if (avatar) {
                const initial = state.userData.email[0].toUpperCase();
                avatar.textContent = initial;
            }
            
            const displayUsername = document.getElementById('displayUsername');
            if (displayUsername) {
                displayUsername.textContent = state.userData.email.split('@')[0];
            }
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                const initial = state.userData.email[0].toUpperCase();
                userAvatar.textContent = initial;
            }
        }

        function initAuthEventListeners() {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginTab && registerTab && loginForm && registerForm) {
                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });
                
                registerTab.addEventListener('click', () => {
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });
                
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', handleLogin);
                }
                
                if (registerBtn) {
                    registerBtn.addEventListener('click', handleRegister);
                }
            }
        }

        function initChatEventListeners() {
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, state.isTouchDevice ? 100 : 120) + 'px';
                    this.style.overflowY = this.scrollHeight > (state.isTouchDevice ? 100 : 120) ? 'auto' : 'hidden';
                });
            }
        }

        async function resendVerificationEmail() {
            if (!state.user) return;
            
            const resendBtn = document.getElementById('resendVerifyBtn');
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                await state.user.sendEmailVerification();
                showVerifySuccess('–ü–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É.');
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:", error);
                showVerifyError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ';
            }
        }

        async function checkEmailVerification() {
            if (!state.user) return;
            
            const checkBtn = document.getElementById('checkVerifyBtn');
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                await state.user.reload();
                
                if (state.user.emailVerified) {
                    state.emailVerified = true;
                    showVerifySuccess('Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...');
                    
                    setTimeout(async () => {
                        await loadUserData();
                    }, 1500);
                } else {
                    showVerifyError('Email –µ—â–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É.');
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email:", error);
                showVerifyError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerHTML = '<i class="fas fa-check-circle"></i> –Ø –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª email';
            }
        }

        async function checkTelegramUsernameUnique(username) {
            if (!db) return true;
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('telegramUsername', '==', username)
                    .where('isVerified', '==', true)
                    .limit(1)
                    .get();
                
                return usersSnapshot.empty;
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ username:", error);
                return true;
            }
        }

        async function submitApplication() {
            const telegramUsername = document.getElementById('telegramUsername').value.trim();
            const note = document.getElementById('applicationNote').value.trim();
            
            if (!telegramUsername || !telegramUsername.startsWith('@')) {
                showApplicationError('–í–≤–µ–¥–∏—Ç–µ Telegram username –≤ —Ñ–æ—Ä–º–∞—Ç–µ @username');
                return;
            }
            
            const isUnique = await checkTelegramUsernameUnique(telegramUsername);
            if (!isUnique) {
                showApplicationError('–≠—Ç–æ—Ç Telegram username —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π.');
                return;
            }
            
            const submitBtn = document.getElementById('submitApplicationBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                const applicationData = {
                    telegramUsername,
                    note,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                    userId: state.user.uid,
                    userEmail: state.user.email
                };
                
                await db.collection('users').doc(state.user.uid).update({
                    application: applicationData,
                    telegramUsername: telegramUsername,
                    isVerified: false
                });
                
                state.userData.application = applicationData;
                state.userData.telegramUsername = telegramUsername;
                
                await db.collection('applications').add({
                    ...applicationData,
                    reviewedBy: null,
                    reviewedAt: null
                });
                
                showApplicationSuccess('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ!');
                updateApplicationStatusUI();
                updateProfileUI();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:", error);
                showApplicationError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            }
        }

        function updateApplicationStatusUI() {
            if (!state.userData || !state.userData.application) return;
            
            const statusElement = document.getElementById('applicationStatus');
            if (statusElement) {
                if (state.userData.isVerified) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞';
                    statusElement.classList.add('verified');
                } else {
                    statusElement.innerHTML = '<i class="fas fa-clock"></i> –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏';
                    statusElement.classList.remove('verified');
                }
            }
        }

        async function checkApplicationStatus() {
            if (!state.user || !db || !state.userData) return;
            
            try {
                const userRef = db.collection('users').doc(state.user.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    const userData = doc.data();
                    state.userData = userData;
                    
                    if (userData.isVerified) {
                        state.isVerified = true;
                        showChatScreen();
                        loadMessages();
                        loadNotifications();
                        loadContacts();
                        updateApplicationStatusUI();
                    } else {
                        showApplicationScreen();
                        updateApplicationStatusUI();
                    }
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:", error);
            }
        }

        function showVerifyEmailScreen() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.getElementById('verifyEmailScreen').classList.remove('hidden');
            
            if (state.user) {
                document.getElementById('verifyEmailAddress').textContent = state.user.email;
            }
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
        }

        function showApplicationScreen() {
            document.querySelectorAll('.auth-screen, .verify-email-screen, .application-screen, .chat-screen').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.getElementById('applicationScreen').classList.remove('hidden');
            
            document.querySelectorAll('.header-actions .header-btn').forEach(btn => {
                if (!btn.classList.contains('theme-toggle')) {
                    btn.classList.add('hidden');
                }
            });
            
            updateApplicationStatusUI();
        }

        async function handleLogout() {
            try {
                if (state.user && db) {
                    const userRef = db.collection('users').doc(state.user.uid);
                    await userRef.update({
                        online: false,
                        lastSeen: new Date().toISOString()
                    });
                }
                
                await auth.signOut();
                
                resetState();
                showAuthScreen();
                
                const modals = document.querySelectorAll('.modal.active');
                modals.forEach(modal => modal.classList.remove('active'));
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        function loadMessages() {
            if (!db || !state.isVerified) return;
            
            document.getElementById('messagesContainer').innerHTML = '';
            
            db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    const messagesContainer = document.getElementById('messagesContainer');
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            message.id = change.doc.id;
                            addMessageToUI(message);
                        } else if (change.type === 'removed') {
                            const messageElement = document.querySelector(`[data-message-id="${change.doc.id}"]`);
                            if (messageElement) {
                                messageElement.remove();
                            }
                        }
                    });
                    
                    scrollToBottom();
                });
        }

        function addMessageToUI(message) {
            if (message.deleted) return;
            
            const messageElement = document.createElement('div');
            const isMyMessage = message.userId === state.user.uid;
            
            messageElement.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            messageElement.setAttribute('data-message-id', message.id);
            
            const time = message.timestamp?.toDate 
                ? message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const displayName = isMyMessage ? '–í—ã' : `–ê–Ω–æ–Ω–∏–º #${message.anonymousId || '000'}`;
            
            const handshakeButton = !isMyMessage && state.userData && state.userData.telegramUsername ? `
                <button class="handshake-btn" onclick="offerHandshakeConfirm(${message.anonymousId}, '${message.userId}', '${message.userEmail}')">
                    <i class="fas fa-handshake"></i> –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ
                </button>
            ` : '';
            
            messageElement.innerHTML = `
                <div class="message-sender">
                    <i class="fas ${isMyMessage ? 'fa-user' : 'fa-user-secret'}"></i> 
                    ${displayName}
                </div>
                <div class="message-bubble">
                    <div class="message-text">${formatMessageText(message.text)}</div>
                    <div class="message-time">${time}</div>
                </div>
                ${handshakeButton}
            `;
            
            setupMessageContextMenu(messageElement, message, isMyMessage);
            
            const container = document.getElementById('messagesContainer');
            container.appendChild(messageElement);
        }

        function setupMessageContextMenu(messageElement, message, isMyMessage) {
            const messageBubble = messageElement.querySelector('.message-bubble');
            
            messageBubble.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, message, isMyMessage, messageElement);
            });
            
            messageBubble.addEventListener('touchstart', (e) => {
                if (state.touchTimer) clearTimeout(state.touchTimer);
                
                state.touchTimer = setTimeout(() => {
                    e.preventDefault();
                    const touch = e.touches[0] || e.changedTouches[0];
                    showMessageContextMenu(touch, message, isMyMessage, messageElement);
                }, 2500);
            }, { passive: true });
            
            messageBubble.addEventListener('touchend', () => {
                if (state.touchTimer) {
                    clearTimeout(state.touchTimer);
                    state.touchTimer = null;
                }
            });
            
            messageBubble.addEventListener('touchmove', () => {
                if (state.touchTimer) {
                    clearTimeout(state.touchTimer);
                    state.touchTimer = null;
                }
            });
        }

        function showMessageContextMenu(e, message, isMyMessage, messageElement) {
            if (state.contextMenu.active) {
                hideMessageContextMenu();
                return;
            }
            
            state.contextMenu = {
                active: true,
                messageId: message.id,
                messageElement: messageElement,
                isMyMessage: isMyMessage,
                x: e.clientX || e.pageX,
                y: e.clientY || e.pageY
            };
            
            const contextMenu = document.getElementById('messageContextMenu');
            contextMenu.classList.add('active');
            
            const menuWidth = 150;
            const menuHeight = 120;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let x = state.contextMenu.x;
            let y = state.contextMenu.y;
            
            if (x + menuWidth > windowWidth) {
                x = windowWidth - menuWidth - 10;
            }
            
            if (y + menuHeight > windowHeight) {
                y = windowHeight - menuHeight - 10;
            }
            
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            
            const deleteItem = document.getElementById('contextDelete');
            const reportItem = document.getElementById('contextReport');
            
            if (isMyMessage) {
                deleteItem.style.display = 'flex';
                reportItem.style.display = 'none';
            } else {
                deleteItem.style.display = state.isAdmin ? 'flex' : 'none';
                reportItem.style.display = 'flex';
            }
        }

        function hideMessageContextMenu() {
            state.contextMenu.active = false;
            document.getElementById('messageContextMenu').classList.remove('active');
        }

        async function deleteMessage() {
            if (!state.contextMenu.messageId || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                hideMessageContextMenu();
                return;
            }
            
            try {
                await db.collection('messages').doc(state.contextMenu.messageId).update({
                    deleted: true,
                    deletedAt: new Date().toISOString(),
                    deletedBy: state.user.email
                });
                
                hideMessageContextMenu();
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                hideMessageContextMenu();
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        async function adminDeleteMessage() {
            if (!state.contextMenu.messageId || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä?')) {
                hideMessageContextMenu();
                return;
            }
            
            try {
                await db.collection('messages').doc(state.contextMenu.messageId).delete();
                hideMessageContextMenu();
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                hideMessageContextMenu();
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        function reportMessage() {
            if (!state.contextMenu.messageId) {
                hideMessageContextMenu();
                return;
            }
            
            state.reportTargetMessage = state.contextMenu.messageId;
            hideMessageContextMenu();
            document.getElementById('reportModal').classList.add('active');
        }

        async function submitReport() {
            if (!state.reportTargetMessage) return;
            
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value.trim();
            
            try {
                const reportData = {
                    messageId: state.reportTargetMessage,
                    reason: reason,
                    details: details,
                    reporterId: state.user.uid,
                    reporterEmail: state.user.email,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('reports').add(reportData);
                
                document.getElementById('reportModal').classList.remove('active');
                state.reportTargetMessage = null;
                document.getElementById('reportReason').value = 'spam';
                document.getElementById('reportDetails').value = '';
                
                alert('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã:", error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã');
            }
        }

        async function loadNotifications() {
            if (!state.user || !db) return;
            
            const notificationsRef = db.collection('notifications')
                .where('userId', '==', state.user.uid)
                .orderBy('createdAt', 'desc')
                .limit(20);
            
            notificationsRef.onSnapshot((snapshot) => {
                const notificationsContainer = document.getElementById('notificationsContainer');
                const badge = document.getElementById('notificationsBadge');
                
                if (!notificationsContainer) return;
                
                notificationsContainer.innerHTML = '';
                let unreadCount = 0;
                
                snapshot.forEach(doc => {
                    const notification = doc.data();
                    notification.id = doc.id;
                    
                    const notificationElement = document.createElement('div');
                    notificationElement.className = 'handshake-item';
                    notificationElement.style.opacity = notification.read ? '0.7' : '1';
                    
                    let actionButtons = '';
                    if (notification.type === 'handshake' && !notification.read) {
                        actionButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-success btn-sm" onclick="acceptHandshake('${notification.id}', '${notification.handshakeData.fromUserId}')">
                                    <i class="fas fa-check"></i> –ü—Ä–∏–Ω—è—Ç—å
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectHandshake('${notification.id}')">
                                    <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        `;
                    }
                    
                    notificationElement.innerHTML = `
                        <div class="handshake-info">
                            <strong>${notification.title}</strong>
                            <p>${notification.message}</p>
                            <small style="color: var(--text-secondary);">
                                ${new Date(notification.createdAt).toLocaleString()}
                            </small>
                        </div>
                        ${actionButtons}
                    `;
                    
                    notificationsContainer.appendChild(notificationElement);
                    
                    if (!notification.read) unreadCount++;
                });
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        async function loadContacts() {
            if (!state.user || !db) return;
            
            try {
                const snapshot = await db.collection('handshakes')
                    .where('status', '==', 'accepted')
                    .where('expiresAt', '>', new Date().toISOString())
                    .where(function() {
                        return firebase.firestore.FieldValue.where('fromUserId', '==', state.user.uid) ||
                               firebase.firestore.FieldValue.where('toUserId', '==', state.user.uid);
                    })
                    .orderBy('acceptedAt', 'desc')
                    .get();
                
                const contactsContainer = document.getElementById('contactsContainer');
                
                if (!contactsContainer) return;
                
                contactsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-handshake" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const handshake = doc.data();
                    const isFromMe = handshake.fromUserId === state.user.uid;
                    const contactTelegram = isFromMe ? handshake.toTelegram : handshake.fromTelegram;
                    const contactAnonymousId = isFromMe ? handshake.toAnonymousId : handshake.fromAnonymousId;
                    const expiresAt = new Date(handshake.expiresAt);
                    const now = new Date();
                    const timeLeft = expiresAt - now;
                    
                    if (timeLeft <= 0) return;
                    
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-card';
                    
                    const timeText = hoursLeft < 1 ? '–ú–µ–Ω—å—à–µ —á–∞—Å–∞' : `${hoursLeft} —á`;
                    
                    contactElement.innerHTML = `
                        <div class="contact-header">
                            <div class="contact-avatar">${contactAnonymousId}</div>
                            <div class="contact-details">
                                <h4>–ê–Ω–æ–Ω–∏–º #${contactAnonymousId}</h4>
                                <div class="contact-telegram">
                                    <i class="fab fa-telegram"></i> ${contactTelegram}
                                </div>
                            </div>
                            <div class="contact-time">
                                <i class="fas fa-clock"></i> ${timeText}
                            </div>
                        </div>
                        <div class="contact-expires">
                            <i class="fas fa-hourglass-end"></i> –ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${timeText}
                        </div>
                    `;
                    
                    contactsContainer.appendChild(contactElement);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:", error);
            }
        }

        function generateAnonymousId() {
            return Math.floor(100 + Math.random() * 900);
        }

        function formatMessageText(text) {
            if (!text) return '';
            
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        function showAuthError(message) {
            const statusElement = document.getElementById('authStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showRegisterError(message) {
            const statusElement = document.getElementById('registerStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showRegisterSuccess(message) {
            const statusElement = document.getElementById('registerStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        function showVerifyError(message) {
            const statusElement = document.getElementById('verifyStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showVerifySuccess(message) {
            const statusElement = document.getElementById('verifyStatus');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        function showApplicationError(message) {
            const statusElement = document.getElementById('applicationStatusMessage');
            if (statusElement) {
                statusElement.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        function showApplicationSuccess(message) {
            const statusElement = document.getElementById('applicationStatusMessage');
            if (statusElement) {
                statusElement.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        async function loadAdminPanel() {
            if (!state.isAdmin || !db) return;
            
            await loadAdminStats();
            
            switch(state.currentAdminTab) {
                case 'applications':
                    await loadApplications();
                    break;
                case 'approved':
                    await loadApprovedUsers();
                    break;
                case 'banned':
                    await loadBannedUsers();
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'admins':
                    await loadAdmins();
                    break;
            }
        }

        async function loadAdminStats() {
            try {
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                
                const onlineSnapshot = await db.collection('users')
                    .where('online', '==', true)
                    .get();
                document.getElementById('onlineUsers').textContent = onlineSnapshot.size;
                
                const pendingAppsSnapshot = await db.collection('applications')
                    .where('status', '==', 'pending')
                    .get();
                document.getElementById('pendingApplications').textContent = pendingAppsSnapshot.size;
                
                const pendingReportsSnapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .get();
                document.getElementById('pendingReports').textContent = pendingReportsSnapshot.size;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
            }
        }

        async function loadApplications() {
            try {
                const snapshot = await db.collection('applications')
                    .where('status', '==', 'pending')
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                const table = document.getElementById('applicationsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                –ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const app = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${app.userEmail}</td>
                        <td>${app.telegramUsername || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${app.note || '‚Äî'}</td>
                        <td>${new Date(app.submittedAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="approveApplication('${doc.id}', '${app.userId}')">
                                    –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="rejectApplication('${doc.id}', '${app.userId}')">
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:", error);
            }
        }

        async function loadApprovedUsers() {
            try {
                const snapshot = await db.collection('users')
                    .where('isVerified', '==', true)
                    .where('isBanned', '==', false)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const table = document.getElementById('approvedTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                –ù–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.telegramUsername || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${user.isVerified ? new Date(user.verifiedAt || user.createdAt).toLocaleString() : '–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="banUser('${doc.id}', '${user.email}')">
                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö:", error);
            }
        }

        async function loadBannedUsers() {
            try {
                const snapshot = await db.collection('users')
                    .where('isBanned', '==', true)
                    .orderBy('bannedAt', 'desc')
                    .get();
                
                const table = document.getElementById('bannedTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                –ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.telegramUsername || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${user.banReason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª'}</td>
                        <td>${user.bannedAt ? new Date(user.bannedAt).toLocaleString() : '‚Äî'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="unbanUser('${doc.id}')">
                                    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö:", error);
            }
        }

        async function loadReports() {
            try {
                const snapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const table = document.getElementById('reportsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                –ù–µ—Ç –∂–∞–ª–æ–± –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(async doc => {
                    const report = doc.data();
                    const row = document.createElement('tr');
                    
                    let messageText = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
                    try {
                        const messageDoc = await db.collection('messages').doc(report.messageId).get();
                        if (messageDoc.exists) {
                            const message = messageDoc.data();
                            messageText = message.text.substring(0, 50) + (message.text.length > 50 ? '...' : '');
                        }
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                    }
                    
                    row.innerHTML = `
                        <td>${report.reporterEmail}</td>
                        <td>${messageText}</td>
                        <td>${getReasonText(report.reason)}</td>
                        <td>${new Date(report.createdAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--success); color: white;" onclick="resolveReport('${doc.id}')">
                                    –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ
                                </button>
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="deleteMessageFromReport('${doc.id}', '${report.messageId}')">
                                    –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±:", error);
            }
        }

        function getReasonText(reason) {
            const reasons = {
                'spam': '–°–ø–∞–º –∏–ª–∏ —Ä–µ–∫–ª–∞–º–∞',
                'insult': '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏–ª–∏ —É–≥—Ä–æ–∑—ã',
                'hate': '–†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏',
                'illegal': '–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'fraud': '–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return reasons[reason] || reason;
        }

        async function loadAdmins() {
            try {
                const snapshot = await db.collection('users')
                    .where('isAdmin', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const table = document.getElementById('adminsTable');
                table.innerHTML = '';
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                –ù–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${new Date(user.createdAt).toLocaleString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" style="background: var(--danger); color: white;" onclick="removeAdmin('${doc.id}')" ${state.user.uid === doc.id ? 'disabled' : ''}>
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:", error);
            }
        }

        async function approveApplication(applicationId, userId) {
            if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
            
            try {
                await db.collection('applications').doc(applicationId).update({
                    status: 'approved',
                    reviewedBy: state.user.email,
                    reviewedAt: new Date().toISOString()
                });
                
                await db.collection('users').doc(userId).update({
                    isVerified: true,
                    verifiedAt: new Date().toISOString()
                });
                
                alert('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!');
                await loadApplications();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
                alert('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
            }
        }

        async function rejectApplication(applicationId, userId) {
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
            
            try {
                await db.collection('applications').doc(applicationId).update({
                    status: 'rejected',
                    reviewedBy: state.user.email,
                    reviewedAt: new Date().toISOString()
                });
                
                alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!');
                await loadApplications();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:", error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
            }
        }

        async function banUser(userId, userEmail) {
            const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:');
            if (!reason) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    isBanned: true,
                    banReason: reason,
                    bannedAt: new Date().toISOString(),
                    bannedBy: state.user.email,
                    isVerified: false
                });
                
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                await loadApprovedUsers();
                await loadBannedUsers();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                alert('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    isBanned: false,
                    banReason: null,
                    bannedAt: null,
                    bannedBy: null,
                    isVerified: true
                });
                
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                await loadApprovedUsers();
                await loadBannedUsers();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        async function resolveReport(reportId) {
            if (!confirm('–ü–æ–º–µ—Ç–∏—Ç—å –∂–∞–ª–æ–±—É –∫–∞–∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω—É—é?')) return;
            
            try {
                await db.collection('reports').doc(reportId).update({
                    status: 'resolved',
                    resolvedBy: state.user.email,
                    resolvedAt: new Date().toISOString()
                });
                
                alert('–ñ–∞–ª–æ–±–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è!');
                await loadReports();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã:", error);
                alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã');
            }
        }

        async function deleteMessageFromReport(reportId, messageId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            try {
                await db.collection('messages').doc(messageId).delete();
                
                await db.collection('reports').doc(reportId).update({
                    status: 'resolved',
                    resolvedBy: state.user.email,
                    resolvedAt: new Date().toISOString()
                });
                
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏ –∂–∞–ª–æ–±–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!');
                await loadReports();
                await loadAdminStats();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        async function addAdmin() {
            const email = document.getElementById('addAdminEmail').value.trim();
            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                if (usersSnapshot.empty) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                
                await userDoc.ref.update({
                    isAdmin: true
                });
                
                document.getElementById('addAdminEmail').value = '';
                alert('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                await loadAdmins();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?')) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    isAdmin: false
                });
                
                alert('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω!');
                await loadAdmins();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            }
        }

        function updateAdminTabs() {
            const tabs = ['applications', 'approved', 'banned', 'reports', 'admins'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                const content = document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
                
                if (tab === state.currentAdminTab) {
                    btn.style.backgroundColor = 'var(--accent)';
                    btn.style.color = 'white';
                    content.classList.remove('hidden');
                } else {
                    btn.style.backgroundColor = 'var(--bg-tertiary)';
                    btn.style.color = 'var(--text-primary)';
                    content.classList.add('hidden');
                }
            });
        }

        async function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (!text || !state.user || !state.isVerified) return;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const message = {
                    text: text,
                    userId: state.user.uid,
                    userEmail: state.user.email,
                    anonymousId: state.userData.anonymousId || generateAnonymousId(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    deleted: false
                };
                
                await db.collection('messages').add(message);
                
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').style.height = 'auto';
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        window.offerHandshakeConfirm = function(anonymousId, targetUserId, targetUserEmail) {
            state.pendingHandshakeTarget = { anonymousId, targetUserId, targetUserEmail };
            
            document.getElementById('handshakeConfirmInfo').innerHTML = `
                <div class="handshake-notification">
                    <h4>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è</h4>
                    <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ <strong>–ê–Ω–æ–Ω–∏–º—É #${anonymousId}</strong></p>
                    <p>–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</p>
                    <ul>
                        <li>–í–∞—à Telegram (<strong>${state.userData.telegramUsername}</strong>) –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</li>
                        <li>–í—ã –ø–æ–ª—É—á–∏—Ç–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ç–≤–µ—Ç</li>
                        <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã 24 —á–∞—Å–∞</li>
                        <li>–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏</li>
                    </ul>
                    <p><strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–±–º–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏.</strong></p>
                </div>
            `;
            
            document.getElementById('confirmHandshakeModal').classList.add('active');
        };

        async function confirmHandshake() {
            if (!state.pendingHandshakeTarget) return;
            
            const { anonymousId, targetUserId, targetUserEmail } = state.pendingHandshakeTarget;
            
            try {
                const targetUserDoc = await db.collection('users').doc(targetUserId).get();
                if (!targetUserDoc.exists) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const targetUser = targetUserDoc.data();
                
                if (!targetUser.telegramUsername) {
                    alert('–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω Telegram');
                    return;
                }
                
                if (targetUser.isBanned) {
                    alert('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                const handshakeData = {
                    fromUserId: state.user.uid,
                    fromEmail: state.user.email,
                    fromTelegram: state.userData.telegramUsername,
                    fromAnonymousId: state.userData.anonymousId,
                    toUserId: targetUserId,
                    toEmail: targetUserEmail,
                    toTelegram: targetUser.telegramUsername,
                    toAnonymousId: anonymousId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };
                
                await db.collection('handshakes').add(handshakeData);
                
                await db.collection('notifications').add({
                    userId: targetUserId,
                    type: 'handshake',
                    title: '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è',
                    message: `–ê–Ω–æ–Ω–∏–º #${state.userData.anonymousId} –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏.`,
                    handshakeData: handshakeData,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('confirmHandshakeModal').classList.remove('active');
                state.pendingHandshakeTarget = null;
                
                alert('ü§ù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
            }
        }

        window.acceptHandshake = async function(notificationId, fromUserId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –∏ –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏?')) {
                return;
            }
            
            try {
                const notificationRef = db.collection('notifications').doc(notificationId);
                const notificationDoc = await notificationRef.get();
                const notification = notificationDoc.data();
                
                if (!notification.handshakeData) {
                    alert('–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
                    return;
                }
                
                const handshakesSnapshot = await db.collection('handshakes')
                    .where('fromUserId', '==', fromUserId)
                    .where('toUserId', '==', state.user.uid)
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!handshakesSnapshot.empty) {
                    const handshakeDoc = handshakesSnapshot.docs[0];
                    await handshakeDoc.ref.update({
                        status: 'accepted',
                        acceptedAt: new Date().toISOString()
                    });
                }
                
                await notificationRef.update({ read: true });
                
                await db.collection('notifications').add({
                    userId: fromUserId,
                    type: 'handshake_accepted',
                    title: '–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –ø—Ä–∏–Ω—è—Ç–æ',
                    message: `–ê–Ω–æ–Ω–∏–º #${state.userData.anonymousId} –ø—Ä–∏–Ω—è–ª –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è.`,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                await loadContacts();
                
                alert('ü§ù –†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
            }
        };

        window.rejectHandshake = async function(notificationId) {
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è?')) {
                return;
            }
            
            try {
                await db.collection('notifications').doc(notificationId).update({ read: true });
                alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            document.getElementById('contextDelete').addEventListener('click', async () => {
                if (state.contextMenu.isMyMessage) {
                    await deleteMessage();
                } else if (state.isAdmin) {
                    await adminDeleteMessage();
                }
            });
            
            document.getElementById('contextReport').addEventListener('click', reportMessage);
            document.getElementById('contextClose').addEventListener('click', hideMessageContextMenu);
            
            document.addEventListener('click', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginTab && registerTab && loginForm && registerForm) {
                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });
                
                registerTab.addEventListener('click', () => {
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }
            
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail) {
                loginEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            const resendVerifyBtn = document.getElementById('resendVerifyBtn');
            const checkVerifyBtn = document.getElementById('checkVerifyBtn');
            const logoutFromVerifyBtn = document.getElementById('logoutFromVerifyBtn');
            
            if (resendVerifyBtn) {
                resendVerifyBtn.addEventListener('click', resendVerificationEmail);
            }
            
            if (checkVerifyBtn) {
                checkVerifyBtn.addEventListener('click', checkEmailVerification);
            }
            
            if (logoutFromVerifyBtn) {
                logoutFromVerifyBtn.addEventListener('click', handleLogout);
            }
            
            const submitApplicationBtn = document.getElementById('submitApplicationBtn');
            const logoutFromAppBtn = document.getElementById('logoutFromAppBtn');
            
            if (submitApplicationBtn) {
                submitApplicationBtn.addEventListener('click', submitApplication);
            }
            
            if (logoutFromAppBtn) {
                logoutFromAppBtn.addEventListener('click', handleLogout);
            }
            
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, state.isTouchDevice ? 100 : 120) + 'px';
                    this.style.overflowY = this.scrollHeight > (state.isTouchDevice ? 100 : 120) ? 'auto' : 'hidden';
                });
            }
            
            const profileBtn = document.getElementById('profileBtn');
            const contactsBtn = document.getElementById('contactsBtn');
            const notificationsBtn = document.getElementById('notificationsBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.add('active');
                });
            }
            
            if (contactsBtn) {
                contactsBtn.addEventListener('click', () => {
                    loadContacts();
                    document.getElementById('contactsModal').classList.add('active');
                });
            }
            
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    document.getElementById('notificationsModal').classList.add('active');
                });
            }
            
            if (adminBtn) {
                adminBtn.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    document.getElementById('adminModal').classList.add('active');
                    loadAdminPanel();
                });
            }
            
            const closeProfileBtn = document.getElementById('closeProfileBtn');
            const closeContactsBtn = document.getElementById('closeContactsBtn');
            const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
            const closeAdminBtn = document.getElementById('closeAdminBtn');
            const closeConfirmHandshakeBtn = document.getElementById('closeConfirmHandshakeBtn');
            const closeReportBtn = document.getElementById('closeReportBtn');
            
            if (closeProfileBtn) {
                closeProfileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.remove('active');
                });
            }
            
            if (closeContactsBtn) {
                closeContactsBtn.addEventListener('click', () => {
                    document.getElementById('contactsModal').classList.remove('active');
                });
            }
            
            if (closeNotificationsBtn) {
                closeNotificationsBtn.addEventListener('click', () => {
                    document.getElementById('notificationsModal').classList.remove('active');
                });
            }
            
            if (closeAdminBtn) {
                closeAdminBtn.addEventListener('click', () => {
                    document.getElementById('adminModal').classList.remove('active');
                });
            }
            
            if (closeConfirmHandshakeBtn) {
                closeConfirmHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
            
            if (closeReportBtn) {
                closeReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            const submitReportBtn = document.getElementById('submitReportBtn');
            const cancelReportBtn = document.getElementById('cancelReportBtn');
            
            if (submitReportBtn) {
                submitReportBtn.addEventListener('click', submitReport);
            }
            
            if (cancelReportBtn) {
                cancelReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            const adminTabApplications = document.getElementById('adminTabApplications');
            const adminTabApproved = document.getElementById('adminTabApproved');
            const adminTabBanned = document.getElementById('adminTabBanned');
            const adminTabReports = document.getElementById('adminTabReports');
            const adminTabAdmins = document.getElementById('adminTabAdmins');
            
            if (adminTabApplications) {
                adminTabApplications.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    loadApplications();
                });
            }
            
            if (adminTabApproved) {
                adminTabApproved.addEventListener('click', () => {
                    state.currentAdminTab = 'approved';
                    updateAdminTabs();
                    loadApprovedUsers();
                });
            }
            
            if (adminTabBanned) {
                adminTabBanned.addEventListener('click', () => {
                    state.currentAdminTab = 'banned';
                    updateAdminTabs();
                    loadBannedUsers();
                });
            }
            
            if (adminTabReports) {
                adminTabReports.addEventListener('click', () => {
                    state.currentAdminTab = 'reports';
                    updateAdminTabs();
                    loadReports();
                });
            }
            
            if (adminTabAdmins) {
                adminTabAdmins.addEventListener('click', () => {
                    state.currentAdminTab = 'admins';
                    updateAdminTabs();
                    loadAdmins();
                });
            }
            
            const addAdminBtn = document.getElementById('addAdminBtn');
            const addAdminEmail = document.getElementById('addAdminEmail');
            
            if (addAdminBtn) {
                addAdminBtn.addEventListener('click', addAdmin);
            }
            
            if (addAdminEmail) {
                addAdminEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') addAdmin();
                });
            }
            
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    state.theme = newTheme;
                    document.body.classList.toggle('dark-theme');
                    document.body.classList.toggle('light-theme');
                    localStorage.setItem('neznakomka-theme', newTheme);
                    
                    const icon = themeToggle.querySelector('i');
                    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                });
            }
            
            const savedTheme = localStorage.getItem('neznakomka-theme') || 'light';
            state.theme = savedTheme;
            document.body.classList.add(savedTheme + '-theme');
            const icon = document.getElementById('themeToggle')?.querySelector('i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            if (state.isTouchDevice) {
                document.body.classList.add('touch-device');
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            const confirmHandshakeBtn = document.getElementById('confirmHandshakeBtn');
            const cancelHandshakeBtn = document.getElementById('cancelHandshakeBtn');
            
            if (confirmHandshakeBtn) {
                confirmHandshakeBtn.addEventListener('click', confirmHandshake);
            }
            
            if (cancelHandshakeBtn) {
                cancelHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
        });

        window.approveApplication = approveApplication;
        window.rejectApplication = rejectApplication;
        window.banUser = banUser;
        window.unbanUser = unbanUser;
        window.resolveReport = resolveReport;
        window.deleteMessageFromReport = deleteMessageFromReport;
        window.removeAdmin = removeAdmin;

    </script>
</body>
</html>