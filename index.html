<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–µ–∑–Ω–∞–∫–æ–º–∫–∞ (AnonChat)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        /* [–í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] */
        /* ... */
    </style>
</head>
<body class="light-theme">
    <!-- –ë–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏ -->
    <div class="version-badge">v.0.3</div>
    
    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã -->
    <div class="custom-alert-overlay" id="customAlertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <h3 id="customAlertTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
        <div class="custom-alert-content" id="customAlertContent"></div>
        <div class="custom-alert-buttons">
            <button class="btn btn-primary" id="customAlertConfirm">OK</button>
        </div>
    </div>
    
    <!-- [–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ HTML —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] -->
    <!-- ... -->
    
    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA-dQ8-cqE7y9VfNA3fPLF6hDO-s1OfQ4Q",
            authDomain: "neznakomka.firebaseapp.com",
            projectId: "neznakomka",
            storageBucket: "neznakomka.firebasestorage.app",
            messagingSenderId: "245961594712",
            appId: "1:245961594712:web:e1c8ba71af1289b1bc372d",
            measurementId: "G-QJ2Q13VB4T"
        };

        // === –°–û–°–¢–û–Ø–ù–ò–ï ===
        const state = {
            user: null,
            userData: null,
            isAdmin: false,
            isVerified: false,
            emailVerified: false,
            messages: [],
            onlineUsers: [],
            theme: 'light',
            pendingHandshakeTarget: null,
            reportTargetMessage: null,
            banTargetUser: null,
            contextMenu: {
                active: false,
                messageId: null,
                messageElement: null,
                isMyMessage: false,
                x: 0,
                y: 0
            },
            touchTimer: null,
            isTouchDevice: false,
            currentAdminTab: 'applications',
            hasAcceptedTerms: false,
            messageListenerUnsubscribe: null,
            notificationListenerUnsubscribe: null,
            messagesLoaded: false
        };

        // === –£–¢–ò–õ–ò–¢–´ ===
        function showAlert(title, message, callback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertContent').textContent = message;
            document.getElementById('customAlertOverlay').classList.add('active');
            document.getElementById('customAlert').classList.add('active');
            
            const confirmBtn = document.getElementById('customAlertConfirm');
            const oldClick = confirmBtn.onclick;
            confirmBtn.onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (callback) callback();
                confirmBtn.onclick = oldClick;
            };
        }

        function showConfirm(title, message, confirmCallback, cancelCallback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertContent').textContent = message;
            document.getElementById('customAlertOverlay').classList.add('active');
            document.getElementById('customAlert').classList.add('active');
            
            const buttonsDiv = document.getElementById('customAlert').querySelector('.custom-alert-buttons');
            buttonsDiv.innerHTML = `
                <button class="btn btn-primary" id="customAlertConfirm">–î–∞</button>
                <button class="btn" id="customAlertCancel" style="background: var(--bg-tertiary);">–ù–µ—Ç</button>
            `;
            
            document.getElementById('customAlertConfirm').onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (confirmCallback) confirmCallback();
                buttonsDiv.innerHTML = '<button class="btn btn-primary" id="customAlertConfirm">OK</button>';
            };
            
            document.getElementById('customAlertCancel').onclick = function() {
                document.getElementById('customAlertOverlay').classList.remove('active');
                document.getElementById('customAlert').classList.remove('active');
                if (cancelCallback) cancelCallback();
                buttonsDiv.innerHTML = '<button class="btn btn-primary" id="customAlertConfirm">OK</button>';
            };
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ===
        let auth, db;

        function initFirebase() {
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                
                state.isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        state.user = user;
                        state.emailVerified = user.emailVerified;
                        
                        if (!user.emailVerified) {
                            showVerifyEmailScreen();
                        } else {
                            await loadUserData();
                            
                            if (state.userData) {
                                if (!state.hasAcceptedTerms) {
                                    showTermsAgreement();
                                } else {
                                    continueAfterTerms();
                                }
                            }
                        }
                    } else {
                        resetState();
                        showAuthScreen();
                    }
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ Firebase:", error);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
        }

        function resetState() {
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
            if (state.messageListenerUnsubscribe) {
                state.messageListenerUnsubscribe();
                state.messageListenerUnsubscribe = null;
            }
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            if (state.notificationListenerUnsubscribe) {
                state.notificationListenerUnsubscribe();
                state.notificationListenerUnsubscribe = null;
            }
            
            state.user = null;
            state.userData = null;
            state.isAdmin = false;
            state.isVerified = false;
            state.emailVerified = false;
            state.messages = [];
            state.onlineUsers = [];
            state.pendingHandshakeTarget = null;
            state.reportTargetMessage = null;
            state.banTargetUser = null;
            state.hasAcceptedTerms = false;
            state.messagesLoaded = false;
        }

        async function continueAfterTerms() {
            if (!state.userData) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            await checkAndUnbanIfExpired();
            
            if (state.userData.isBanned && state.userData.banExpiresAt && new Date(state.userData.banExpiresAt) > new Date()) {
                const expiresAt = new Date(state.userData.banExpiresAt);
                const now = new Date();
                const hoursLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60));
                
                showAlert('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', `–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ ${expiresAt.toLocaleString()}. –ü—Ä–∏—á–∏–Ω–∞: ${state.userData.banReason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª'}. –û—Å—Ç–∞–ª–æ—Å—å: ${hoursLeft} —á–∞—Å–æ–≤.`);
                await handleLogout();
                return;
            } else if (state.userData.isBanned && !state.userData.banExpiresAt) {
                showAlert('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', `–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞. –ü—Ä–∏—á–∏–Ω–∞: ${state.userData.banReason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª'}.`);
                await handleLogout();
                return;
            }
            
            if (state.userData.isVerified) {
                state.isVerified = true;
                showChatScreen();
                loadMessages();
                loadNotifications();
                loadContacts();
            } else {
                showApplicationScreen();
                checkApplicationStatus();
            }
        }

        async function checkAndUnbanIfExpired() {
            if (!state.userData || !state.userData.isBanned) return;
            
            const now = new Date();
            const expiresAt = state.userData.banExpiresAt ? new Date(state.userData.banExpiresAt) : null;
            
            // –ï—Å–ª–∏ –±–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
            if (expiresAt && expiresAt <= now) {
                try {
                    await db.collection('users').doc(state.user.uid).update({
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        banExpiresAt: null
                    });
                    
                    state.userData.isBanned = false;
                    state.userData.banReason = null;
                    state.userData.bannedAt = null;
                    state.userData.bannedBy = null;
                    state.userData.banExpiresAt = null;
                    
                    console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", error);
                }
            }
        }

        async function loadUserData() {
            if (!state.user || !db) return;
            
            try {
                const userRef = db.collection('users').doc(state.user.uid);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    state.userData = doc.data();
                    
                    state.hasAcceptedTerms = state.userData.hasAcceptedTerms || false;
                    
                    if (state.userData.isAdmin) {
                        state.isAdmin = true;
                        if (document.getElementById('adminBtn')) {
                            document.getElementById('adminBtn').classList.remove('hidden');
                        }
                    }
                    
                    updateProfileUI();
                    
                } else {
                    state.userData = {
                        email: state.user.email,
                        isAdmin: state.user.email === 'sad.spotty@gmail.com',
                        isVerified: false,
                        emailVerified: true,
                        telegramUsername: null,
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        online: true,
                        anonymousId: generateAnonymousId(),
                        isBanned: false,
                        banReason: null,
                        bannedAt: null,
                        bannedBy: null,
                        hasAcceptedTerms: false
                    };
                    
                    await userRef.set(state.userData);
                }
                
                await userRef.update({
                    lastSeen: new Date().toISOString(),
                    online: true
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        function showTermsAgreement() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function acceptTerms() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function rejectTerms() {
            showConfirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è? –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –≤—ã—Ö–æ–¥—É –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.',
                async () => {
                    await handleLogout();
                }
            );
        }

        async function handleRegister() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function handleLogin() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showAuthScreen() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showChatScreen() {
            const screens = ['authScreen', 'verifyEmailScreen', 'applicationScreen', 'chatScreen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) element.classList.add('hidden');
            });
            
            document.getElementById('chatScreen').classList.remove('hidden');
            
            updateProfileUI();
            loadMessages();
            initChatEventListeners();
            
            if (document.getElementById('contactsBtn')) {
                document.getElementById('contactsBtn').classList.remove('hidden');
            }
            if (document.getElementById('notificationsBtn')) {
                document.getElementById('notificationsBtn').classList.remove('hidden');
            }
            if (document.getElementById('profileBtn')) {
                document.getElementById('profileBtn').classList.remove('hidden');
            }
            
            if (state.isAdmin && document.getElementById('adminBtn')) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
        }

        function updateProfileUI() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function initChatEventListeners() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function resendVerificationEmail() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function checkEmailVerification() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function checkTelegramUsernameUnique(username) {
            if (!db) return true;
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('telegramUsername', '==', username)
                    .where('isVerified', '==', true)
                    .limit(1)
                    .get();
                
                return usersSnapshot.empty;
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ username:", error);
                return true;
            }
        }

        async function submitApplication() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function updateApplicationStatusUI() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function checkApplicationStatus() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showVerifyEmailScreen() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showApplicationScreen() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function handleLogout() {
            try {
                if (state.user && db) {
                    const userRef = db.collection('users').doc(state.user.uid);
                    await userRef.update({
                        online: false,
                        lastSeen: new Date().toISOString()
                    });
                }
                
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π
                if (state.messageListenerUnsubscribe) {
                    state.messageListenerUnsubscribe();
                    state.messageListenerUnsubscribe = null;
                }
                
                if (state.notificationListenerUnsubscribe) {
                    state.notificationListenerUnsubscribe();
                    state.notificationListenerUnsubscribe = null;
                }
                
                await auth.signOut();
                
                resetState();
                showAuthScreen();
                
                const modals = document.querySelectorAll('.modal-overlay.active');
                modals.forEach(modal => modal.classList.remove('active'));
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
                showAlert('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        function loadMessages() {
            if (!db || !state.isVerified || state.messagesLoaded) return;
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('messagesContainer').innerHTML = '';
            
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
            if (state.messageListenerUnsubscribe) {
                state.messageListenerUnsubscribe();
            }
            
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .get()
                .then((snapshot) => {
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        message.id = doc.id;
                        if (!message.deleted) {
                            addMessageToUI(message);
                        }
                    });
                    scrollToBottom();
                    state.messagesLoaded = true;
                })
                .catch((error) => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
                });
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const unsubscribe = db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            message.id = change.doc.id;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            if (!message.deleted && !document.querySelector(`[data-message-id="${message.id}"]`)) {
                                addMessageToUI(message);
                            }
                        } else if (change.type === 'removed') {
                            const messageElement = document.querySelector(`[data-message-id="${change.doc.id}"]`);
                            if (messageElement) {
                                messageElement.remove();
                            }
                        } else if (change.type === 'modified') {
                            const messageElement = document.querySelector(`[data-message-id="${change.doc.id}"]`);
                            if (messageElement) {
                                messageElement.remove();
                                const message = change.doc.data();
                                message.id = change.doc.id;
                                if (!message.deleted) {
                                    addMessageToUI(message);
                                }
                            }
                        }
                    });
                    
                    scrollToBottom();
                }, (error) => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
            state.messageListenerUnsubscribe = unsubscribe;
        }

        function addMessageToUI(message) {
            if (message.deleted) return;
            
            const messageElement = document.createElement('div');
            const isMyMessage = message.userId === state.user.uid;
            
            messageElement.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            messageElement.setAttribute('data-message-id', message.id);
            
            const time = message.timestamp?.toDate 
                ? message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const displayName = isMyMessage ? '–í—ã' : `–ê–Ω–æ–Ω–∏–º #${message.anonymousId || '000'}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
            // 1. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–µ
            // 2. –£ –º–µ–Ω—è –µ—Å—Ç—å telegram username
            // 3. –Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
            // 4. –£ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –µ—Å—Ç—å telegram username (–ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–∑–∂–µ –≤ –º–æ–¥–∞–ª–∫–µ)
            const handshakeButton = !isMyMessage && state.userData && state.userData.telegramUsername && state.userData.isVerified ? `
                <button class="handshake-btn" onclick="offerHandshakeConfirm('${message.anonymousId}', '${message.userId}', '${message.userEmail}')">
                    <i class="fas fa-handshake"></i> –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ
                </button>
            ` : '';
            
            messageElement.innerHTML = `
                <div class="message-sender">
                    <i class="fas ${isMyMessage ? 'fa-user' : 'fa-user-secret'}"></i> 
                    ${displayName}
                </div>
                <div class="message-bubble">
                    <div class="message-text">${formatMessageText(message.text)}</div>
                    <div class="message-time">${time}</div>
                </div>
                ${handshakeButton}
            `;
            
            setupMessageContextMenu(messageElement, message, isMyMessage);
            
            const container = document.getElementById('messagesContainer');
            container.appendChild(messageElement);
        }

        function setupMessageContextMenu(messageElement, message, isMyMessage) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showMessageContextMenu(e, message, isMyMessage, messageElement) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function hideMessageContextMenu() {
            state.contextMenu.active = false;
            document.getElementById('messageContextMenu').classList.remove('active');
        }

        async function deleteMessage() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function adminDeleteMessage() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function reportMessage() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function submitReport() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function banUserFromContext() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showBanModal() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function submitBan() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function loadNotifications() {
            if (!state.user || !db) return;
            
            console.log("üîî –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", state.user.uid);
            
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
            if (state.notificationListenerUnsubscribe) {
                state.notificationListenerUnsubscribe();
            }
            
            const notificationsRef = db.collection('notifications')
                .where('userId', '==', state.user.uid)
                .orderBy('createdAt', 'desc')
                .limit(20);
            
            const unsubscribe = notificationsRef.onSnapshot((snapshot) => {
                const notificationsContainer = document.getElementById('notificationsContainer');
                const badge = document.getElementById('notificationsBadge');
                
                if (!notificationsContainer) {
                    console.error("‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                
                console.log("üì¨ –ü–æ–ª—É—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", snapshot.size);
                
                notificationsContainer.innerHTML = '';
                let unreadCount = 0;
                
                if (snapshot.empty) {
                    console.log("‚ÑπÔ∏è –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π");
                    notificationsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-bell-slash" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                        </div>
                    `;
                } else {
                    snapshot.forEach(doc => {
                        const notification = doc.data();
                        notification.id = doc.id;
                        
                        console.log("üì© –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:", notification);
                        
                        const notificationElement = document.createElement('div');
                        notificationElement.className = 'handshake-item';
                        notificationElement.style.opacity = notification.read ? '0.7' : '1';
                        
                        let actionButtons = '';
                        if (notification.type === 'handshake' && !notification.read) {
                            const fromUserId = notification.handshakeData?.fromUserId;
                            if (fromUserId) {
                                actionButtons = `
                                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                                        <button class="btn btn-success btn-sm" onclick="acceptHandshake('${notification.id}', '${fromUserId}')">
                                            <i class="fas fa-check"></i> –ü—Ä–∏–Ω—è—Ç—å
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectHandshake('${notification.id}')">
                                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        
                        notificationElement.innerHTML = `
                            <div class="handshake-info">
                                <strong>${notification.title || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</strong>
                                <p>${notification.message || '–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</p>
                                <small style="color: var(--text-secondary);">
                                    ${notification.createdAt ? new Date(notification.createdAt).toLocaleString() : '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
                                </small>
                            </div>
                            ${actionButtons}
                        `;
                        
                        notificationsContainer.appendChild(notificationElement);
                        
                        if (!notification.read) unreadCount++;
                    });
                }
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                        console.log("üî¥ –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:", unreadCount);
                    } else {
                        badge.classList.add('hidden');
                        console.log("üü¢ –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã");
                    }
                }
            }, (error) => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:", error);
                console.error("–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:", error.message);
                
                const notificationsContainer = document.getElementById('notificationsContainer');
                if (notificationsContainer) {
                    notificationsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 15px;"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px;">${error.message}</p>
                        </div>
                    `;
                }
            });
            
            state.notificationListenerUnsubscribe = unsubscribe;
        }

        async function loadContacts() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function generateAnonymousId() {
            return Math.floor(100 + Math.random() * 900);
        }

        function formatMessageText(text) {
            if (!text) return '';
            
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        function showAuthError(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showRegisterError(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showRegisterSuccess(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showVerifyError(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showVerifySuccess(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showApplicationError(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function showApplicationSuccess(message) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadAdminPanel() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadAdminStats() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadApplications() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadApprovedUsers() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadBannedUsers() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadReports() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function getReasonText(reason) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function loadAdmins() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function approveApplication(applicationId, userId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function rejectApplication(applicationId, userId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        window.showBanUserModal = function(userId, userEmail) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        };

        async function banUser(userId, userEmail) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function unbanUser(userId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function resolveReport(reportId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function deleteMessageFromReport(reportId, messageId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function addAdmin() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function removeAdmin(userId) {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        function updateAdminTabs() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        async function sendMessage() {
            // [–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π]
            // ...
        }

        window.offerHandshakeConfirm = function(anonymousId, targetUserId, targetUserEmail) {
            console.log("ü§ù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –¥–ª—è:", targetUserId);
            
            state.pendingHandshakeTarget = { 
                anonymousId, 
                targetUserId, 
                targetUserEmail 
            };
            
            document.getElementById('handshakeConfirmInfo').innerHTML = `
                <div class="handshake-notification">
                    <h4>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è</h4>
                    <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ <strong>–ê–Ω–æ–Ω–∏–º—É #${anonymousId}</strong></p>
                    <p>–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</p>
                    <ul>
                        <li>–í–∞—à Telegram (<strong>${state.userData.telegramUsername}</strong>) –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</li>
                        <li>–í—ã –ø–æ–ª—É—á–∏—Ç–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ç–≤–µ—Ç</li>
                        <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã 24 —á–∞—Å–∞</li>
                        <li>–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º —Å–æ–≥–ª–∞—Å–∏–∏</li>
                    </ul>
                    <p><strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–±–º–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏.</strong></p>
                </div>
            `;
            
            document.getElementById('confirmHandshakeModal').classList.add('active');
        };

        async function confirmHandshake() {
            if (!state.pendingHandshakeTarget) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç —Ü–µ–ª–∏ –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
                return;
            }
            
            const { anonymousId, targetUserId, targetUserEmail } = state.pendingHandshakeTarget;
            
            console.log("üîÑ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", targetUserId);
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const targetUserDoc = await db.collection('users').doc(targetUserId).get();
                if (!targetUserDoc.exists) {
                    showAlert('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const targetUser = targetUserDoc.data();
                console.log("üéØ –î–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", targetUser);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∏
                if (!targetUser.telegramUsername) {
                    showAlert('–û—à–∏–±–∫–∞', '–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω Telegram');
                    return;
                }
                
                if (targetUser.isBanned) {
                    showAlert('–û—à–∏–±–∫–∞', '–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                if (!targetUser.isVerified) {
                    showAlert('–û—à–∏–±–∫–∞', '–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ
                const existingHandshake = await db.collection('handshakes')
                    .where('fromUserId', '==', state.user.uid)
                    .where('toUserId', '==', targetUserId)
                    .where('status', 'in', ['pending', 'accepted'])
                    .limit(1)
                    .get();
                
                if (!existingHandshake.empty) {
                    showAlert('–í–Ω–∏–º–∞–Ω–∏–µ', '–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è
                const handshakeData = {
                    fromUserId: state.user.uid,
                    fromEmail: state.user.email,
                    fromTelegram: state.userData.telegramUsername,
                    fromAnonymousId: state.userData.anonymousId,
                    toUserId: targetUserId,
                    toEmail: targetUserEmail,
                    toTelegram: targetUser.telegramUsername,
                    toAnonymousId: targetUser.anonymousId || anonymousId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };
                
                console.log("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:", handshakeData);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ
                const handshakeRef = await db.collection('handshakes').add(handshakeData);
                
                console.log("‚úÖ –†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å ID:", handshakeRef.id);
                
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                const notificationData = {
                    userId: targetUserId,
                    type: 'handshake',
                    title: '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è ü§ù',
                    message: `–ê–Ω–æ–Ω–∏–º #${state.userData.anonymousId} –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –≤ Telegram.`,
                    handshakeData: handshakeData,
                    handshakeId: handshakeRef.id,
                    read: false,
                    createdAt: new Date().toISOString()
                };
                
                console.log("üì® –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", notificationData);
                
                await db.collection('notifications').add(notificationData);
                
                console.log("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ");
                
                document.getElementById('confirmHandshakeModal').classList.remove('active');
                state.pendingHandshakeTarget = null;
                
                showAlert('–£—Å–ø–µ—Ö', 'ü§ù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:', error);
                console.error('–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:', error.message);
                showAlert('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è: ${error.message}`);
            }
        }

        window.acceptHandshake = async function(notificationId, fromUserId) {
            console.log("‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:", notificationId, "–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", fromUserId);
            
            showConfirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –∏ –æ–±–º–µ–Ω—è—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –≤ Telegram?', async () => {
                try {
                    const notificationRef = db.collection('notifications').doc(notificationId);
                    const notificationDoc = await notificationRef.get();
                    
                    if (!notificationDoc.exists) {
                        showAlert('–û—à–∏–±–∫–∞', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                        return;
                    }
                    
                    const notification = notificationDoc.data();
                    console.log("üì© –î–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", notification);
                    
                    if (!notification.handshakeData || !notification.handshakeId) {
                        showAlert('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è
                    await db.collection('handshakes').doc(notification.handshakeId).update({
                        status: 'accepted',
                        acceptedAt: new Date().toISOString()
                    });
                    
                    console.log("‚úÖ –†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");
                    
                    // –û—Ç–º–µ—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                    await notificationRef.update({ 
                        read: true,
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ");
                    
                    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    const senderNotification = {
                        userId: fromUserId,
                        type: 'handshake_accepted',
                        title: '–†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –ø—Ä–∏–Ω—è—Ç–æ ü§ù',
                        message: `–ê–Ω–æ–Ω–∏–º #${state.userData.anonymousId} –ø—Ä–∏–Ω—è–ª –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞.`,
                        read: false,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('notifications').add(senderNotification);
                    
                    console.log("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é —Å–æ–∑–¥–∞–Ω–æ");
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
                    await loadContacts();
                    
                    showAlert('–£—Å–ø–µ—Ö', 'ü§ù –†—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:', error);
                    showAlert('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è: ${error.message}`);
                }
            });
        };

        window.rejectHandshake = async function(notificationId) {
            console.log("‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è:", notificationId);
            
            showConfirm('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è?', async () => {
                try {
                    await db.collection('notifications').doc(notificationId).update({ 
                        read: true,
                        updatedAt: new Date().toISOString()
                    });
                    showAlert('–£—Å–ø–µ—Ö', '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', error);
                    showAlert('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è');
                }
            });
        };

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Firestore –∏–Ω–¥–µ–∫—Å—ã
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Firestore –∏–Ω–¥–µ–∫—Å–æ–≤...");
                console.log("–î–ª—è —Ä–∞–±–æ—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω—É–∂–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:");
                console.log("1. –ö–æ–ª–ª–µ–∫—Ü–∏—è 'notifications', –ø–æ–ª—è: userId (ASC), createdAt (DESC)");
                console.log("2. –ö–æ–ª–ª–µ–∫—Ü–∏—è 'handshakes', –ø–æ–ª—è: fromUserId (ASC), toUserId (ASC), status (ASC)");
            }
            
            initFirebase();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            const contextBan = document.getElementById('contextBan');
            if (contextBan) {
                contextBan.addEventListener('click', banUserFromContext);
            }
            
            document.getElementById('contextDelete').addEventListener('click', async () => {
                if (state.contextMenu.isMyMessage) {
                    await deleteMessage();
                } else if (state.isAdmin) {
                    await adminDeleteMessage();
                }
            });
            
            document.getElementById('contextReport').addEventListener('click', reportMessage);
            document.getElementById('contextClose').addEventListener('click', hideMessageContextMenu);
            
            document.addEventListener('click', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (state.contextMenu.active && !e.target.closest('.message-context-menu')) {
                    hideMessageContextMenu();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginTab && registerTab && loginForm && registerForm) {
                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });
                
                registerTab.addEventListener('click', () => {
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }
            
            // –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∞–≤–∏—à–∏ –≤—Ö–æ–¥–∞
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail) {
                loginEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email
            const resendVerifyBtn = document.getElementById('resendVerifyBtn');
            const checkVerifyBtn = document.getElementById('checkVerifyBtn');
            const logoutFromVerifyBtn = document.getElementById('logoutFromVerifyBtn');
            
            if (resendVerifyBtn) {
                resendVerifyBtn.addEventListener('click', resendVerificationEmail);
            }
            
            if (checkVerifyBtn) {
                checkVerifyBtn.addEventListener('click', checkEmailVerification);
            }
            
            if (logoutFromVerifyBtn) {
                logoutFromVerifyBtn.addEventListener('click', handleLogout);
            }
            
            // –ö–Ω–æ–ø–∫–∏ –∑–∞—è–≤–∫–∏
            const submitApplicationBtn = document.getElementById('submitApplicationBtn');
            const logoutFromAppBtn = document.getElementById('logoutFromAppBtn');
            
            if (submitApplicationBtn) {
                submitApplicationBtn.addEventListener('click', submitApplication);
            }
            
            if (logoutFromAppBtn) {
                logoutFromAppBtn.addEventListener('click', handleLogout);
            }
            
            // –ö–Ω–æ–ø–∫–∏ —á–∞—Ç–∞
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, state.isTouchDevice ? 100 : 120) + 'px';
                    this.style.overflowY = this.scrollHeight > (state.isTouchDevice ? 100 : 120) ? 'auto' : 'hidden';
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ –≤ —à–∞–ø–∫–µ
            const profileBtn = document.getElementById('profileBtn');
            const contactsBtn = document.getElementById('contactsBtn');
            const notificationsBtn = document.getElementById('notificationsBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.add('active');
                });
            }
            
            if (contactsBtn) {
                contactsBtn.addEventListener('click', () => {
                    loadContacts();
                    document.getElementById('contactsModal').classList.add('active');
                });
            }
            
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    console.log("üîî –û—Ç–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...");
                    document.getElementById('notificationsModal').classList.add('active');
                });
            }
            
            if (adminBtn) {
                adminBtn.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    document.getElementById('adminModal').classList.add('active');
                    loadAdminPanel();
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–∫
            const closeProfileBtn = document.getElementById('closeProfileBtn');
            const closeContactsBtn = document.getElementById('closeContactsBtn');
            const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
            const closeAdminBtn = document.getElementById('closeAdminBtn');
            const closeConfirmHandshakeBtn = document.getElementById('closeConfirmHandshakeBtn');
            const closeReportBtn = document.getElementById('closeReportBtn');
            const closeBanBtn = document.getElementById('closeBanBtn');
            
            if (closeProfileBtn) {
                closeProfileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').classList.remove('active');
                });
            }
            
            if (closeContactsBtn) {
                closeContactsBtn.addEventListener('click', () => {
                    document.getElementById('contactsModal').classList.remove('active');
                });
            }
            
            if (closeNotificationsBtn) {
                closeNotificationsBtn.addEventListener('click', () => {
                    document.getElementById('notificationsModal').classList.remove('active');
                });
            }
            
            if (closeAdminBtn) {
                closeAdminBtn.addEventListener('click', () => {
                    document.getElementById('adminModal').classList.remove('active');
                });
            }
            
            if (closeConfirmHandshakeBtn) {
                closeConfirmHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
            
            if (closeReportBtn) {
                closeReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            if (closeBanBtn) {
                closeBanBtn.addEventListener('click', () => {
                    document.getElementById('banModal').classList.remove('active');
                    state.banTargetUser = null;
                });
            }
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // –ö–Ω–æ–ø–∫–∏ –∂–∞–ª–æ–±
            const submitReportBtn = document.getElementById('submitReportBtn');
            const cancelReportBtn = document.getElementById('cancelReportBtn');
            
            if (submitReportBtn) {
                submitReportBtn.addEventListener('click', submitReport);
            }
            
            if (cancelReportBtn) {
                cancelReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.remove('active');
                    state.reportTargetMessage = null;
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            const submitBanBtn = document.getElementById('submitBanBtn');
            const cancelBanBtn = document.getElementById('cancelBanBtn');
            
            if (submitBanBtn) {
                submitBanBtn.addEventListener('click', submitBan);
            }
            
            if (cancelBanBtn) {
                cancelBanBtn.addEventListener('click', () => {
                    document.getElementById('banModal').classList.remove('active');
                    state.banTargetUser = null;
                });
            }
            
            // –í–∫–ª–∞–¥–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
            const adminTabApplications = document.getElementById('adminTabApplications');
            const adminTabApproved = document.getElementById('adminTabApproved');
            const adminTabBanned = document.getElementById('adminTabBanned');
            const adminTabReports = document.getElementById('adminTabReports');
            const adminTabAdmins = document.getElementById('adminTabAdmins');
            
            if (adminTabApplications) {
                adminTabApplications.addEventListener('click', () => {
                    state.currentAdminTab = 'applications';
                    updateAdminTabs();
                    loadApplications();
                });
            }
            
            if (adminTabApproved) {
                adminTabApproved.addEventListener('click', () => {
                    state.currentAdminTab = 'approved';
                    updateAdminTabs();
                    loadApprovedUsers();
                });
            }
            
            if (adminTabBanned) {
                adminTabBanned.addEventListener('click', () => {
                    state.currentAdminTab = 'banned';
                    updateAdminTabs();
                    loadBannedUsers();
                });
            }
            
            if (adminTabReports) {
                adminTabReports.addEventListener('click', () => {
                    state.currentAdminTab = 'reports';
                    updateAdminTabs();
                    loadReports();
                });
            }
            
            if (adminTabAdmins) {
                adminTabAdmins.addEventListener('click', () => {
                    state.currentAdminTab = 'admins';
                    updateAdminTabs();
                    loadAdmins();
                });
            }
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤
            const addAdminBtn = document.getElementById('addAdminBtn');
            const addAdminEmail = document.getElementById('addAdminEmail');
            
            if (addAdminBtn) {
                addAdminBtn.addEventListener('click', addAdmin);
            }
            
            if (addAdminEmail) {
                addAdminEmail.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') addAdmin();
                });
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const newTheme = state.theme === 'light' ? 'dark' : 'light';
                    state.theme = newTheme;
                    document.body.classList.toggle('dark-theme');
                    document.body.classList.toggle('light-theme');
                    localStorage.setItem('neznakomka-theme', newTheme);
                    
                    const icon = themeToggle.querySelector('i');
                    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                });
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
            const savedTheme = localStorage.getItem('neznakomka-theme') || 'light';
            state.theme = savedTheme;
            document.body.classList.add(savedTheme + '-theme');
            const icon = document.getElementById('themeToggle')?.querySelector('i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (state.isTouchDevice) {
                document.body.classList.add('touch-device');
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // –ö–Ω–æ–ø–∫–∏ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è
            const confirmHandshakeBtn = document.getElementById('confirmHandshakeBtn');
            const cancelHandshakeBtn = document.getElementById('cancelHandshakeBtn');
            
            if (confirmHandshakeBtn) {
                confirmHandshakeBtn.addEventListener('click', confirmHandshake);
            }
            
            if (cancelHandshakeBtn) {
                cancelHandshakeBtn.addEventListener('click', () => {
                    document.getElementById('confirmHandshakeModal').classList.remove('active');
                    state.pendingHandshakeTarget = null;
                });
            }
            
            // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
            const customAlertConfirm = document.getElementById('customAlertConfirm');
            if (customAlertConfirm) {
                customAlertConfirm.addEventListener('click', () => {
                    document.getElementById('customAlertOverlay').classList.remove('active');
                    document.getElementById('customAlert').classList.remove('active');
                });
            }
            
            console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
        });

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        window.approveApplication = approveApplication;
        window.rejectApplication = rejectApplication;
        window.banUser = banUser;
        window.unbanUser = unbanUser;
        window.resolveReport = resolveReport;
        window.deleteMessageFromReport = deleteMessageFromReport;
        window.removeAdmin = removeAdmin;

    </script>
</body>
</html>